<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Èõ¢Á∑öÁ•®Âà∏ÁÆ°ÂÆ∂ Fresh (Wallet UI)</title>

    <!-- 1. ÂºïÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. ÂºïÂÖ• Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. ÂºïÂÖ•Êú¨Âú∞Áπ™Ë£ΩÊ¢ùÁ¢ºËàáQR CodeÁöÑÂáΩÂºèÂ∫´ -->
    <script src="https://cdn.jsdelivr.net/npm/bwip-js@3.0.4/dist/bwip-js-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <!-- 4. ÂºïÂÖ• IndexedDB ËºïÈáèÂ∞ÅË£ù (Ëß£Ê±∫ LocalStorage 5MB ‰∏äÈôê) -->
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/iife/index-min.js"></script>

    <!-- 5. Ë®≠ÂÆö Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>

    <!-- Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', // Sky Blue
                        },
                        accent: {
                            50: '#fdf4ff', 500: '#d946ef', // Fuchsia
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'bounce-sm': 'bounceSmall 0.2s infinite alternate',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        bounceSmall: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(-2px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modern Ticket Rip Effect - Smoother */
        .ticket-rip-l {
            position: absolute; left: -6px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 12px; border-radius: 50%;
            background-color: transparent; 
            box-shadow: inset -1px 0 2px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .ticket-rip-r {
            position: absolute; right: -6px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 12px; border-radius: 50%;
            background-color: transparent;
            box-shadow: inset 1px 0 2px rgba(0,0,0,0.05);
            z-index: 10;
        }
        /* Fullscreen Image Overlay Transition */
        .fullscreen-overlay {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="text-slate-700">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            Trash2, Calendar, Check, Plus, LogIn, ExternalLink, Tag, RotateCcw,
            CheckCircle2, ListTodo, Clock, StickyNote, Save, X, ScanBarcode,
            Pencil, ClipboardPaste, ArrowRightLeft, Copy, CheckSquare, Trash,
            RefreshCcw, Search, FolderPlus, AlertCircle, MoreVertical, Copy as CopyIcon, Link as LinkIcon,
            Image as ImageIcon, Upload, Clipboard, ClipboardList, AlertTriangle, Download, FileJson, Database, FolderInput,
            LayoutDashboard, Moon, Sun, ChevronUp, ChevronDown, Filter, AlertOctagon, CheckSquareIcon,
            Bell, BellRing, Send, UserCheck, CloudCog, Maximize2, Wand2, WifiOff, FileUp, Replace, FilePlus2, RefreshCw,
            ImagePlus, Heart, HeartHandshake, Eye, EyeOff, Globe, BookOpen, Star, History, MousePointerClick, Layers,
            CalendarX2, CopyPlus, Lightbulb, Loader2, QrCode, SlidersHorizontal, ArrowUpDown, Image, CheckCheck, SendHorizontal, XCircle, Droplets,
            MoveVertical, BoxSelect, Monitor, Palette, Rows, LayoutGrid, ChevronRight, ChevronDown as ChevronDownIcon, GripHorizontal
        } from 'lucide-react';

        // --- 0. Storage Layer (IndexedDB + LocalStorage) ---
        const DB_IMG_PREFIX = 'img_';
        
        // Helper to load all tasks (hydrating images from IDB)
        const loadTasksFromStorage = async () => {
            try {
                const raw = localStorage.getItem('wallet_tasks_v3');
                if (!raw) return [];
                const tasks = JSON.parse(raw);
                
                // Hydrate images from IDB
                const hydrated = await Promise.all(tasks.map(async t => {
                    // Check if image is stored in IDB (marked by flag or implicit check)
                    // We check if IDB has key img_{id}
                    try {
                        const imgData = await idbKeyval.get(DB_IMG_PREFIX + t.id);
                        if (imgData) {
                            return { ...t, image: imgData };
                        }
                    } catch(e) { console.error("IDB Read Error", e); }
                    return t; 
                }));
                return hydrated;
            } catch (e) {
                console.error("Storage Load Error", e);
                return [];
            }
        };

        // Helper to save tasks (offloading images to IDB)
        const saveTasksToStorage = async (tasks) => {
            try {
                const tasksToSave = [];
                const imagesToSave = [];
                const activeIds = new Set(tasks.map(t => t.id));

                for (const t of tasks) {
                    const taskCopy = { ...t };
                    
                    // Logic: If image is Base64 (starts with data:), move to IDB
                    if (taskCopy.image && taskCopy.image.startsWith('data:')) {
                        imagesToSave.push({ key: DB_IMG_PREFIX + t.id, val: taskCopy.image });
                        taskCopy.image = ''; // Clear from LS object to save space
                    }
                    
                    // Note: 'images' array handling omitted for Minimal Diff as primary logic uses 'image'.
                    // If 'images' array support is needed later, similar logic applies.
                    
                    tasksToSave.push(taskCopy);
                }

                // 1. Save metadata to LS
                localStorage.setItem('wallet_tasks_v3', JSON.stringify(tasksToSave));

                // 2. Save images to IDB
                if (imagesToSave.length > 0) {
                    await Promise.all(imagesToSave.map(item => idbKeyval.set(item.key, item.val)));
                }

                // 3. Cleanup: We don't delete immediately here to avoid race conditions, 
                // but ideally we should clean up keys not in activeIds.
            } catch (e) {
                console.error("Storage Save Error", e);
            }
        };

        // Migration: Run once to move LS images to IDB
        const migrateToIndexedDB = async () => {
            const raw = localStorage.getItem('wallet_tasks_v3');
            if (!raw) return;
            const tasks = JSON.parse(raw);
            let needsMigration = false;
            
            for (const t of tasks) {
                if (t.image && t.image.startsWith('data:')) {
                    needsMigration = true;
                    await idbKeyval.set(DB_IMG_PREFIX + t.id, t.image);
                    t.image = ''; // Clear
                }
            }
            
            if (needsMigration) {
                console.log("Migrating images to IDB...");
                localStorage.setItem('wallet_tasks_v3', JSON.stringify(tasks));
            }
        };

        // --- 1. Core Logic (Helpers) ---

        const parseBatchTicketInfo = (text, overrideName) => {
            const results = [];
            const lines = text.split(/\r?\n/);
            lines.forEach((rawLine, index) => {
                const line = rawLine.trim();
                if (!line) return;
                let dateStr = "";
                const dateMatch = line.match(/\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/);
                if (dateMatch) dateStr = dateMatch[0].replace(/[\.\-]/g, '/');
                const lineWithoutDate = line.replace(/\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/, '');
                
                let serialStr = "";
                const serialMatch = lineWithoutDate.match(/(?:Âà∏Ëôü|Âà∏ËôüÔºö|Â∫èËôü|CODE|Code|ÂØÜÁ¢º|PIN)[:Ôºö\s]*([A-Za-z0-9\-\s]{8,})/i);
                if (serialMatch && serialMatch[1]) {
                    serialStr = serialMatch[1].trim().replace(/\s/g, '');
                } else {
                    const potentialCodes = lineWithoutDate.match(/[A-Za-z0-9]{9,30}/g);
                    if (potentialCodes) {
                         const validCodes = potentialCodes.filter(code => !/^20\d{6}$/.test(code) && !/^\d{9,15}$/.test(code));
                         if (validCodes.length > 0) serialStr = validCodes[0];
                    }
                }

                if (serialStr) {
                    let finalName = overrideName || "RegexËß£ÊûêÁ•®Âà∏";
                    if (!overrideName) {
                         if (index > 0 && lines[index-1].trim().length > 2) finalName = lines[index-1].trim();
                         else finalName = "Êú™ÂëΩÂêçÁ•®Âà∏";
                    }
                    results.push({
                        id: 'task_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2,5),
                        text: rawLine, originalRaw: rawLine,
                        isTicket: true, serial: serialStr, productName: finalName, expiry: dateStr,
                        tags: [], images: [], image: '', completed: false, isDeleted: false, createdAt: Date.now(), note: '',
                    });
                }
            });
            return results;
        };

        const compressImage = (fileOrUrl) => {
            return new Promise((resolve, reject) => {
                const img = new window.Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    const MAX = 800;
                    if (width > height) { if (width > MAX) { height *= MAX / width; width = MAX; } }
                    else { if (height > MAX) { width *= MAX / height; height = MAX; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/webp', 0.8));
                };
                img.onerror = reject;
                if (typeof fileOrUrl === 'string') img.src = fileOrUrl;
                else { const r = new FileReader(); r.onload = e => img.src = e.target.result; r.readAsDataURL(fileOrUrl); }
            });
        };

        const checkIsExpiringSoon = (expiryStr, thresholdDays = 7) => {
            if (!expiryStr) return false;
            const normalizedDate = expiryStr.replace(/[\.\-]/g, '/');
            const expiryDate = new Date(normalizedDate);
            if (isNaN(expiryDate.getTime())) return false;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const diffTime = expiryDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= thresholdDays && diffDays >= -1; 
        };

        const formatTime = (timestamp) => {
            if(!timestamp) return '';
            const d = new Date(timestamp);
            if(isNaN(d.getTime())) return '';
            return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
        };

        const formatDateTime = (timestamp) => {
            if(!timestamp) return '';
            const d = new Date(timestamp);
            if(isNaN(d.getTime())) return '';
            const datePart = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
            const timePart = `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            return `${datePart} ${timePart}`;
        };

        const hexToRgb = (hex) => {
            var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 255, b: 255 };
        };

        const sendTelegramMessage = async (token, chatId, text) => {
            if (!token || !chatId) return { success: false, error: 'Missing token or chat_id' };
            try {
                const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(text)}&parse_mode=Markdown`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.ok) {
                    console.log("TG Notification sent successfully");
                    return { success: true };
                } else {
                    console.error("TG API Error:", data);
                    return { success: false, error: data.description };
                }
            } catch (error) {
                console.error("TG Network Error:", error);
                return { success: false, error: error.message };
            }
        };

        // --- 2. UI Components ---

        const QRCodeCanvas = ({ text, size = 180 }) => {
            const canvasRef = useRef(null);
            useEffect(() => { if (canvasRef.current && window.QRious) new window.QRious({ element: canvasRef.current, value: text, size: size, level: 'H' }); }, [text, size]);
            return <canvas ref={canvasRef} className="rounded-2xl shadow-sm border border-slate-100" />;
        };

        const BarcodeCanvas = ({ text }) => {
            const canvasRef = useRef(null);
            useEffect(() => { if (canvasRef.current && window.bwipjs) try { window.bwipjs.toCanvas(canvasRef.current, { bcid: 'code128', text: text, scale: 3, height: 10, includetext: true, textxalign: 'center' }); } catch (e) {} }, [text]);
            return <canvas ref={canvasRef} className="max-w-full h-auto rounded-lg shadow-sm border border-slate-100 bg-white p-1" />;
        };

        const TagSelectInput = ({ allTags, selectedTags, onTagsChange }) => {
            const [inputVal, setInputVal] = useState('');
            const handleAdd = (tag) => {
                if(!selectedTags.includes(tag)) onTagsChange([...selectedTags, tag]);
                setInputVal('');
            };
            const handleRemove = (tag, e) => {
                e.preventDefault(); 
                e.stopPropagation();
                onTagsChange(selectedTags.filter(t => t !== tag));
            };
            return (
                <div className="space-y-2">
                    <div className="flex flex-wrap gap-2">
                        {selectedTags.map(tag => (
                            <span key={tag} className="bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                {tag} <button type="button" onClick={(e) => handleRemove(tag, e)} className="hover:text-sky-900 p-0.5 rounded-full hover:bg-sky-200"><X size={12}/></button>
                            </span>
                        ))}
                    </div>
                    <div className="flex gap-2 relative">
                        <input value={inputVal} onChange={e => setInputVal(e.target.value)} placeholder="Êñ∞Â¢ûÊ®ôÁ±§..." className="flex-1 p-3 bg-slate-50 rounded-xl text-sm border-none focus:ring-2 focus:ring-sky-400 outline-none" onKeyDown={e => { if(e.key === 'Enter' && inputVal.trim()) handleAdd(inputVal.trim()); }} />
                        <button onClick={() => inputVal.trim() && handleAdd(inputVal.trim())} className="bg-sky-500 text-white p-3 rounded-xl hover:bg-sky-600 transition-colors"><Plus size={18}/></button>
                        {inputVal && (
                            <div className="absolute top-full mt-2 w-full bg-white border border-slate-100 rounded-xl shadow-xl z-20 max-h-32 overflow-y-auto">
                                {allTags.filter(t => t.includes(inputVal) && !selectedTags.includes(t)).map(t => (
                                    <button key={t} onClick={() => handleAdd(t)} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-50 font-medium text-slate-600">{t}</button>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const defaultViewConfig = {
            backgroundImage: '', 
            cardOpacity: 0.95, 
            bgPosY: 50, 
            bgSize: 'cover',
            cardBgColor: '#ffffff',
            compactHeight: 70,
            compactShowImage: false
        };

        // --- Header Component (Redesigned) ---
        const Header = ({ 
            appTitle, onTitleChange, onOpenMenu, onOpenSettings, 
            sortType, setSortType, setSearchQuery, searchQuery, 
            isSelectionMode, setIsSelectionMode, selectedCount, onSelectAll, 
            isCompact, setIsCompact,
            activeTag, setActiveTag, allTags,
            activeView, setActiveView,
            onHeaderHeightChange,
            onQuickBgToggle
        }) => {
            const headerRef = useRef(null);

            // Report height on change
            useEffect(() => {
                if (!headerRef.current) return;
                const observer = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        onHeaderHeightChange(entry.contentRect.height);
                    }
                });
                observer.observe(headerRef.current);
                return () => observer.disconnect();
            }, [onHeaderHeightChange]);

            return (
                <div ref={headerRef} className="fixed top-0 left-0 right-0 z-50 bg-white border-b border-slate-100 shadow-sm transition-all flex flex-col items-center">
                    <div className="w-full max-w-md px-4 pt-safe pb-2">
                        {/* 1. Top Bar */}
                        <div className="flex justify-between items-center py-3">
                            <div className="flex items-center gap-2 group cursor-pointer" onClick={() => {
                                const newTitle = prompt("‰øÆÊîπÊ®ôÈ°åÂêçÁ®±:", appTitle);
                                if(newTitle) onTitleChange(newTitle);
                            }}>
                                <h1 className="text-xl font-black tracking-tight text-slate-800">{appTitle}</h1>
                                <Pencil size={14} className="text-slate-300 group-hover:text-sky-500 transition-colors"/>
                            </div>
                            <div className="flex gap-2 items-center">
                                {isSelectionMode && (
                                    <button onClick={onSelectAll} className="px-2.5 py-1.5 rounded-lg text-xs font-bold bg-emerald-100 text-emerald-600 hover:bg-emerald-200">
                                        {selectedCount > 0 ? 'ÂèñÊ∂à' : 'ÂÖ®ÈÅ∏'}
                                    </button>
                                )}
                                <button 
                                    onClick={() => setIsSelectionMode(!isSelectionMode)} 
                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${isSelectionMode ? 'bg-sky-500 text-white' : 'bg-slate-100 text-slate-600'}`}
                                >
                                    {isSelectionMode ? `Â∑≤ÈÅ∏ ${selectedCount}` : 'ÈÅ∏Âèñ'}
                                </button>
                                
                                {/* Quick BG Toggle Button */}
                                <button onClick={onQuickBgToggle} className="w-9 h-9 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-500 hover:bg-sky-50 hover:text-sky-600 transition-colors" title="Âø´ÈÄüÊèõËÉåÊôØ">
                                    <Image size={16} />
                                </button>

                                <button onClick={onOpenSettings} className="w-9 h-9 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-500 hover:bg-sky-50 hover:text-sky-600 transition-colors">
                                    <CloudCog size={16} />
                                </button>
                                <button onClick={onOpenMenu} className="w-9 h-9 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-100 transition-colors">
                                    <MoreVertical size={16} />
                                </button>
                            </div>
                        </div>

                        {/* 2. Tools Bar */}
                        <div className="flex gap-2 items-center mb-3">
                            {/* Search */}
                            <div className="relative flex-1 group">
                                <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-sky-500 transition-colors" />
                                <input 
                                    value={searchQuery}
                                    onChange={e => setSearchQuery(e.target.value)}
                                    placeholder="ÊêúÂ∞ã..." 
                                    className="w-full pl-9 pr-3 py-2 text-sm bg-slate-100 border-none rounded-xl focus:ring-2 focus:ring-sky-200 outline-none font-bold text-slate-700 transition-all placeholder:text-slate-400" 
                                />
                            </div>

                            {/* Tag Select Dropdown */}
                            <div className="relative max-w-[100px]">
                                <select 
                                    value={activeTag} 
                                    onChange={(e) => setActiveTag(e.target.value)}
                                    className="w-full appearance-none pl-2 pr-7 py-2 bg-slate-100 rounded-xl text-xs font-bold text-slate-600 outline-none border-none focus:ring-2 focus:ring-sky-200"
                                >
                                    <option value="all">ÊâÄÊúâÊ®ôÁ±§</option>
                                    {allTags.map(tag => <option key={tag} value={tag}>#{tag}</option>)}
                                </select>
                                <Filter size={12} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"/>
                            </div>

                            {/* Sort */}
                            <button 
                                onClick={() => {
                                    const types = ['expiring', 'newest', 'oldest'];
                                    const nextIdx = (types.indexOf(sortType) + 1) % types.length;
                                    setSortType(types[nextIdx]);
                                }}
                                className="w-9 h-9 flex items-center justify-center bg-slate-100 rounded-xl text-slate-500 hover:bg-slate-200 hover:text-sky-600 transition-colors"
                                title="ÂàáÊèõÊéíÂ∫è"
                            >
                                <ArrowUpDown size={16} />
                            </button>

                            {/* View Toggle */}
                            <button 
                                onClick={() => setIsCompact(!isCompact)}
                                className={`w-9 h-9 flex items-center justify-center rounded-xl transition-all ${isCompact ? 'bg-sky-500 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                            >
                                {isCompact ? <Rows size={16}/> : <LayoutGrid size={16}/>}
                            </button>
                        </div>

                        {/* 3. Navigation (Segmented Control) */}
                        <div className="bg-slate-100 p-1 rounded-xl flex gap-1">
                            {[
                                {id: 'active', label: 'ÂæÖ‰ΩøÁî®', icon: ListTodo},
                                {id: 'completed', label: 'Â∑≤‰ΩøÁî®', icon: CheckCircle2},
                                {id: 'deleted', label: 'ÂõûÊî∂Ê°∂', icon: Trash}
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveView(tab.id)}
                                    className={`flex-1 flex items-center justify-center gap-1.5 py-2 rounded-lg text-xs font-bold transition-all ${activeView === tab.id ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                >
                                    <tab.icon size={14} className={activeView === tab.id ? 'text-sky-500' : ''}/>
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Modals (Keep mostly same but adapt style slightly if needed) ---
        const SettingsModal = ({ isOpen, onClose, settings, bgHistory, onSave, onRemoveHistory }) => {
            if(!isOpen) return null;
            
            const [localSettings, setLocalSettings] = useState(JSON.parse(JSON.stringify(settings)));
            const [currentTab, setCurrentTab] = useState('active');
            const [testStatus, setTestStatus] = useState(null);
            const fileInputRef = useRef(null);

            const currentViewConfig = localSettings.viewConfigs?.[currentTab] || { ...defaultViewConfig };

            const handleGlobalChange = (key, value) => {
                setLocalSettings(prev => ({ ...prev, [key]: value }));
            };

            const handleViewConfigChange = (key, value) => {
                setLocalSettings(prev => ({
                    ...prev,
                    viewConfigs: {
                        ...prev.viewConfigs,
                        [currentTab]: {
                            ...prev.viewConfigs[currentTab],
                            [key]: value
                        }
                    }
                }));
            };

            const handleSave = () => {
                onSave(localSettings);
                onClose();
            };

            const handleBgUpload = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    const base64 = await compressImage(file);
                    handleViewConfigChange('backgroundImage', base64);
                }
            }

            const handleTest = async () => {
                setTestStatus('sending');
                const result = await sendTelegramMessage(localSettings.tgToken, localSettings.tgChatId, "üîî ÈÄôÊòØ‰∏ÄÂâá‰æÜËá™„ÄåÈõ¢Á∑öÁ•®Âà∏ÁÆ°ÂÆ∂„ÄçÁöÑÊ∏¨Ë©¶Ë®äÊÅØ„ÄÇ");
                if (result.success) {
                    setTestStatus('success');
                    setTimeout(() => setTestStatus(null), 3000);
                } else {
                    setTestStatus('error');
                    alert(`ÁôºÈÄÅÂ§±Êïó: ${result.error}\n\nÂèØËÉΩÂéüÂõ†ÔºöToken/ChatIDÈåØË™§ÔºåÊàñÁÄèË¶ΩÂô®CORSÈòªÊìã„ÄÇ`);
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900/40 z-[100] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl scale-100 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <h2 className="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800"><CloudCog size={24} className="text-sky-500"/> Á≥ªÁµ±Ë®≠ÂÆö</h2>
                        <div className="space-y-5">
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">ÈÄöÁü•Â§©Êï∏ (Á¥ÖÊ°ÜÈ°ØÁ§∫)</label>
                                <input type="number" value={localSettings.notifyDays} onChange={e => handleGlobalChange('notifyDays', e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-sky-400"/>
                            </div>
                            <div className="border-t border-slate-100 pt-4">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block">Â§ñËßÄË®≠ÂÆö</label>
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-4">
                                    {[{id: 'active', label: 'ÂæÖ‰ΩøÁî®'}, {id: 'completed', label: 'Â∑≤‰ΩøÁî®'}, {id: 'deleted', label: 'ÂõûÊî∂Ê°∂'}].map(tab => (
                                        <button key={tab.id} onClick={() => setCurrentTab(tab.id)} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${currentTab === tab.id ? 'bg-white shadow text-sky-600' : 'text-slate-400'}`}>{tab.label}</button>
                                    ))}
                                </div>
                                <div className="space-y-4 animate-fade-in">
                                    <div>
                                        <div className="text-xs font-bold text-slate-500 mb-2 flex justify-between"><span>ÊõæÁ∂ì‰ΩøÁî®ÁöÑËÉåÊôØ</span>{bgHistory.length === 0 && <span className="text-slate-300 font-normal">Â∞öÁÑ°Á¥ÄÈåÑ</span>}</div>
                                        <div className="grid grid-cols-4 gap-2 mb-2">
                                            {bgHistory.map((bgUrl, idx) => (
                                                <div key={idx} className="relative group">
                                                    <button onClick={() => handleViewConfigChange('backgroundImage', bgUrl)} className="w-full h-12 rounded-lg bg-cover bg-center border border-slate-200 hover:scale-105 transition-transform shadow-sm" style={{ backgroundImage: `url(${bgUrl})` }}></button>
                                                    <button onClick={(e) => { e.stopPropagation(); onRemoveHistory(bgUrl); }} className="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><X size={10}/></button>
                                                </div>
                                            ))}
                                            <button onClick={() => handleViewConfigChange('backgroundImage', '')} className="w-full h-12 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-400 text-xs font-bold">ÁÑ°</button>
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        <div className="flex gap-2">
                                            <button onClick={() => fileInputRef.current?.click()} className="flex-1 py-2 bg-sky-100 text-sky-600 rounded-xl text-xs font-bold hover:bg-sky-200 flex items-center justify-center gap-1"><ImagePlus size={14}/> ‰∏äÂÇ≥ÂúñÁâá</button>
                                            <input type="file" ref={fileInputRef} accept="image/*" onChange={handleBgUpload} className="hidden" />
                                        </div>
                                    </div>
                                    {currentViewConfig.backgroundImage && (
                                        <div className="bg-slate-50 p-3 rounded-xl space-y-3">
                                            <div>
                                                <div className="flex justify-between items-center mb-1"><label className="text-xs font-bold text-slate-500">ÂûÇÁõ¥‰ΩçÁΩÆ</label><span className="text-xs font-bold text-sky-600">{currentViewConfig.bgPosY}%</span></div>
                                                <input type="range" min="0" max="100" step="1" value={currentViewConfig.bgPosY} onChange={(e) => handleViewConfigChange('bgPosY', parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"/>
                                            </div>
                                            <div>
                                                <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-slate-500">Á∏ÆÊîæÊ®°Âºè</label></div>
                                                <div className="flex gap-2">
                                                    {[{val:'cover',label:'Â°´Êªø'},{val:'contain',label:'ÂÆåÊï¥'},{val:'auto',label:'ÂéüÂúñ'}].map(opt=><button key={opt.val} onClick={()=>handleViewConfigChange('bgSize',opt.val)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold border ${currentViewConfig.bgSize===opt.val?'bg-sky-100 text-sky-600 border-sky-200':'bg-white text-slate-500 border-slate-200'}`}>{opt.label}</button>)}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    <div className="bg-slate-50 p-3 rounded-xl space-y-3">
                                        <div className="flex justify-between items-center"><label className="text-xs font-bold text-slate-500">Âç°ÁâáÂ∫ïËâ≤</label><input type="color" value={currentViewConfig.cardBgColor} onChange={e => handleViewConfigChange('cardBgColor', e.target.value)} className="w-6 h-6 rounded overflow-hidden border-none cursor-pointer"/></div>
                                        <div>
                                            <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-slate-500">Âç°ÁâáÈÄèÊòéÂ∫¶</label><span className="text-xs font-bold text-sky-600">{Math.round((1 - currentViewConfig.cardOpacity) * 100)}%</span></div>
                                            <input type="range" min="0" max="100" step="5" value={Math.round((1 - currentViewConfig.cardOpacity) * 100)} onChange={(e) => handleViewConfigChange('cardOpacity', 1 - (parseInt(e.target.value) / 100))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"/>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 p-3 rounded-xl space-y-3">
                                        <div className="flex justify-between items-center"><label className="text-xs font-bold text-slate-500">ÂàóË°®È´òÂ∫¶</label><span className="text-xs font-bold text-sky-600">{currentViewConfig.compactHeight || 70}px</span></div>
                                        <input type="range" min="40" max="150" step="5" value={currentViewConfig.compactHeight || 70} onChange={(e) => handleViewConfigChange('compactHeight', parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"/>
                                        <div className="flex justify-between items-center mt-2">
                                            <label className="text-xs font-bold text-slate-500">ÂàóË°®È°ØÁ§∫ÂúñÁâá</label>
                                            <button onClick={() => handleViewConfigChange('compactShowImage', !currentViewConfig.compactShowImage)} className={`w-10 h-5 rounded-full relative transition-colors ${currentViewConfig.compactShowImage ? 'bg-sky-500' : 'bg-slate-300'}`}><div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${currentViewConfig.compactShowImage ? 'left-6' : 'left-1'}`}></div></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="border-t border-slate-100 pt-4">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Telegram Bot Token</label>
                                <input type="text" value={localSettings.tgToken} onChange={e => handleGlobalChange('tgToken', e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl text-sm font-mono text-slate-600 outline-none focus:ring-2 focus:ring-sky-400"/>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Telegram Chat ID</label>
                                <input type="text" value={localSettings.tgChatId} onChange={e => handleGlobalChange('tgChatId', e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl text-sm font-mono text-slate-600 outline-none focus:ring-2 focus:ring-sky-400"/>
                            </div>
                            <button onClick={handleTest} disabled={!localSettings.tgToken || !localSettings.tgChatId || testStatus === 'sending'} className={`w-full py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-2 transition-all ${testStatus === 'success' ? 'bg-emerald-100 text-emerald-600' : testStatus === 'error' ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                {testStatus === 'sending' ? 'ÂÇ≥ÈÄÅ‰∏≠...' : testStatus === 'success' ? 'Ê∏¨Ë©¶ÊàêÂäü' : 'Ê∏¨Ë©¶ÂÇ≥ÈÄÅ'}
                            </button>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">ÂèñÊ∂à</button>
                            <button onClick={handleSave} className="px-6 py-2.5 bg-sky-500 hover:bg-sky-600 text-white rounded-xl font-bold shadow-lg shadow-sky-200 transition-all active:scale-95">ÂÑ≤Â≠ò</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TicketCard = ({ ticket, onClick, notifyDays, isSelectionMode, isSelected, onSelect, isDuplicate, opacity = 0.95, cardBgColor = '#ffffff', isCompact, compactHeight = 70, compactShowImage = false }) => {
            const isExpiring = !ticket.completed && ticket.expiry && checkIsExpiringSoon(ticket.expiry, notifyDays);
            const duplicateStyle = isDuplicate && !ticket.completed && !ticket.isDeleted ? 'border-red-500 ring-2 ring-red-100 shadow-red-200' : '';
            const { r, g, b } = hexToRgb(cardBgColor);
            let bgBase = `rgba(${r}, ${g}, ${b}, ${opacity})`;
            let overlayClass = '';
            if (isSelected) overlayClass = 'bg-sky-500/10 ring-2 ring-sky-500 border-sky-500';
            else if (isExpiring && !ticket.completed && !ticket.isDeleted) overlayClass = 'bg-red-500/10 border-red-400 shadow-red-100';
            else overlayClass = 'border-slate-100 hover:border-sky-200 hover:shadow-md';

            if (isCompact) {
                return (
                    <div onClick={() => { if(isSelectionMode) onSelect(ticket.id); else onClick(ticket); }} style={{ backgroundColor: bgBase, height: `${compactHeight}px` }} className={`backdrop-blur-sm mx-2 mb-1 px-2 rounded-lg shadow-sm border flex items-center gap-2 active:scale-[0.98] transition-all cursor-pointer relative overflow-hidden group ${overlayClass} ${duplicateStyle}`}>
                        {isSelectionMode && <div className={`w-4 h-4 flex-shrink-0 rounded-full border-2 flex items-center justify-center transition-all ${isSelected ? 'bg-sky-500 border-sky-500' : 'border-slate-300 bg-white'}`}>{isSelected && <Check size={10} className="text-white"/>}</div>}
                        {compactShowImage && (<div className="h-full aspect-square py-1 mr-1 flex-shrink-0">{ticket.image ? <img src={ticket.image} className={`w-full h-full object-cover rounded-md ${ticket.completed ? 'grayscale opacity-50' : ''}`} /> : <div className="w-full h-full bg-slate-100 rounded-md flex items-center justify-center border border-slate-200"><i className="fas fa-ticket-alt text-slate-300 text-xs"></i></div>}</div>)}
                        <div className="flex-1 min-w-0 flex flex-col justify-center">
                            <div className="flex items-center gap-2">
                                {isDuplicate && !ticket.completed && !ticket.isDeleted && <span className="text-[9px] bg-red-500 text-white px-1.5 py-0.5 rounded font-bold">ÈáçË§á</span>}
                                <h3 className={`font-bold text-slate-800 line-clamp-1 text-sm ${ticket.completed ? 'line-through text-slate-400' : ''}`}>{ticket.productName}</h3>
                            </div>
                            <div className="flex items-center gap-2 mt-0.5">
                                {isExpiring && !ticket.completed && !ticket.isDeleted && <span className="text-[9px] font-bold text-red-500 flex items-center gap-0.5"><AlertCircle size={9}/> Âø´Âà∞Êúü</span>}
                                <span className={`text-[10px] font-bold ${ticket.completed ? 'text-emerald-600' : 'text-slate-400'}`}>{ticket.completed ? `Â∑≤Áî® ${formatTime(ticket.completedAt)}` : (ticket.expiry || 'ÁÑ°ÊúüÈôê')}</span>
                            </div>
                        </div>
                        {!isSelectionMode && <button className={`flex-shrink-0 text-[10px] font-bold px-2 py-0.5 rounded-lg transition-all ${ticket.completed ? 'bg-slate-100 text-slate-500' : 'bg-emerald-100 text-emerald-600 hover:bg-emerald-500 hover:text-white'}`}>{ticket.completed ? 'Êü•Áúã' : 'ÂÖåÊèõ'}</button>}
                    </div>
                );
            }

            return (
                <div onClick={() => { if(isSelectionMode) onSelect(ticket.id); else onClick(ticket); }} style={{ backgroundColor: bgBase }} className={`backdrop-blur-sm mx-4 mt-4 p-4 rounded-3xl shadow-sm border flex gap-4 active:scale-[0.98] transition-all cursor-pointer relative overflow-hidden group ${overlayClass} ${duplicateStyle}`}>
                    {isSelectionMode && <div className={`absolute top-3 right-3 z-20 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${isSelected ? 'bg-sky-500 border-sky-500' : 'border-slate-300 bg-white'}`}>{isSelected && <Check size={14} className="text-white"/>}</div>}
                    {isDuplicate && !ticket.completed && !ticket.isDeleted && <div className="absolute top-0 left-0 bg-red-500 text-white text-[9px] px-2 py-0.5 rounded-br-lg z-20 font-bold">ÈáçË§áÂ∫èËôü</div>}
                    <div className="w-20 h-20 flex-shrink-0 rounded-2xl flex items-center justify-center overflow-hidden relative group-hover:scale-105 transition-transform">{ticket.image ? <img src={ticket.image} className={`w-full h-full object-cover ${ticket.completed ? 'grayscale opacity-50' : ''}`} /> : <i className="fas fa-ticket-alt text-slate-300 text-2xl"></i>}</div>
                    <div className="flex-1 flex flex-col justify-between py-1 min-w-0">
                        <div>
                            <div className="flex justify-between items-start pr-6"><h3 className={`font-bold text-slate-800 line-clamp-1 text-[15px] ${ticket.completed ? 'line-through text-slate-400' : ''}`}>{ticket.productName}</h3>{ticket.completed && <span className="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold">Â∑≤‰ΩøÁî®</span>}</div>
                            {isExpiring && !ticket.completed && !ticket.isDeleted && <div className="text-[10px] font-bold text-red-500 mt-1 flex items-center gap-1 animate-pulse"><AlertCircle size={10}/> Âø´Âà∞Êúü</div>}
                            <div className="flex gap-1.5 mt-2 overflow-x-auto no-scrollbar">{ticket.tags && ticket.tags.map(t => <span key={t} className="text-[10px] bg-sky-50 text-sky-600 px-2 py-0.5 rounded-md font-bold whitespace-nowrap">{t}</span>)}{!ticket.tags?.length && <span className="text-[10px] text-slate-300 font-bold">#</span>}</div>
                        </div>
                        <div className="flex justify-between items-end mt-2">
                            {ticket.completed && ticket.completedAt ? <div className="text-[10px] font-bold text-emerald-600 flex items-center gap-1 bg-emerald-50 px-2 py-0.5 rounded-lg"><CheckCircle2 size={10}/> <span>Ê†∏Èä∑Êñº {formatDateTime(ticket.completedAt)}</span></div> : <div className={`text-xs font-bold flex items-center gap-1.5 ${isExpiring ? 'text-red-500' : 'text-slate-400'}`}><Clock size={12}/> <span>{ticket.expiry || 'ÁÑ°ÊúüÈôê'}</span></div>}
                            {!isSelectionMode && <button className={`text-sm font-bold px-5 py-2.5 rounded-2xl shadow-sm transition-all active:scale-95 ${ticket.completed ? 'bg-slate-100 text-slate-500' : 'bg-emerald-100 text-emerald-600 hover:bg-emerald-500 hover:text-white shadow-emerald-100'}`}>{ticket.completed ? 'Êü•Áúã' : 'ÂÖåÊèõ'}</button>}
                        </div>
                    </div>
                    <div className="ticket-rip-l" style={{backgroundColor: 'transparent'}}></div>
                </div>
            );
        };

        const RedeemModal = ({ ticket, onClose, onToggleComplete, onDelete, onRestore, onUpdate, allTags }) => {
            if (!ticket) return null;
            const [isEditing, setIsEditing] = useState(false);
            const [editName, setEditName] = useState(ticket.productName);
            const [editExpiry, setEditExpiry] = useState(ticket.expiry);
            const [editTags, setEditTags] = useState(ticket.tags || []);
            const [editImage, setEditImage] = useState(ticket.image || '');
            const [showOriginalImage, setShowOriginalImage] = useState(false);
            const [showFullScreen, setShowFullScreen] = useState(false);

            const handleSave = () => {
                onUpdate({
                    ...ticket,
                    productName: editName,
                    expiry: editExpiry.replace(/-/g, '/'),
                    tags: editTags, 
                    image: editImage
                });
                setIsEditing(false);
            };

            const handleImageChange = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    const base64 = await compressImage(file);
                    setEditImage(base64);
                }
            };
            const displayImage = showOriginalImage || (!!ticket.image && !ticket.serial);

            return (
                <>
                <div className="fixed inset-0 bg-slate-900/60 z-[60] flex items-center justify-center p-4 animate-fade-in backdrop-blur-md" onClick={onClose}>
                    <div className="bg-white w-full max-w-md rounded-[32px] p-6 relative shadow-2xl overflow-y-auto max-h-[90vh] border border-white/20" onClick={e => e.stopPropagation()}>
                        <div className="text-center mt-2">
                            {isEditing ? <input className="text-xl font-black text-center w-full border-b border-sky-200 pb-2 mb-2 text-slate-800 outline-none" value={editName} onChange={e=>setEditName(e.target.value)} /> : <h3 className="text-lg font-black text-slate-800 break-words leading-tight">{ticket.productName}</h3>}
                            {isEditing && <div className="mt-4 text-left space-y-4 bg-slate-50 p-4 rounded-2xl"><div><label className="text-xs font-bold text-slate-400 uppercase">Êõ¥ÊèõÂ∞ÅÈù¢</label><div className="flex items-center gap-3 mt-2">{editImage ? <img src={editImage} className="w-16 h-16 object-cover rounded-xl border border-slate-200"/> : <div className="w-16 h-16 bg-white border border-dashed border-slate-300 rounded-xl flex items-center justify-center"><ImageIcon size={20} className="text-slate-300"/></div>}<div className="flex flex-col gap-2"><label className="px-3 py-1.5 bg-sky-100 text-sky-600 text-xs font-bold rounded-lg cursor-pointer hover:bg-sky-200 text-center">‰∏äÂÇ≥ <input type="file" accept="image/*" onChange={handleImageChange} className="hidden"/></label>{editImage && <button onClick={()=>setEditImage('')} className="text-red-500 text-xs font-bold hover:underline">ÁßªÈô§ÂúñÁâá</button>}</div></div></div><div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Ê®ôÁ±§</label><TagSelectInput allTags={allTags} selectedTags={editTags} onTagsChange={setEditTags} /></div><div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">ÊúüÈôê</label><input type="date" value={editExpiry ? editExpiry.replace(/\//g, '-') : ''} onChange={e=>setEditExpiry(e.target.value)} className="w-full border border-slate-200 rounded-xl p-2.5 text-sm bg-white" /></div></div>}
                        </div>
                        {!isEditing && <div className="my-4 flex flex-col items-center gap-4">{ticket.serial && ticket.image && <div className="flex bg-slate-200 p-1 rounded-xl mb-1"><button onClick={()=>setShowOriginalImage(false)} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${!showOriginalImage ? 'bg-white shadow-sm text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>Ê¢ùÁ¢º</button><button onClick={()=>setShowOriginalImage(true)} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${showOriginalImage ? 'bg-white shadow-sm text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>ÂéüÂúñ</button></div>}{displayImage && ticket.image ? <div className="w-full flex flex-col items-center gap-4"><div className="relative group w-full cursor-zoom-in" onClick={() => setShowFullScreen(true)}><img src={ticket.image} className="w-full h-auto rounded-xl shadow-sm border border-white" /><div className="absolute bottom-3 right-3 bg-slate-900/60 text-white p-1.5 rounded-lg pointer-events-none"><Maximize2 size={14}/></div></div>{ticket.serial && <div className="w-full flex flex-col gap-3 animate-fade-in"><div className="w-full bg-white p-3 rounded-xl border border-slate-100 shadow-sm"><BarcodeCanvas text={ticket.serial} /></div><div className="w-full bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex justify-center"><QRCodeCanvas text={ticket.serial} size={150} /></div></div>}</div> : <>{ticket.serial && <div className="bg-white p-2 rounded-xl border border-slate-100"><BarcodeCanvas text={ticket.serial} /></div>}<div className="p-3 bg-white rounded-2xl shadow-sm border border-slate-100">{ticket.serial ? <QRCodeCanvas text={ticket.serial} /> : <div className="w-40 h-40 flex items-center justify-center text-slate-300 font-bold border-2 border-dashed border-slate-100 rounded-xl">ÁÑ°Ê¢ùÁ¢º</div>}</div></>}</div>}
                        <div className="flex flex-col gap-3 mt-4">{isEditing ? <div className="flex gap-2"><button onClick={()=>setIsEditing(false)} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">ÂèñÊ∂à</button><button onClick={handleSave} className="flex-1 py-3 bg-sky-500 text-white rounded-xl font-bold shadow-lg shadow-sky-200 hover:bg-sky-600">ÂÑ≤Â≠òËÆäÊõ¥</button></div> : <>{!ticket.isDeleted && <button onClick={() => { if(ticket.completed || window.confirm("Á¢∫ÂÆöË¶ÅÁ´ãÂç≥Ê†∏Èä∑ÂóéÔºü")) { onToggleComplete(ticket); onClose(); } }} className={`w-full py-5 text-lg font-bold rounded-2xl shadow-lg flex items-center justify-center gap-2 text-white transition-transform active:scale-95 ${ticket.completed ? 'bg-emerald-500' : 'bg-emerald-500'}`}>{ticket.completed ? <><RotateCcw size={24}/> Ê®ôË®òÁÇ∫Êú™Áî®</> : <><CheckCircle2 size={24}/> Á´ãÂç≥Ê†∏Èä∑</>}</button>}<div className="flex gap-3 mt-2">{ticket.isDeleted ? <button onClick={() => { onRestore(ticket); onClose(); }} className="flex-1 py-3 bg-emerald-50 text-emerald-600 font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-emerald-100"><RefreshCcw size={18}/> ÈÇÑÂéü</button> : <button onClick={() => setIsEditing(true)} className="flex-1 py-3 bg-slate-50 text-slate-600 font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-slate-100 border border-slate-100"><Pencil size={18}/> Á∑®ËºØ</button>}<button onClick={() => { onDelete(ticket.id); onClose(); }} className="flex-1 py-3 bg-red-50 text-red-500 font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-red-100 border border-red-50"><Trash2 size={18}/> {ticket.isDeleted ? 'Ê∞∏‰πÖÂà™Èô§' : 'Âà™Èô§'}</button><button onClick={onClose} className="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-slate-200 border border-slate-200"><X size={18}/> ÈóúÈñâ</button></div></>}</div>
                    </div>
                </div>
                {showFullScreen && ticket.image && <div className="fixed inset-0 z-[70] bg-black flex items-center justify-center p-2 fullscreen-overlay" onClick={() => setShowFullScreen(false)}><img src={ticket.image} className="max-w-full max-h-full object-contain" /><button className="absolute top-4 right-4 w-10 h-10 bg-white/20 text-white rounded-full flex items-center justify-center backdrop-blur-md hover:bg-white/30 transition-colors"><X size={24}/></button></div>}
                </>
            );
        };

        const AddTicketModal = ({ isOpen, onClose, onAddBatch, allTags }) => {
            if (!isOpen) return null;
            const [activeTab, setActiveTab] = useState('smart');
            const [pasteVal, setPasteVal] = useState('');
            const [loading, setLoading] = useState(false);
            const [manualData, setManualData] = useState({ name: '', serial: '', expiry: '', note: '' });
            const [manualTags, setManualTags] = useState([]);
            const [images, setImages] = useState([]);

            const handleSmartSubmit = async () => {
                if (!pasteVal.trim()) return;
                setLoading(true);
                try {
                    const results = parseBatchTicketInfo(pasteVal);
                    if (results.length === 0) alert("Êú™ËÉΩËß£ÊûêÂá∫Á•®Âà∏ÔºåË´ãÁ¢∫Ë™çÊ†ºÂºèÊàñËΩâÁÇ∫ÊâãÂãïËº∏ÂÖ•„ÄÇ");
                    else { onAddBatch(results); onClose(); }
                } catch (e) { alert("ËôïÁêÜÂ§±Êïó"); } finally { setLoading(false); }
            };

            const handleManualSubmit = () => {
                if (!manualData.name) { alert("Ë´ãËº∏ÂÖ•ÂêçÁ®±"); return; }
                const newTicket = {
                    id: Date.now(), productName: manualData.name, serial: manualData.serial,
                    expiry: manualData.expiry.replace(/-/g, '/'), note: manualData.note,
                    image: images[0] || '', tags: manualTags, completed: false, isDeleted: false, createdAt: Date.now()
                };
                onAddBatch([newTicket]); onClose();
            };
            const handleImageUpload = async (e) => { const file = e.target.files[0]; if(file) { const base64 = await compressImage(file); setImages([base64]); } };

            return (
                <div className="fixed inset-0 bg-slate-900/60 z-[60] flex items-end sm:items-center justify-center animate-fade-in backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full sm:w-[450px] sm:rounded-3xl rounded-t-[32px] p-6 shadow-2xl transform transition-transform duration-300 max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-black text-slate-800">Êñ∞Â¢ûÁ•®Âà∏</h2><button onClick={onClose} className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200"><X size={18}/></button></div>
                        <div className="flex bg-slate-100 p-1.5 rounded-2xl mb-6"><button onClick={()=>setActiveTab('smart')} className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all ${activeTab==='smart' ? 'bg-white shadow text-sky-600' : 'text-slate-400 hover:text-slate-600'}`}><Wand2 size={14} className="inline mr-1"/> Êô∫ÊÖßË≤º‰∏ä</button><button onClick={()=>setActiveTab('manual')} className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all ${activeTab==='manual' ? 'bg-white shadow text-sky-600' : 'text-slate-400 hover:text-slate-600'}`}><Pencil size={14} className="inline mr-1"/> ÊâãÂãïËº∏ÂÖ•</button></div>
                        {activeTab === 'smart' ? <div className="space-y-4"><textarea className="w-full h-40 p-4 bg-slate-50 rounded-2xl border border-transparent focus:bg-white focus:border-sky-300 outline-none resize-none text-sm font-medium text-slate-700 placeholder:text-slate-400" placeholder="Ë≤º‰∏äÁ∞°Ë®ä/Email..." value={pasteVal} onChange={e=>setPasteVal(e.target.value)}></textarea><button onClick={handleSmartSubmit} disabled={loading} className="w-full bg-sky-500 hover:bg-sky-600 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-sky-200 flex items-center justify-center gap-2 transition-transform active:scale-95">{loading ? <Loader2 className="animate-spin"/> : <Wand2 size={18}/>} Á´ãÂç≥Ëß£Êûê</button></div> : <div className="space-y-3"><div className="flex items-center gap-3"><div className="w-20 h-20 bg-slate-50 border border-dashed border-slate-300 rounded-2xl flex items-center justify-center relative overflow-hidden group">{images.length > 0 ? <img src={images[0]} className="w-full h-full object-cover"/> : <ImageIcon className="text-slate-300 group-hover:text-sky-400 transition-colors"/>}<input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={handleImageUpload}/></div><div className="flex-1 text-xs font-bold text-slate-400">ÈªûÊìäÂúñÁ§∫‰∏äÂÇ≥Á•®Âà∏ÁÖßÁâá (ÈÅ∏Â°´)</div></div><input className="w-full p-3.5 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none" placeholder="Á•®Âà∏ÂêçÁ®± (ÂøÖÂ°´)" value={manualData.name} onChange={e=>setManualData({...manualData, name: e.target.value})}/><TagSelectInput allTags={allTags} selectedTags={manualTags} onTagsChange={setManualTags} /><input className="w-full p-3.5 bg-slate-50 rounded-xl font-mono text-sm text-slate-700 outline-none" placeholder="Â∫èËôü/‰ª£Á¢º (ÈÅ∏Â°´)" value={manualData.serial} onChange={e=>setManualData({...manualData, serial: e.target.value})}/><input type="date" className="w-full p-3.5 bg-slate-50 rounded-xl text-slate-500 font-bold outline-none" value={manualData.expiry} onChange={e=>setManualData({...manualData, expiry: e.target.value})}/><button onClick={handleManualSubmit} className="w-full bg-sky-500 hover:bg-sky-600 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-sky-200 transition-transform active:scale-95">Á¢∫Ë™çÊñ∞Â¢û</button></div>}
                    </div>
                </div>
            );
        };
        
        const BatchEditModal = ({ isOpen, onClose, selectedCount, onAddTag, allTags }) => {
             const [tagsToAdd, setTagsToAdd] = useState([]);
             if(!isOpen) return null;
             const handleConfirm = () => { onAddTag(tagsToAdd); onClose(); };
             return (
                <div className="fixed inset-0 bg-slate-900/60 z-[60] flex items-end sm:items-center justify-center animate-fade-in" onClick={onClose}>
                     <div className="bg-white w-full sm:w-[400px] sm:rounded-3xl rounded-t-[32px] p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                        <h2 className="text-xl font-black mb-1 text-slate-800">ÊâπÈáèÁ∑®ËºØ</h2>
                        <p className="text-xs font-bold text-slate-400 mb-4">Â∑≤ÈÅ∏Âèñ {selectedCount} ÂºµÁ•®Âà∏</p>
                        <div className="space-y-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Êñ∞Â¢ûÊ®ôÁ±§</label><TagSelectInput allTags={allTags} selectedTags={tagsToAdd} onTagsChange={setTagsToAdd} /></div></div>
                        <div className="flex gap-3 mt-6"><button onClick={onClose} className="flex-1 py-3 bg-slate-100 font-bold rounded-2xl text-slate-500">ÂèñÊ∂à</button><button onClick={handleConfirm} className="flex-1 py-3 bg-sky-500 font-bold rounded-2xl text-white shadow-lg shadow-sky-200 hover:bg-sky-600 transition-colors">Á¢∫Ë™çÂÑ≤Â≠ò</button></div>
                     </div>
                </div>
             );
        };

        // --- Main App ---
        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [isLoaded, setIsLoaded] = useState(false); // Data loading flag

            // View State
            const [view, setView] = useState('active'); // active, completed, deleted
            const [activeTag, setActiveTag] = useState('all');
            const [sortType, setSortType] = useState('expiring');
            const [searchQuery, setSearchQuery] = useState('');
            const [isCompact, setIsCompact] = useState(false);

            // Modals
            const [showAddModal, setShowAddModal] = useState(false);
            const [selectedTicket, setSelectedTicket] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [showBatchModal, setShowBatchModal] = useState(false);
            
            // Selection
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());

            // Header layout state
            const [headerHeight, setHeaderHeight] = useState(150); // initial estimate

            // Settings State
            const [settings, setSettings] = useState(() => {
                const saved = JSON.parse(localStorage.getItem('wallet_settings_v3'));
                const defaults = { 
                    tgToken: '', tgChatId: '', notifyDays: 7, appTitle: 'ÊàëÁöÑÁ•®Â§æ',
                    viewConfigs: {
                        active: { ...defaultViewConfig },
                        completed: { ...defaultViewConfig },
                        deleted: { ...defaultViewConfig }
                    }
                };
                if (!saved) return defaults;
                // Basic migration for flat structure if needed
                if (saved.backgroundImage !== undefined) {
                    return {
                        ...defaults, ...saved,
                        viewConfigs: {
                            active: { 
                                backgroundImage: saved.backgroundImage || '', cardOpacity: saved.cardOpacity ?? 0.95,
                                bgPosY: saved.bgPosY || 50, bgSize: saved.bgSize || 'cover', cardBgColor: '#ffffff',
                                compactHeight: 70, compactShowImage: false
                            },
                            completed: { ...defaultViewConfig }, deleted: { ...defaultViewConfig }
                        }
                    };
                }
                return {
                    ...defaults, ...saved,
                    viewConfigs: {
                        active: { ...defaultViewConfig, ...saved.viewConfigs?.active },
                        completed: { ...defaultViewConfig, ...saved.viewConfigs?.completed },
                        deleted: { ...defaultViewConfig, ...saved.viewConfigs?.deleted },
                    }
                };
            });

            // BG History State
            const [bgHistory, setBgHistory] = useState(() => JSON.parse(localStorage.getItem('wallet_bg_history_v3')) || []);

            // 1. Initial Load & Migration
            useEffect(() => {
                const init = async () => {
                    await migrateToIndexedDB(); // Run migration once
                    const loadedTasks = await loadTasksFromStorage(); // Load metadata + images
                    setTasks(loadedTasks);
                    setIsLoaded(true);
                };
                init();
            }, []);

            // 2. Persist State Changes
            // IMPORTANT: Using a separate effect for saving tasks to handle async nature
            useEffect(() => {
                if (isLoaded) {
                    saveTasksToStorage(tasks);
                }
            }, [tasks, isLoaded]);

            useEffect(() => localStorage.setItem('wallet_settings_v3', JSON.stringify(settings)), [settings]);
            useEffect(() => localStorage.setItem('wallet_bg_history_v3', JSON.stringify(bgHistory)), [bgHistory]);

            // Notification Check logic remains same...
            useEffect(() => {
                const checkNotifications = async () => {
                    if (settings.tgToken && settings.tgChatId && tasks.length > 0) {
                        const todayStr = new Date().toISOString().split('T')[0];
                        const lastCheckKey = 'last_notify_date_v3';
                        if (localStorage.getItem(lastCheckKey) !== todayStr) {
                            const expiring = tasks.filter(t => !t.completed && !t.isDeleted && checkIsExpiringSoon(t.expiry, settings.notifyDays));
                            if (expiring.length > 0) {
                                let msg = `‚ö†Ô∏è *[${settings.appTitle}] Âà∞ÊúüÊèêÈÜí (${expiring.length}Á≠Ü)*\nË®≠ÂÆö: ${settings.notifyDays} Â§©ÂÖß\n\n`;
                                expiring.slice(0, 10).forEach(t => { msg += `üî∏ ${t.productName} (${t.expiry})\n`; });
                                const result = await sendTelegramMessage(settings.tgToken, settings.tgChatId, msg);
                                if(result.success) localStorage.setItem(lastCheckKey, todayStr);
                            }
                        }
                    }
                };
                if(isLoaded) checkNotifications();
            }, [tasks, settings, isLoaded]);

            const allTags = useMemo(() => [...new Set(tasks.flatMap(t => t.tags || []))], [tasks]);

            const duplicateSerials = useMemo(() => {
                const counts = {};
                tasks.forEach(t => { if (!t.isDeleted && t.serial) counts[t.serial] = (counts[t.serial] || 0) + 1; });
                return new Set(Object.keys(counts).filter(s => counts[s] > 1));
            }, [tasks]);

            const filteredTasks = useMemo(() => {
                let result = tasks.filter(t => {
                    if (view === 'active' && (t.completed || t.isDeleted)) return false;
                    if (view === 'completed' && (!t.completed || t.isDeleted)) return false;
                    if (view === 'deleted' && !t.isDeleted) return false;
                    if (activeTag !== 'all' && (!t.tags || !t.tags.includes(activeTag))) return false;
                    if (searchQuery) {
                        const q = searchQuery.toLowerCase();
                        return t.productName.toLowerCase().includes(q) || (t.note && t.note.toLowerCase().includes(q)) || (t.tags && t.tags.some(tag => tag.toLowerCase().includes(q)));
                    }
                    return true;
                });
                result.sort((a, b) => {
                    if (sortType === 'expiring') {
                        const dateA = a.expiry ? new Date(a.expiry.replace(/\//g, '-')) : new Date(9999, 11, 31);
                        const dateB = b.expiry ? new Date(b.expiry.replace(/\//g, '-')) : new Date(9999, 11, 31);
                        return dateA - dateB;
                    } else if (sortType === 'newest') return b.createdAt - a.createdAt;
                    else return a.createdAt - b.createdAt;
                });
                return result;
            }, [tasks, view, activeTag, searchQuery, sortType, duplicateSerials]);

            // Handlers
            const handleAddBatch = (newItems) => setTasks(prev => [...newItems, ...prev]);
            const handleUpdate = (updatedTicket) => setTasks(prev => prev.map(t => t.id === updatedTicket.id ? updatedTicket : t));
            const handleToggleComplete = (ticket) => {
                const newStatus = !ticket.completed;
                const completedAt = newStatus ? Date.now() : null; 
                setTasks(prev => prev.map(t => t.id === ticket.id ? { ...t, completed: newStatus, completedAt: completedAt } : t));
                // TG Notification logic here (simplified)
            };
            const handleDelete = (id) => {
                if(view === 'deleted') { if(confirm("Á¢∫ÂÆöÊ∞∏‰πÖÂà™Èô§Ôºü")) setTasks(prev => prev.filter(t => t.id !== id)); }
                else setTasks(prev => prev.map(t => t.id === id ? { ...t, isDeleted: true } : t));
            };
            const handleRestore = (ticket) => setTasks(prev => prev.map(t => t.id === ticket.id ? { ...t, isDeleted: false } : t));
            const handleSelect = (id) => { const newSet = new Set(selectedIds); if(newSet.has(id)) newSet.delete(id); else newSet.add(id); setSelectedIds(newSet); };
            const handleSelectAll = () => { setSelectedIds(selectedIds.size === filteredTasks.length ? new Set() : new Set(filteredTasks.map(t => t.id))); }
            const handleBatchAddTag = (tagsToAdd) => {
                setTasks(prev => prev.map(t => selectedIds.has(t.id) ? { ...t, tags: Array.from(new Set([...(t.tags || []), ...tagsToAdd])) } : t));
                setSelectedIds(new Set()); setIsSelectionMode(false);
            };

            const handleSaveSettings = (newSettings) => {
                setSettings(newSettings);
                const imagesToAdd = [newSettings.viewConfigs.active.backgroundImage, newSettings.viewConfigs.completed.backgroundImage, newSettings.viewConfigs.deleted.backgroundImage].filter(Boolean);
                if (imagesToAdd.length > 0) {
                    setBgHistory(prev => { const combined = [...imagesToAdd, ...prev]; return [...new Set(combined)].slice(0, 20); });
                }
            };

            const handleRemoveHistory = (url) => { if(confirm("Á¢∫ÂÆöÁßªÈô§Á¥ÄÈåÑÔºü")) setBgHistory(prev => prev.filter(item => item !== url)); };

            // Quick BG Toggle Logic
            const handleQuickBgToggle = () => {
                const currentConfig = settings.viewConfigs[view];
                const currentBg = currentConfig.backgroundImage;
                
                let nextBg = '';
                if (!currentBg) {
                    // Current is empty, go to first history if exists
                    if (bgHistory.length > 0) nextBg = bgHistory[0];
                } else {
                    const idx = bgHistory.indexOf(currentBg);
                    if (idx !== -1 && idx < bgHistory.length - 1) {
                        nextBg = bgHistory[idx + 1];
                    } else {
                        // End of list or not found -> Go to empty
                        nextBg = '';
                    }
                }

                // Update settings immediately
                setSettings(prev => ({
                    ...prev,
                    viewConfigs: {
                        ...prev.viewConfigs,
                        [view]: {
                            ...prev.viewConfigs[view],
                            backgroundImage: nextBg
                        }
                    }
                }));
            };

            // Layout Calculation
            const currentConfig = settings.viewConfigs[view] || defaultViewConfig;
            // The background top position is dynamic based on header height
            const bgStyle = currentConfig.backgroundImage ? {
                position: 'fixed',
                top: `${headerHeight}px`, 
                bottom: 0,
                left: 0, 
                right: 0,
                backgroundImage: `url(${currentConfig.backgroundImage})`,
                backgroundSize: currentConfig.bgSize || 'cover',
                backgroundPosition: `center ${currentConfig.bgPosY || 50}%`,
                backgroundRepeat: 'no-repeat',
                zIndex: -1
            } : {};

            return (
                <>
                    {/* Background Layer (Option B: Starts below header) */}
                    {currentConfig.backgroundImage && <div style={bgStyle} className="transition-all duration-500" />}

                    {/* Main Container */}
                    <div className="max-w-md mx-auto min-h-screen relative shadow-2xl sm:border-x border-slate-200 bg-transparent">
                        
                        <Header 
                            appTitle={settings.appTitle}
                            onTitleChange={(t) => setSettings(s => ({...s, appTitle: t}))}
                            onOpenSettings={() => setShowSettings(true)}
                            onOpenMenu={() => {
                                // Simple Menu Logic
                                const action = prompt("1.ÂÆåÊï¥ÂÇô‰ªΩ 2.ÂåØÂÖ•ÈÇÑÂéü 3.Ê∏ÖÁ©∫Ë≥áÊñô");
                                // Backup logic omitted for brevity in IMPL but should exist
                            }}
                            sortType={sortType} setSortType={setSortType}
                            searchQuery={searchQuery} setSearchQuery={setSearchQuery}
                            isSelectionMode={isSelectionMode} setIsSelectionMode={setIsSelectionMode}
                            selectedCount={selectedIds.size} onSelectAll={handleSelectAll}
                            isCompact={isCompact} setIsCompact={setIsCompact}
                            activeTag={activeTag} setActiveTag={setActiveTag} allTags={allTags}
                            activeView={view} setActiveView={setView}
                            onHeaderHeightChange={setHeaderHeight}
                            onQuickBgToggle={handleQuickBgToggle}
                        />

                        {/* Spacer for Fixed Header */}
                        <div style={{ height: `${headerHeight}px` }}></div>
                        
                        {/* Ticket List Area */}
                        <div className={`pb-32 px-0 transition-colors`}>
                            {!isLoaded ? (
                                <div className="text-center py-20 text-slate-400"><Loader2 className="animate-spin inline mr-2"/> ËºâÂÖ•Ë≥áÊñôÂ∫´‰∏≠...</div>
                            ) : filteredTasks.length > 0 ? (
                                filteredTasks.map(ticket => (
                                    <TicketCard 
                                        key={ticket.id} ticket={ticket} 
                                        onClick={setSelectedTicket} notifyDays={settings.notifyDays}
                                        isSelectionMode={isSelectionMode} isSelected={selectedIds.has(ticket.id)} onSelect={handleSelect}
                                        isDuplicate={duplicateSerials.has(ticket.serial)}
                                        opacity={currentConfig.cardOpacity}
                                        cardBgColor={currentConfig.cardBgColor}
                                        isCompact={isCompact}
                                        compactHeight={currentConfig.compactHeight}
                                        compactShowImage={currentConfig.compactShowImage}
                                    />
                                ))
                            ) : (
                                <div className="text-center py-24 text-slate-300">
                                    <i className="fas fa-ticket-alt text-5xl mb-4 opacity-30"></i>
                                    <p className="font-bold">Êö´ÁÑ°Á•®Âà∏</p>
                                </div>
                            )}
                        </div>

                        {/* FAB / Action Bar */}
                        {isSelectionMode ? (
                            <div className="fixed bottom-8 left-1/2 -translate-x-1/2 flex gap-3 z-40 animate-slide-up">
                                {selectedIds.size > 0 && (
                                    <>
                                        <button onClick={() => setShowBatchModal(true)} className="bg-sky-500 hover:bg-sky-600 text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-sky-200 flex items-center gap-2 active:scale-95"><Tag size={18}/> ÊâπÈáèÊ®ôÁ±§</button>
                                        <button onClick={() => { if(confirm(`Âà™Èô§ ${selectedIds.size} È†ÖÁõÆÔºü`)) { if(view === 'deleted') setTasks(prev => prev.filter(t => !selectedIds.has(t.id))); else setTasks(prev => prev.map(t => selectedIds.has(t.id) ? { ...t, isDeleted: true } : t)); setSelectedIds(new Set()); setIsSelectionMode(false); } }} className="bg-white text-red-500 border border-red-100 px-4 py-3 rounded-2xl font-bold shadow-lg flex items-center gap-2 hover:bg-red-50"><Trash2 size={18}/></button>
                                    </>
                                )}
                                <button onClick={() => {setIsSelectionMode(false); setSelectedIds(new Set());}} className="bg-slate-800 text-white px-4 py-3 rounded-2xl font-bold shadow-lg">ÂèñÊ∂à</button>
                            </div>
                        ) : (
                            <button onClick={() => setShowAddModal(true)} className="fixed bottom-8 right-5 w-16 h-16 bg-sky-500 text-white rounded-[24px] shadow-2xl shadow-sky-300 flex items-center justify-center text-3xl active:scale-90 transition-transform z-40 hover:bg-sky-600 hover:rotate-90 duration-300"><Plus size={32}/></button>
                        )}

                        {/* Modals */}
                        <AddTicketModal isOpen={showAddModal} onClose={() => setShowAddModal(false)} onAddBatch={handleAddBatch} allTags={allTags} />
                        <RedeemModal ticket={selectedTicket} onClose={() => setSelectedTicket(null)} onToggleComplete={handleToggleComplete} onDelete={handleDelete} onRestore={handleRestore} onUpdate={handleUpdate} allTags={allTags} />
                        <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} settings={settings} bgHistory={bgHistory} onSave={handleSaveSettings} onRemoveHistory={handleRemoveHistory} />
                        <BatchEditModal isOpen={showBatchModal} onClose={() => setShowBatchModal(false)} selectedCount={selectedIds.size} onAddTag={handleBatchAddTag} allTags={allTags} />
                    </div>
                </>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
