<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>離線票券管家 Fresh (Wallet UI)</title>

    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 引入本地繪製條碼與QR Code的函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/bwip-js@3.0.4/dist/bwip-js-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <!-- 4. 設定 Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>

    <!-- Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', // Sky Blue
                        },
                        accent: {
                            50: '#fdf4ff', 500: '#d946ef', // Fuchsia
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'bounce-sm': 'bounceSmall 0.2s infinite alternate',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        bounceSmall: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(-2px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fullscreen-overlay { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="text-slate-700">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            Trash2, Calendar, Check, Plus, LogIn, ExternalLink, Tag, RotateCcw,
            CheckCircle2, ListTodo, Clock, StickyNote, Save, X, ScanBarcode,
            Pencil, ClipboardPaste, ArrowRightLeft, Copy, CheckSquare, Trash,
            RefreshCcw, Search, FolderPlus, AlertCircle, MoreVertical, Copy as CopyIcon, Link as LinkIcon,
            Image as ImageIcon, Upload, Clipboard, ClipboardList, AlertTriangle, Download, FileJson, Database, FolderInput,
            LayoutDashboard, Moon, Sun, ChevronUp, ChevronDown, Filter, AlertOctagon, CheckSquareIcon,
            Bell, BellRing, Send, UserCheck, CloudCog, Maximize2, Wand2, WifiOff, FileUp, Replace, FilePlus2, RefreshCw,
            ImagePlus, Heart, HeartHandshake, Eye, EyeOff, Globe, BookOpen, Star, History, MousePointerClick, Layers,
            CalendarX2, CopyPlus, Lightbulb, Loader2, QrCode, SlidersHorizontal, ArrowUpDown, Image, CheckCheck, SendHorizontal, XCircle, Droplets,
            MoveVertical, BoxSelect, Monitor, Palette, Rows, LayoutGrid, ChevronRight, ChevronDown as ChevronDownIcon, Wallpaper
        } from 'lucide-react';

        // --- 0. IndexedDB Utility ---
        const DB_NAME = 'FreshWalletDB';
        const DB_VERSION = 1;
        const STORES = { TASKS: 'tasks', SETTINGS: 'settings', HISTORY: 'history' };

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORES.TASKS)) db.createObjectStore(STORES.TASKS, { keyPath: 'id' });
                    if (!db.objectStoreNames.contains(STORES.SETTINGS)) db.createObjectStore(STORES.SETTINGS);
                    if (!db.objectStoreNames.contains(STORES.HISTORY)) db.createObjectStore(STORES.HISTORY);
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const dbOps = {
            async getAll(storeName) {
                const db = await initDB();
                return new Promise((resolve) => {
                    const transaction = db.transaction(storeName, 'readonly');
                    const request = transaction.objectStore(storeName).getAll();
                    request.onsuccess = () => resolve(request.result);
                });
            },
            async get(storeName, key) {
                const db = await initDB();
                return new Promise((resolve) => {
                    const transaction = db.transaction(storeName, 'readonly');
                    const request = transaction.objectStore(storeName).get(key);
                    request.onsuccess = () => resolve(request.result);
                });
            },
            async put(storeName, val, key) {
                const db = await initDB();
                const transaction = db.transaction(storeName, 'readwrite');
                if (key) transaction.objectStore(storeName).put(val, key);
                else transaction.objectStore(storeName).put(val);
            },
            async delete(storeName, key) {
                const db = await initDB();
                const transaction = db.transaction(storeName, 'readwrite');
                transaction.objectStore(storeName).delete(key);
            }
        };

        // --- 1. Core Logic (Helpers) ---
        const parseBatchTicketInfo = (text, overrideName) => {
            const results = [];
            const lines = text.split(/\r?\n/);
            lines.forEach((rawLine, index) => {
                const line = rawLine.trim();
                if (!line) return;
                let dateStr = "";
                const dateMatch = line.match(/\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/);
                if (dateMatch) dateStr = dateMatch[0].replace(/[\.\-]/g, '/');
                const lineWithoutDate = line.replace(/\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/, '');
                let serialStr = "";
                const serialMatch = lineWithoutDate.match(/(?:券號|券號：|序號|CODE|Code|密碼|PIN)[:：\s]*([A-Za-z0-9\-\s]{8,})/i);
                if (serialMatch && serialMatch[1]) {
                    serialStr = serialMatch[1].trim().replace(/\s/g, '');
                } else {
                    const potentialCodes = lineWithoutDate.match(/[A-Za-z0-9]{9,30}/g);
                    if (potentialCodes) {
                         const validCodes = potentialCodes.filter(code => !/^20\d{6}$/.test(code) && !/^\d{9,15}$/.test(code));
                         if (validCodes.length > 0) serialStr = validCodes[0];
                    }
                }
                if (serialStr) {
                    let finalName = overrideName || "Regex解析票券";
                    if (!overrideName) {
                         if (index > 0 && lines[index-1].trim().length > 2) finalName = lines[index-1].trim();
                         else finalName = "未命名票券";
                    }
                    results.push({
                        id: 'task_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2,5),
                        text: rawLine, originalRaw: rawLine,
                        isTicket: true, serial: serialStr, productName: finalName, expiry: dateStr,
                        tags: [], images: [], image: '', completed: false, isDeleted: false, createdAt: Date.now(), note: '',
                    });
                }
            });
            return results;
        };

        const compressImage = (fileOrUrl) => {
            return new Promise((resolve, reject) => {
                const img = new window.Image();
                img.crossOrigin = "Anonymous";
                let objectUrl = null;
                if (fileOrUrl instanceof File || fileOrUrl instanceof Blob) {
                    objectUrl = URL.createObjectURL(fileOrUrl);
                    img.src = objectUrl;
                } else {
                    img.src = fileOrUrl;
                }
                img.onload = () => {
                    if (objectUrl) URL.revokeObjectURL(objectUrl);
                    try {
                        const canvas = document.createElement('canvas');
                        let width = img.width; 
                        let height = img.height;
                        const MAX = 1024;
                        if (width > height) { if (width > MAX) { height *= MAX / width; width = MAX; } } 
                        else { if (height > MAX) { width *= MAX / height; height = MAX; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/webp', 0.8);
                        resolve(dataUrl);
                    } catch (err) { reject(err); }
                };
                img.onerror = (err) => {
                    if (objectUrl) URL.revokeObjectURL(objectUrl);
                    reject(err);
                };
            });
        };

        const checkIsExpiringSoon = (expiryStr, thresholdDays = 7) => {
            if (!expiryStr) return false;
            const normalizedDate = expiryStr.replace(/[\.\-]/g, '/');
            const expiryDate = new Date(normalizedDate);
            if (isNaN(expiryDate.getTime())) return false;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const diffTime = expiryDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= thresholdDays && diffDays >= -1; 
        };

        const hexToRgb = (hex) => {
            var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 255, b: 255 };
        };

        // --- 2. UI Components ---
        const QRCodeCanvas = ({ text, size = 180 }) => {
            const canvasRef = useRef(null);
            useEffect(() => { if (canvasRef.current && window.QRious) new window.QRious({ element: canvasRef.current, value: text, size: size, level: 'H' }); }, [text, size]);
            return <canvas ref={canvasRef} className="rounded-2xl shadow-sm border border-slate-100" />;
        };

        const BarcodeCanvas = ({ text }) => {
            const canvasRef = useRef(null);
            useEffect(() => { if (canvasRef.current && window.bwipjs) try { window.bwipjs.toCanvas(canvasRef.current, { bcid: 'code128', text: text, scale: 3, height: 10, includetext: true, textxalign: 'center' }); } catch (e) {} }, [text]);
            return <canvas ref={canvasRef} className="max-w-full h-auto rounded-lg shadow-sm border border-slate-100 bg-white p-1" />;
        };

        const TagSelectInput = ({ allTags, selectedTags, onTagsChange }) => {
            const [inputVal, setInputVal] = useState('');
            const handleAdd = (tag) => {
                if(!selectedTags.includes(tag)) onTagsChange([...selectedTags, tag]);
                setInputVal('');
            };
            const handleRemove = (tag, e) => {
                e.preventDefault(); e.stopPropagation();
                onTagsChange(selectedTags.filter(t => t !== tag));
            };
            return (
                <div className="space-y-2">
                    <div className="flex flex-wrap gap-2">
                        {selectedTags.map(tag => (
                            <span key={tag} className="bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                {tag} <button type="button" onClick={(e) => handleRemove(tag, e)} className="hover:text-sky-900 p-0.5 rounded-full hover:bg-sky-200"><X size={12}/></button>
                            </span>
                        ))}
                    </div>
                    <div className="flex gap-2 relative">
                        <input value={inputVal} onChange={e => setInputVal(e.target.value)} placeholder="新增標籤..." className="flex-1 p-3 bg-slate-50 rounded-xl text-sm border-none focus:ring-2 focus:ring-sky-400 outline-none" onKeyDown={e => { if(e.key === 'Enter' && inputVal.trim()) handleAdd(inputVal.trim()); }} />
                        <button onClick={() => inputVal.trim() && handleAdd(inputVal.trim())} className="bg-sky-500 text-white p-3 rounded-xl hover:bg-sky-600 transition-colors"><Plus size={18}/></button>
                        {inputVal && (
                            <div className="absolute top-full mt-2 w-full bg-white border border-slate-100 rounded-xl shadow-xl z-20 max-h-32 overflow-y-auto">
                                {allTags.filter(t => t.includes(inputVal) && !selectedTags.includes(t)).map(t => (
                                    <button key={t} onClick={() => handleAdd(t)} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-50 font-medium text-slate-600">{t}</button>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const defaultViewConfig = {
            backgroundImage: '', cardOpacity: 0.95, bgPosY: 50, bgSize: 'cover',
            cardBgColor: '#ffffff', compactHeight: 70, compactShowImage: false
        };

        const SettingsModal = ({ isOpen, onClose, settings, bgHistory, onSave, onRemoveHistory }) => {
            if(!isOpen) return null;
            const [localSettings, setLocalSettings] = useState(JSON.parse(JSON.stringify(settings)));
            const [currentTab, setCurrentTab] = useState('active');
            const fileInputRef = useRef(null);
            
            const currentViewConfig = localSettings.viewConfigs?.[currentTab] || { ...defaultViewConfig };

            const handleGlobalChange = (key, value) => setLocalSettings(prev => ({ ...prev, [key]: value }));
            const handleViewConfigChange = (key, value) => {
                setLocalSettings(prev => ({
                    ...prev,
                    viewConfigs: {
                        ...prev.viewConfigs,
                        [currentTab]: { ...prev.viewConfigs[currentTab], [key]: value }
                    }
                }));
            };

            return (
                <div className="fixed inset-0 bg-slate-900/40 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl scale-100 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <h2 className="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800"><CloudCog size={24} className="text-sky-500"/> 系統設定</h2>
                        <div className="space-y-5">
                            <div><label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">通知天數</label><input type="number" value={localSettings.notifyDays} onChange={e => handleGlobalChange('notifyDays', e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-sky-400"/></div>
                            <div className="border-t border-slate-100 pt-4">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block">外觀設定</label>
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-4">
                                    {[{id: 'active', label: '待使用', icon: ListTodo},{id: 'completed', label: '已使用', icon: CheckCircle2},{id: 'deleted', label: '回收桶', icon: Trash}].map(tab => (
                                        <button key={tab.id} onClick={() => setCurrentTab(tab.id)} className={`flex-1 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1 transition-all ${currentTab === tab.id ? 'bg-white shadow text-sky-600' : 'text-slate-400 hover:text-slate-600'}`}><tab.icon size={12} /> {tab.label}</button>
                                    ))}
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <div className="text-xs font-bold text-slate-500 mb-2">曾經使用的背景</div>
                                        <div className="grid grid-cols-4 gap-2 mb-2">
                                            {bgHistory.map((bgUrl, idx) => (
                                                <div key={idx} className="relative group">
                                                    <button onClick={() => handleViewConfigChange('backgroundImage', bgUrl)} className="w-full h-12 rounded-lg bg-cover bg-center border border-slate-200 hover:scale-105 transition-transform shadow-sm" style={{ backgroundImage: `url(${bgUrl})` }}>
                                                        {currentViewConfig.backgroundImage === bgUrl && <div className="absolute inset-0 bg-black/40 flex items-center justify-center rounded-lg"><Check size={16} className="text-white"/></div>}
                                                    </button>
                                                    <button onClick={(e) => { e.stopPropagation(); onRemoveHistory(bgUrl); }} className="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"><X size={10}/></button>
                                                </div>
                                            ))}
                                            <button onClick={() => handleViewConfigChange('backgroundImage', '')} className="w-full h-12 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-200 text-xs font-bold">無</button>
                                        </div>
                                    </div>
                                    <input type="text" value={currentViewConfig.backgroundImage} onChange={e => handleViewConfigChange('backgroundImage', e.target.value)} placeholder="連結或上傳" className="w-full p-3 bg-slate-50 rounded-xl text-xs text-slate-600 outline-none focus:ring-2 focus:ring-sky-400"/>
                                    <button onClick={() => fileInputRef.current?.click()} className="w-full py-2 bg-sky-100 text-sky-600 rounded-xl text-xs font-bold hover:bg-sky-200 flex items-center justify-center gap-1"><ImagePlus size={14}/> 上傳圖片</button>
                                    <input type="file" ref={fileInputRef} accept="image/*" onChange={async (e) => { const file = e.target.files[0]; if(file) { try { const base64 = await compressImage(file); handleViewConfigChange('backgroundImage', base64); } catch(e) { alert("圖片處理失敗"); } } }} className="hidden" />
                                    
                                    {currentViewConfig.backgroundImage && (
                                        <div className="bg-slate-50 p-3 rounded-xl space-y-3 animate-fade-in">
                                            <div>
                                                <div className="flex justify-between items-center mb-1"><label className="text-xs font-bold text-slate-500 flex items-center gap-1"><MoveVertical size={12}/> 垂直位置</label><span className="text-xs font-bold text-sky-600">{currentViewConfig.bgPosY}%</span></div>
                                                <input type="range" min="0" max="100" step="1" value={currentViewConfig.bgPosY} onChange={(e) => handleViewConfigChange('bgPosY', parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"/>
                                            </div>
                                            <div>
                                                <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-slate-500 flex items-center gap-1"><BoxSelect size={12}/> 縮放模式</label></div>
                                                <div className="flex gap-2">
                                                    {[{ val: 'cover', label: '填滿' }, { val: 'contain', label: '完整' }, { val: 'auto', label: '原圖' }].map(opt => (
                                                        <button key={opt.val} onClick={() => handleViewConfigChange('bgSize', opt.val)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold border transition-colors ${currentViewConfig.bgSize === opt.val ? 'bg-sky-100 text-sky-600 border-sky-200' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-100'}`}>{opt.label}</button>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="w-full h-24 rounded-xl bg-slate-200 border border-slate-300 overflow-hidden relative" style={{ backgroundImage: `url(${currentViewConfig.backgroundImage})`, backgroundPosition: `center ${currentViewConfig.bgPosY}%`, backgroundSize: currentViewConfig.bgSize, backgroundRepeat: 'no-repeat' }}>
                                                <div className="absolute inset-0 flex items-center justify-center font-bold text-white text-[10px] drop-shadow-md bg-black/10">效果預覽</div>
                                            </div>
                                        </div>
                                    )}
                                    <div className="bg-slate-50 p-3 rounded-xl space-y-3">
                                        <div className="flex justify-between items-center"><label className="text-xs font-bold text-slate-500">卡片底色</label><input type="color" value={currentViewConfig.cardBgColor} onChange={e => handleViewConfigChange('cardBgColor', e.target.value)} className="w-6 h-6 rounded overflow-hidden border-none outline-none cursor-pointer"/></div>
                                        <div>
                                            <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-slate-500">透明度</label><span className="text-xs font-bold text-sky-600">{Math.round((1 - currentViewConfig.cardOpacity) * 100)}%</span></div>
                                            <input type="range" min="0" max="100" step="5" value={Math.round((1 - currentViewConfig.cardOpacity) * 100)} onChange={(e) => handleViewConfigChange('cardOpacity', 1 - (parseInt(e.target.value) / 100))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="border-t border-slate-100 pt-4">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Telegram Bot</label>
                                <input type="text" value={localSettings.tgToken} onChange={e => handleGlobalChange('tgToken', e.target.value)} placeholder="Token" className="w-full p-3 bg-slate-50 rounded-xl text-sm font-mono mb-2 outline-none"/><input type="text" value={localSettings.tgChatId} onChange={e => handleGlobalChange('tgChatId', e.target.value)} placeholder="Chat ID" className="w-full p-3 bg-slate-50 rounded-xl text-sm font-mono outline-none"/>
                            </div>
                        </div>
                        <div className="flex justify-end gap-3 mt-6"><button onClick={onClose} className="px-5 py-2.5 text-slate-500 font-bold">取消</button><button onClick={() => { onSave(localSettings); onClose(); }} className="px-6 py-2.5 bg-sky-500 text-white rounded-xl font-bold shadow-lg">儲存</button></div>
                    </div>
                </div>
            );
        };

        const Header = ({ appTitle, onTitleChange, onOpenMenu, onOpenSettings, onQuickSwitchBg, sortType, setSortType, setSearchQuery, searchQuery, isSelectionMode, setIsSelectionMode, selectedCount, onSelectAll, isCompact, setIsCompact, activeTag, setActiveTag, tags, view, setView }) => {
            const [showTagMenu, setShowTagMenu] = useState(false);
            const tagMenuRef = useRef(null);
            useEffect(() => {
                const handleClickOutside = (e) => { if (tagMenuRef.current && !tagMenuRef.current.contains(e.target)) setShowTagMenu(false); };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);
            return (
                <div className="px-5 pt-8 pb-3 flex flex-col gap-3 rounded-b-[32px] bg-slate-50 z-30 border-b border-slate-200 shadow-sm flex-none">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-2 cursor-pointer" onClick={() => { const newTitle = prompt("修改標題:", appTitle); if(newTitle) onTitleChange(newTitle); }}><h1 className="text-2xl font-black text-slate-800">{appTitle}</h1><Pencil size={14} className="text-slate-400"/></div>
                        <div className="flex gap-2">
                            {isSelectionMode && <button onClick={onSelectAll} className="px-3 py-1.5 rounded-full text-xs font-bold bg-emerald-100 text-emerald-600">全選</button>}
                            <button onClick={() => setIsSelectionMode(!isSelectionMode)} className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${isSelectionMode ? 'bg-sky-500 text-white shadow-md' : 'bg-slate-100 text-slate-600'}`}>{isSelectionMode ? `已選 ${selectedCount}` : '選取'}</button>
                            <button onClick={onQuickSwitchBg} className="w-9 h-9 rounded-full flex items-center justify-center bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors shadow-sm"><Wallpaper size={16}/></button>
                            <button onClick={onOpenSettings} className="w-9 h-9 rounded-full flex items-center justify-center bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors shadow-sm"><CloudCog size={18}/></button>
                            <button onClick={onOpenMenu} className="w-9 h-9 rounded-full flex items-center justify-center bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors shadow-sm"><MoreVertical size={18}/></button>
                        </div>
                    </div>
                    <div className="flex gap-2">
                        <div className="relative flex-1"><Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"/><input value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="搜尋..." className="w-full pl-9 pr-2 py-2.5 text-sm rounded-xl bg-white border border-slate-200 outline-none focus:border-sky-300 transition-colors"/></div>
                        <div className="relative" ref={tagMenuRef}>
                            <button onClick={() => setShowTagMenu(!showTagMenu)} className={`h-full px-3 rounded-xl flex items-center gap-1 text-xs font-bold border transition-all ${activeTag !== 'all' ? 'bg-sky-500 text-white border-sky-500 shadow-md shadow-sky-100' : 'bg-white text-slate-600 border-slate-200'}`}><Filter size={14}/><span>{activeTag === 'all' ? '標籤' : activeTag}</span><ChevronDownIcon size={12}/></button>
                            {showTagMenu && (
                                <div className="absolute top-full right-0 mt-2 w-48 bg-white border border-slate-100 rounded-2xl shadow-xl z-50 p-1 max-h-60 overflow-y-auto animate-fade-in">
                                    <button onClick={() => { setActiveTag('all'); setShowTagMenu(false); }} className={`w-full px-4 py-2.5 text-left text-xs font-bold rounded-xl ${activeTag === 'all' ? 'bg-sky-50 text-sky-600' : 'hover:bg-slate-50'}`}>全部顯示</button>
                                    <div className="h-[1px] bg-slate-100 my-1"></div>
                                    {tags.map(tag => <button key={tag} onClick={() => { setActiveTag(tag); setShowTagMenu(false); }} className={`w-full px-4 py-2.5 text-left text-xs font-bold rounded-xl flex justify-between items-center ${activeTag === tag ? 'bg-sky-50 text-sky-600' : 'hover:bg-slate-50'}`}>{tag}{activeTag === tag && <Check size={12}/>}</button>)}
                                </div>
                            )}
                        </div>
                        <button onClick={() => setIsCompact(!isCompact)} className={`w-10 flex items-center justify-center rounded-xl border transition-all ${isCompact ? 'bg-sky-500 text-white shadow-md shadow-sky-100' : 'bg-white text-slate-600 border-slate-200'}`}>{isCompact ? <Rows size={16}/> : <LayoutGrid size={16}/>}</button>
                    </div>
                    <div className="flex p-1 rounded-xl bg-slate-100">
                        {[{id: 'active', label: '待使用', icon: ListTodo},{id: 'completed', label: '已使用', icon: CheckCircle2},{id: 'deleted', label: '回收桶', icon: Trash}].map(tab => (
                            <button key={tab.id} onClick={() => setView(tab.id)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold flex items-center justify-center gap-1.5 transition-all ${view === tab.id ? 'bg-white shadow text-sky-600' : 'text-slate-400'}`}><tab.icon size={13} strokeWidth={view === tab.id ? 2.5 : 2} /> {tab.label}</button>
                        ))}
                    </div>
                </div>
            );
        };

        const TicketCard = ({ ticket, onClick, notifyDays, isSelectionMode, isSelected, onSelect, isDuplicate, opacity = 0.95, cardBgColor = '#ffffff', isCompact, compactHeight = 70, compactShowImage = false }) => {
            const isExpiring = !ticket.completed && ticket.expiry && checkIsExpiringSoon(ticket.expiry, notifyDays);
            const { r, g, b } = hexToRgb(cardBgColor);
            let bgBase = `rgba(${r}, ${g}, ${b}, ${opacity})`;
            let overlayClass = isSelected ? 'ring-2 ring-sky-500 border-sky-500' : (isExpiring && !ticket.completed && !ticket.isDeleted ? 'bg-red-500/10 border-red-400' : 'border-slate-100 hover:border-sky-200 hover:shadow-md');
            if (isCompact) {
                return (
                    <div onClick={() => isSelectionMode ? onSelect(ticket.id) : onClick(ticket)} style={{ backgroundColor: bgBase, height: `${compactHeight}px` }} className={`backdrop-blur-sm mx-2 mb-2 px-3 rounded-xl shadow-sm border flex items-center gap-3 active:scale-[0.98] transition-all cursor-pointer overflow-hidden ${overlayClass}`}>
                        {isSelectionMode && <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all ${isSelected ? 'bg-sky-500 border-sky-500 shadow-md shadow-sky-100' : 'border-slate-300 bg-white'}`}>{isSelected && <Check size={12} className="text-white"/>}</div>}
                        {compactShowImage && <div className="h-full aspect-square py-1.5 flex-shrink-0">{ticket.image ? <img src={ticket.image} className="w-full h-full object-cover rounded-lg"/> : <div className="w-full h-full bg-slate-100 rounded-lg flex items-center justify-center text-slate-300"><i className="fas fa-ticket-alt text-[10px]"></i></div>}</div>}
                        <div className="flex-1 min-w-0 flex flex-col justify-center">
                            <h3 className={`font-bold text-slate-800 line-clamp-1 text-sm ${ticket.completed ? 'line-through text-slate-400' : ''}`}>{ticket.productName}</h3>
                            <div className="flex items-center gap-2 mt-0.5">
                                {isExpiring && !ticket.completed && !ticket.isDeleted && <span className="text-[9px] font-bold text-red-500">快到期</span>}
                                <span className={`text-[10px] font-bold ${ticket.completed ? 'text-emerald-600' : 'text-slate-400'}`}>{ticket.completed ? `已用 ${new Date(ticket.completedAt).toLocaleDateString()}` : (ticket.expiry || '無期限')}</span>
                            </div>
                        </div>
                        {!isSelectionMode && <button className="text-[10px] font-bold px-3 py-1.5 rounded-lg bg-emerald-100 text-emerald-600 hover:bg-emerald-500 hover:text-white transition-all">兌換</button>}
                    </div>
                );
            }
            return (
                <div onClick={() => isSelectionMode ? onSelect(ticket.id) : onClick(ticket)} style={{ backgroundColor: bgBase }} className={`backdrop-blur-sm mx-4 mt-4 p-4 rounded-[24px] shadow-sm border flex gap-4 active:scale-[0.98] transition-all cursor-pointer relative overflow-hidden group ${overlayClass}`}>
                    {isSelectionMode && <div className={`absolute top-3 right-3 z-20 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${isSelected ? 'bg-sky-500 border-sky-500 shadow-md shadow-sky-100' : 'border-slate-300 bg-white'}`}>{isSelected && <Check size={14} className="text-white"/>}</div>}
                    <div className="w-20 h-20 rounded-2xl flex items-center justify-center bg-slate-50/50 overflow-hidden group-hover:scale-105 transition-transform">{ticket.image ? <img src={ticket.image} className="w-full h-full object-cover"/> : <i className="fas fa-ticket-alt text-slate-300 text-2xl"></i>}</div>
                    <div className="flex-1 flex flex-col justify-between py-1 min-w-0">
                        <div>
                            <h3 className={`font-bold text-slate-800 line-clamp-1 text-[15px] ${ticket.completed ? 'line-through text-slate-400' : ''}`}>{ticket.productName}</h3>
                            <div className="flex gap-1.5 mt-2 overflow-x-auto no-scrollbar">{ticket.tags?.map(t => <span key={t} className="text-[10px] bg-sky-50 text-sky-600 px-2 py-0.5 rounded-md font-bold whitespace-nowrap">{t}</span>)}</div>
                        </div>
                        <div className="flex justify-between items-end mt-2">
                            <div className={`text-xs font-bold ${isExpiring ? 'text-red-500' : 'text-slate-400'}`}>{ticket.expiry || '無期限'}</div>
                            {!isSelectionMode && <button className="text-sm font-bold px-4 py-2 rounded-xl bg-emerald-100 text-emerald-600 hover:bg-emerald-500 hover:text-white transition-all shadow-sm">兌換</button>}
                        </div>
                    </div>
                </div>
            );
        };

        const RedeemModal = ({ ticket, onClose, onToggleComplete, onDelete, onRestore, onUpdate, allTags }) => {
            if (!ticket) return null;
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState({...ticket});
            const [showFullScreen, setShowFullScreen] = useState(false);
            const handleSave = () => { onUpdate(editData); setIsEditing(false); };
            const handleImageChange = async (e) => { const file = e.target.files[0]; if(file) { const base64 = await compressImage(file); setEditData({...editData, image: base64}); } };
            return (
                <>
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-md animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-md rounded-[32px] p-6 shadow-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="text-center mb-4">{isEditing ? <input className="text-xl font-black w-full text-center border-b border-sky-300 outline-none pb-1" value={editData.productName} onChange={e=>setEditData({...editData, productName: e.target.value})}/> : <h3 className="text-lg font-black text-slate-800">{ticket.productName}</h3>}</div>
                        {!isEditing && (
                            <div className="my-4 flex flex-col items-center gap-4 animate-fade-in">
                                {ticket.image && <div className="relative group w-full cursor-zoom-in" onClick={() => setShowFullScreen(true)}><img src={ticket.image} className="w-full rounded-xl border border-slate-100 shadow-sm"/><div className="absolute bottom-2 right-2 bg-black/50 text-white p-1 rounded-lg pointer-events-none"><Maximize2 size={14}/></div></div>}
                                {ticket.serial && <BarcodeCanvas text={ticket.serial} />}
                                <QRCodeCanvas text={ticket.serial || ticket.id} />
                            </div>
                        )}
                        {isEditing && (
                            <div className="mt-4 space-y-4 bg-slate-50 p-4 rounded-2xl animate-fade-in">
                                <div><label className="block text-xs font-bold text-slate-400 mb-2 uppercase">票券封面</label><div className="flex items-center gap-3">{editData.image ? <img src={editData.image} className="w-16 h-16 object-cover rounded-xl border border-slate-200"/> : <div className="w-16 h-16 bg-white border border-dashed border-slate-300 rounded-xl flex items-center justify-center"><ImageIcon size={20} className="text-slate-300"/></div>}<label className="px-3 py-1.5 bg-sky-100 text-sky-600 text-xs font-bold rounded-lg cursor-pointer hover:bg-sky-200 transition-colors">更換圖片 <input type="file" onChange={handleImageChange} className="hidden"/></label></div></div>
                                <TagSelectInput allTags={allTags} selectedTags={editData.tags || []} onTagsChange={t => setEditData({...editData, tags: t})} />
                            </div>
                        )}
                        <div className="flex flex-col gap-3 mt-6">
                            {isEditing ? <div className="flex gap-2"><button onClick={()=>setIsEditing(false)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500">取消</button><button onClick={handleSave} className="flex-1 py-3 bg-sky-500 text-white rounded-xl font-bold shadow-lg shadow-sky-200">儲存</button></div> : (
                                <><button onClick={() => { onToggleComplete(ticket); onClose(); }} className="w-full py-4 bg-emerald-500 text-white rounded-2xl font-bold shadow-lg shadow-emerald-100 active:scale-95 transition-transform">{ticket.completed ? '標記未用' : '確認核銷'}</button><div className="flex gap-2"><button onClick={()=>setIsEditing(true)} className="flex-1 py-2 bg-slate-100 rounded-xl font-bold text-slate-500 hover:bg-slate-200 transition-colors">編輯</button><button onClick={()=>onDelete(ticket.id)} className="flex-1 py-2 bg-red-50 text-red-500 rounded-xl font-bold hover:bg-red-100 transition-colors">刪除</button><button onClick={onClose} className="flex-1 py-2 bg-slate-100 rounded-xl font-bold text-slate-500">關閉</button></div></>
                            )}
                        </div>
                    </div>
                </div>
                {showFullScreen && <div className="fixed inset-0 z-[70] bg-black flex items-center justify-center p-2 animate-fade-in" onClick={() => setShowFullScreen(false)}><img src={ticket.image} className="max-w-full max-h-full object-contain"/><button className="absolute top-4 right-4 text-white"><X size={32}/></button></div>}
                </>
            );
        };

        const AddTicketModal = ({ isOpen, onClose, onAddBatch, allTags }) => {
            if (!isOpen) return null;
            const [activeTab, setActiveTab] = useState('smart');
            const [pasteVal, setPasteVal] = useState('');
            const [manualData, setManualData] = useState({ name: '', serial: '', expiry: '' });
            const [manualTags, setManualTags] = useState([]);
            const [image, setImage] = useState('');

            const handleSmartSubmit = () => { const results = parseBatchTicketInfo(pasteVal); if(results.length) { onAddBatch(results); onClose(); } else { alert("解析不到資料"); } };
            const handleManualSubmit = () => { if(manualData.name) { onAddBatch([{ ...manualData, id: 'task_'+Date.now(), image, tags: manualTags, completed: false, isDeleted: false, createdAt: Date.now() }]); onClose(); } };

            return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full sm:w-[450px] sm:rounded-3xl rounded-t-[32px] p-6 shadow-2xl max-h-[90vh] overflow-y-auto animate-slide-up" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-black text-slate-800">新增票券</h2><button onClick={onClose}><X size={20} className="text-slate-400 hover:text-slate-600"/></button></div>
                        <div className="flex bg-slate-100 p-1.5 rounded-2xl mb-6">
                            <button onClick={()=>setActiveTab('smart')} className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all ${activeTab==='smart' ? 'bg-white shadow text-sky-600' : 'text-slate-400'}`}>智慧貼上</button>
                            <button onClick={()=>setActiveTab('manual')} className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all ${activeTab==='manual' ? 'bg-white shadow text-sky-600' : 'text-slate-400'}`}>手動輸入</button>
                        </div>
                        {activeTab === 'smart' ? (
                            <div className="space-y-4 animate-fade-in"><textarea className="w-full h-40 p-4 bg-slate-50 rounded-2xl outline-none border border-transparent focus:border-sky-200 transition-colors resize-none" placeholder="貼上簡訊或 Email 內容..." value={pasteVal} onChange={e=>setPasteVal(e.target.value)}></textarea><button onClick={handleSmartSubmit} className="w-full bg-sky-500 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-sky-100 active:scale-95 transition-transform">立即解析</button></div>
                        ) : (
                            <div className="space-y-3 animate-fade-in">
                                <div className="flex items-center gap-4"><div className="w-20 h-20 bg-slate-50 border border-dashed border-slate-300 rounded-2xl flex items-center justify-center relative overflow-hidden">{image ? <img src={image} className="w-full h-full object-cover"/> : <ImageIcon className="text-slate-300"/>}<input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={async (e)=>{ const file = e.target.files[0]; if(file) setImage(await compressImage(file)); }}/></div><span className="text-xs font-bold text-slate-400">點擊上傳封面照片 (選填)</span></div>
                                <input className="w-full p-3.5 bg-slate-50 rounded-xl outline-none focus:bg-white border border-transparent focus:border-sky-200 transition-all font-bold" placeholder="票券名稱 (必填)" value={manualData.name} onChange={e=>setManualData({...manualData, name: e.target.value})}/>
                                <TagSelectInput allTags={allTags} selectedTags={manualTags} onTagsChange={setManualTags} />
                                <input className="w-full p-3.5 bg-slate-50 rounded-xl outline-none focus:bg-white border border-transparent focus:border-sky-200 transition-all font-mono" placeholder="序號/代碼 (選填)" value={manualData.serial} onChange={e=>setManualData({...manualData, serial: e.target.value})}/>
                                <input type="date" className="w-full p-3.5 bg-slate-50 rounded-xl outline-none focus:bg-white border border-transparent focus:border-sky-200 transition-all font-bold" value={manualData.expiry} onChange={e=>setManualData({...manualData, expiry: e.target.value})}/>
                                <button onClick={handleManualSubmit} className="w-full bg-sky-500 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-sky-100 active:scale-95 transition-transform">確認新增</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const BatchEditModal = ({ isOpen, onClose, selectedCount, onAddTag, allTags }) => {
             const [tags, setTags] = useState([]);
             if(!isOpen) return null;
             return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                     <div className="bg-white w-full max-w-[350px] rounded-3xl p-6 shadow-2xl animate-slide-up" onClick={e=>e.stopPropagation()}>
                        <h2 className="text-xl font-black mb-1 text-slate-800">批量編輯</h2>
                        <p className="text-xs font-bold text-slate-400 mb-4">已選取 {selectedCount} 張票券</p>
                        <TagSelectInput allTags={allTags} selectedTags={tags} onTagsChange={setTags} />
                        <div className="flex gap-3 mt-6"><button onClick={onClose} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500 hover:bg-slate-200">取消</button><button onClick={() => { onAddTag(tags); onClose(); }} className="flex-1 py-3 bg-sky-500 text-white rounded-xl font-bold shadow-lg shadow-sky-100">確認套用</button></div>
                     </div>
                </div>
             );
        };

        // --- 3. Main App ---
        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [view, setView] = useState('active');
            const [activeTag, setActiveTag] = useState('all');
            const [sortType, setSortType] = useState('expiring');
            const [searchQuery, setSearchQuery] = useState('');
            const [showAddModal, setShowAddModal] = useState(false);
            const [selectedTicket, setSelectedTicket] = useState(null);
            const [isCompact, setIsCompact] = useState(false);
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [showBatchModal, setShowBatchModal] = useState(false);
            const [showSettings, setShowSettings] = useState(false);

            const [settings, setSettings] = useState({ 
                tgToken: '', tgChatId: '', notifyDays: 7, appTitle: '我的票夾', 
                viewConfigs: { active: { ...defaultViewConfig }, completed: { ...defaultViewConfig }, deleted: { ...defaultViewConfig } } 
            });
            const [bgHistory, setBgHistory] = useState([]);

            // 1. Initial Load & Migration
            useEffect(() => {
                const loadData = async () => {
                    const localTasks = JSON.parse(localStorage.getItem('wallet_tasks_v3'));
                    const localSettings = JSON.parse(localStorage.getItem('wallet_settings_v3'));
                    const localHistory = JSON.parse(localStorage.getItem('wallet_bg_history_v3'));
                    if (localTasks || localSettings) {
                        if (localTasks) { for (const t of localTasks) await dbOps.put(STORES.TASKS, t); localStorage.removeItem('wallet_tasks_v3'); }
                        if (localSettings) { await dbOps.put(STORES.SETTINGS, localSettings, 'config'); localStorage.removeItem('wallet_settings_v3'); }
                        if (localHistory) { await dbOps.put(STORES.HISTORY, localHistory, 'bg_history'); localStorage.removeItem('wallet_bg_history_v3'); }
                    }
                    const dbTasks = await dbOps.getAll(STORES.TASKS);
                    const dbSettings = await dbOps.get(STORES.SETTINGS, 'config');
                    const dbHistory = await dbOps.get(STORES.HISTORY, 'bg_history');
                    if (dbTasks) setTasks(dbTasks);
                    if (dbSettings) setSettings(dbSettings);
                    if (dbHistory) setBgHistory(dbHistory);
                };
                loadData();
            }, []);

            const allTags = useMemo(() => [...new Set(tasks.flatMap(t => t.tags || []))], [tasks]);
            const filteredTasks = useMemo(() => {
                let result = tasks.filter(t => {
                    if (view === 'active' && (t.completed || t.isDeleted)) return false;
                    if (view === 'completed' && (!t.completed || t.isDeleted)) return false;
                    if (view === 'deleted' && !t.isDeleted) return false;
                    if (activeTag !== 'all' && (!t.tags || !t.tags.includes(activeTag))) return false;
                    if (searchQuery) { const q = searchQuery.toLowerCase(); return t.productName.toLowerCase().includes(q) || t.tags?.some(tag => tag.toLowerCase().includes(q)); }
                    return true;
                });
                result.sort((a, b) => {
                    if (sortType === 'expiring') {
                        const dateA = a.expiry ? new Date(a.expiry.replace(/\//g, '-')) : new Date(9999, 11, 31);
                        const dateB = b.expiry ? new Date(b.expiry.replace(/\//g, '-')) : new Date(9999, 11, 31);
                        return dateA - dateB;
                    } else if (sortType === 'newest') return b.createdAt - a.createdAt;
                    return a.createdAt - b.createdAt;
                });
                return result;
            }, [tasks, view, activeTag, searchQuery, sortType]);

            const handleAddBatch = (newItems) => { setTasks(prev => [...newItems, ...prev]); newItems.forEach(t => dbOps.put(STORES.TASKS, t)); };
            const handleUpdate = (updatedTicket) => { setTasks(prev => prev.map(t => t.id === updatedTicket.id ? updatedTicket : t)); dbOps.put(STORES.TASKS, updatedTicket); };
            const handleToggleComplete = (ticket) => { const updated = { ...ticket, completed: !ticket.completed, completedAt: !ticket.completed ? Date.now() : null }; handleUpdate(updated); };
            const handleDelete = (id) => { if(view === 'deleted') { if(confirm("永久刪除？")) { setTasks(prev => prev.filter(t => t.id !== id)); dbOps.delete(STORES.TASKS, id); } } else { const t = tasks.find(x => x.id === id); if(t) handleUpdate({ ...t, isDeleted: true }); } };
            const handleSaveSettings = (newSettings) => {
                setSettings(newSettings);
                dbOps.put(STORES.SETTINGS, newSettings, 'config');
                const images = [newSettings.viewConfigs.active.backgroundImage, newSettings.viewConfigs.completed.backgroundImage, newSettings.viewConfigs.deleted.backgroundImage].filter(Boolean);
                if (images.length > 0) {
                    const newHistory = [...new Set([...images, ...bgHistory])].slice(0, 20);
                    setBgHistory(newHistory);
                    dbOps.put(STORES.HISTORY, newHistory, 'bg_history');
                }
            };
            const handleQuickSwitchBg = () => {
                const currentBg = settings.viewConfigs[view]?.backgroundImage || '';
                const options = [...bgHistory, ''];
                const nextBg = options[(options.indexOf(currentBg) + 1) % options.length];
                handleSaveSettings({ ...settings, viewConfigs: { ...settings.viewConfigs, [view]: { ...settings.viewConfigs[view], backgroundImage: nextBg } } });
            };
            const currentConfig = settings.viewConfigs[view] || defaultViewConfig;

            return (
                <div className="max-w-md mx-auto h-[100dvh] flex flex-col relative shadow-2xl sm:border-x border-slate-200 bg-white overflow-hidden">
                    <Header appTitle={settings.appTitle} onTitleChange={(t) => handleSaveSettings({...settings, appTitle: t})} onOpenSettings={() => setShowSettings(true)} onOpenMenu={() => { if(confirm("確定清空所有票券？資料不可復原")) { setTasks([]); tasks.forEach(t => dbOps.delete(STORES.TASKS, t.id)); } }} onQuickSwitchBg={handleQuickSwitchBg} sortType={sortType} setSortType={setSortType} searchQuery={searchQuery} setSearchQuery={setSearchQuery} isSelectionMode={isSelectionMode} setIsSelectionMode={setIsSelectionMode} selectedCount={selectedIds.size} onSelectAll={() => setSelectedIds(selectedIds.size === filteredTasks.length ? new Set() : new Set(filteredTasks.map(t => t.id)))} isCompact={isCompact} setIsCompact={setIsCompact} activeTag={activeTag} setActiveTag={setActiveTag} tags={allTags} view={view} setView={setView} />
                    <div className="flex-1 overflow-y-auto relative no-scrollbar bg-slate-50">
                        {currentConfig.backgroundImage && (
                            <div className="absolute inset-0 pointer-events-none -z-0 bg-no-repeat transition-all duration-500"
                                style={{ backgroundImage: `url(${currentConfig.backgroundImage})`, backgroundSize: currentConfig.bgSize || 'cover', backgroundPosition: `center ${currentConfig.bgPosY || 50}%` }} 
                            />
                        )}
                        <div className="relative z-10 pb-28 px-2 pt-4">
                            {filteredTasks.map(ticket => (
                                <TicketCard key={ticket.id} ticket={ticket} onClick={setSelectedTicket} notifyDays={settings.notifyDays} isSelectionMode={isSelectionMode} isSelected={selectedIds.has(ticket.id)} onSelect={(id) => {const n = new Set(selectedIds); if(n.has(id)) n.delete(id); else n.add(id); setSelectedIds(n);}} opacity={currentConfig.cardOpacity} cardBgColor={currentConfig.cardBgColor} isCompact={isCompact} compactHeight={currentConfig.compactHeight} compactShowImage={currentConfig.compactShowImage} />
                            ))}
                            {filteredTasks.length === 0 && <div className="text-center py-20 text-slate-300 font-bold animate-fade-in"><ImageIcon size={48} className="mx-auto mb-2 opacity-20"/><p>查無相關票券</p></div>}
                        </div>
                    </div>
                    {isSelectionMode ? (
                        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 flex gap-3 z-40 animate-slide-up w-full max-w-[350px]">
                            <button onClick={() => setShowBatchModal(true)} className="flex-1 bg-sky-500 text-white py-3 rounded-2xl font-bold shadow-lg shadow-sky-100 flex items-center justify-center gap-2 transition-transform active:scale-95"><Tag size={18}/> 標籤</button>
                            <button onClick={() => { if(confirm(`確定刪除選取的 ${selectedIds.size} 個項目？`)) { tasks.forEach(t => { if(selectedIds.has(t.id)) handleDelete(t.id); }); setSelectedIds(new Set()); setIsSelectionMode(false); } }} className="w-16 bg-white text-red-500 border border-red-100 py-3 rounded-2xl font-bold shadow-lg flex items-center justify-center"><Trash size={18}/></button>
                            <button onClick={() => { setIsSelectionMode(false); setSelectedIds(new Set()); }} className="bg-slate-800 text-white px-4 py-3 rounded-2xl font-bold shadow-lg">取消</button>
                        </div>
                    ) : (
                        <button onClick={() => setShowAddModal(true)} className="fixed bottom-24 right-5 w-16 h-16 bg-sky-500 text-white rounded-[24px] shadow-2xl shadow-sky-300 flex items-center justify-center z-40 hover:bg-sky-600 hover:rotate-90 transition-all active:scale-90"><Plus size={32}/></button>
                    )}
                    <AddTicketModal isOpen={showAddModal} onClose={() => setShowAddModal(false)} onAddBatch={handleAddBatch} allTags={allTags} />
                    <RedeemModal ticket={selectedTicket} onClose={() => setSelectedTicket(null)} onToggleComplete={handleToggleComplete} onDelete={handleDelete} onRestore={(t)=>handleUpdate({...t, isDeleted: false})} onUpdate={handleUpdate} allTags={allTags} />
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} settings={settings} bgHistory={bgHistory} onSave={handleSaveSettings} onRemoveHistory={(url)=>{ setBgHistory(prev=>prev.filter(u=>u!==url)); dbOps.put(STORES.HISTORY, bgHistory.filter(u=>u!==url), 'bg_history'); }} />
                    <BatchEditModal isOpen={showBatchModal} onClose={() => setShowBatchModal(false)} selectedCount={selectedIds.size} onAddTag={(tags) => { tasks.forEach(t => { if(selectedIds.has(t.id)) handleUpdate({...t, tags: [...new Set([...(t.tags || []), ...tags])]}) }); setIsSelectionMode(false); setSelectedIds(new Set()); }} allTags={allTags} />
                </div>
            );
        };
        const root = createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
