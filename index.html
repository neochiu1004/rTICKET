<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›¢ç·šç¥¨åˆ¸ç®¡å®¶ Fresh (Wallet UI)</title>

    <!-- 1. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. å¼•å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. å¼•å…¥æœ¬åœ°ç¹ªè£½æ¢ç¢¼èˆ‡QR Codeçš„å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/bwip-js@3.0.4/dist/bwip-js-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <!-- 4. è¨­å®š Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>

    <!-- Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', // Sky Blue
                        },
                        accent: {
                            50: '#fdf4ff', 500: '#d946ef', // Fuchsia
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'bounce-sm': 'bounceSmall 0.2s infinite alternate',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        bounceSmall: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(-2px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modern Ticket Rip Effect - Smoother */
        .ticket-rip-l {
            position: absolute; left: -6px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 12px; border-radius: 50%;
            background-color: #f8fafc; /* Match body bg */
            box-shadow: inset -1px 0 2px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .ticket-rip-r {
            position: absolute; right: -6px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 12px; border-radius: 50%;
            background-color: #f8fafc;
            box-shadow: inset 1px 0 2px rgba(0,0,0,0.05);
            z-index: 10;
        }
    </style>
</head>
<body class="text-slate-700">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            Trash2, Calendar, Check, Plus, LogIn, ExternalLink, Tag, RotateCcw,
            CheckCircle2, ListTodo, Clock, StickyNote, Save, X, ScanBarcode,
            Pencil, ClipboardPaste, ArrowRightLeft, Copy, CheckSquare, Trash,
            RefreshCcw, Search, FolderPlus, AlertCircle, MoreVertical, Copy as CopyIcon, Link as LinkIcon,
            Image as ImageIcon, Upload, Clipboard, ClipboardList, AlertTriangle, Download, FileJson, Database, FolderInput,
            LayoutDashboard, Moon, Sun, ChevronUp, ChevronDown, Filter, AlertOctagon, CheckSquareIcon,
            Bell, BellRing, Send, UserCheck, CloudCog, Maximize2, Wand2, WifiOff, FileUp, Replace, FilePlus2, RefreshCw,
            ImagePlus, Heart, HeartHandshake, Eye, EyeOff, Globe, BookOpen, Star, History, MousePointerClick, Layers,
            CalendarX2, CopyPlus, Lightbulb, Loader2, QrCode, SlidersHorizontal, ArrowUpDown, Image, CheckCheck, SendHorizontal, XCircle
        } from 'lucide-react';

        // --- 1. Core Logic (Helpers) ---

        const parseBatchTicketInfo = (text, overrideName) => {
            const results = [];
            const lines = text.split(/\r?\n/);
            lines.forEach((rawLine, index) => {
                const line = rawLine.trim();
                if (!line) return;
                let dateStr = "";
                const dateMatch = line.match(/\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/);
                if (dateMatch) dateStr = dateMatch[0].replace(/[\.\-]/g, '/');
                const lineWithoutDate = line.replace(/\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/, '');
                
                let serialStr = "";
                const serialMatch = lineWithoutDate.match(/(?:åˆ¸è™Ÿ|åˆ¸è™Ÿï¼š|åºè™Ÿ|CODE|Code|å¯†ç¢¼|PIN)[:ï¼š\s]*([A-Za-z0-9\-\s]{8,})/i);
                if (serialMatch && serialMatch[1]) {
                    serialStr = serialMatch[1].trim().replace(/\s/g, '');
                } else {
                    const potentialCodes = lineWithoutDate.match(/[A-Za-z0-9]{9,30}/g);
                    if (potentialCodes) {
                         const validCodes = potentialCodes.filter(code => !/^20\d{6}$/.test(code) && !/^\d{9,15}$/.test(code));
                         if (validCodes.length > 0) serialStr = validCodes[0];
                    }
                }

                if (serialStr) {
                    let finalName = overrideName || "Regexè§£æç¥¨åˆ¸";
                    if (!overrideName) {
                         if (index > 0 && lines[index-1].trim().length > 2) finalName = lines[index-1].trim();
                         else finalName = "æœªå‘½åç¥¨åˆ¸";
                    }
                    results.push({
                        id: 'task_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2,5),
                        text: rawLine, originalRaw: rawLine,
                        isTicket: true, serial: serialStr, productName: finalName, expiry: dateStr,
                        tags: [], images: [], image: '', completed: false, isDeleted: false, createdAt: Date.now(), note: '',
                    });
                }
            });
            return results;
        };

        const compressImage = (fileOrUrl) => {
            return new Promise((resolve, reject) => {
                const img = new window.Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    const MAX = 800;
                    if (width > height) { if (width > MAX) { height *= MAX / width; width = MAX; } }
                    else { if (height > MAX) { width *= MAX / height; height = MAX; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
                img.onerror = reject;
                if (typeof fileOrUrl === 'string') img.src = fileOrUrl;
                else { const r = new FileReader(); r.onload = e => img.src = e.target.result; r.readAsDataURL(fileOrUrl); }
            });
        };

        const checkIsExpiringSoon = (expiryStr, thresholdDays = 7) => {
            if (!expiryStr) return false;
            const normalizedDate = expiryStr.replace(/[\.\-]/g, '/');
            const expiryDate = new Date(normalizedDate);
            if (isNaN(expiryDate.getTime())) return false;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const diffTime = expiryDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= thresholdDays && diffDays >= -1; 
        };

        const formatTime = (timestamp) => {
            if(!timestamp) return '';
            const d = new Date(timestamp);
            if(isNaN(d.getTime())) return '';
            return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
        };

        const sendTelegramMessage = async (token, chatId, text) => {
            if (!token || !chatId) return { success: false, error: 'Missing token or chat_id' };
            try {
                const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(text)}&parse_mode=Markdown`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.ok) {
                    console.log("TG Notification sent successfully");
                    return { success: true };
                } else {
                    console.error("TG API Error:", data);
                    return { success: false, error: data.description };
                }
            } catch (error) {
                console.error("TG Network Error:", error);
                return { success: false, error: error.message };
            }
        };

        // --- 2. UI Components ---

        const QRCodeCanvas = ({ text, size = 180 }) => {
            const canvasRef = useRef(null);
            useEffect(() => { if (canvasRef.current && window.QRious) new window.QRious({ element: canvasRef.current, value: text, size: size, level: 'H' }); }, [text, size]);
            return <canvas ref={canvasRef} className="rounded-2xl shadow-sm border border-slate-100" />;
        };

        const BarcodeCanvas = ({ text }) => {
            const canvasRef = useRef(null);
            useEffect(() => { if (canvasRef.current && window.bwipjs) try { window.bwipjs.toCanvas(canvasRef.current, { bcid: 'code128', text: text, scale: 3, height: 10, includetext: true, textxalign: 'center' }); } catch (e) {} }, [text]);
            return <canvas ref={canvasRef} className="max-w-full h-auto rounded-lg shadow-sm border border-slate-100 bg-white p-1" />;
        };

        const TagSelectInput = ({ allTags, selectedTags, onTagsChange }) => {
            const [inputVal, setInputVal] = useState('');
            const handleAdd = (tag) => {
                if(!selectedTags.includes(tag)) onTagsChange([...selectedTags, tag]);
                setInputVal('');
            };
            const handleRemove = (tag, e) => {
                e.preventDefault(); 
                e.stopPropagation();
                onTagsChange(selectedTags.filter(t => t !== tag));
            };
            return (
                <div className="space-y-2">
                    <div className="flex flex-wrap gap-2">
                        {selectedTags.map(tag => (
                            <span key={tag} className="bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                {tag} <button type="button" onClick={(e) => handleRemove(tag, e)} className="hover:text-sky-900 p-0.5 rounded-full hover:bg-sky-200"><X size={12}/></button>
                            </span>
                        ))}
                    </div>
                    <div className="flex gap-2 relative">
                        <input value={inputVal} onChange={e => setInputVal(e.target.value)} placeholder="æ–°å¢æ¨™ç±¤..." className="flex-1 p-3 bg-slate-50 rounded-xl text-sm border-none focus:ring-2 focus:ring-sky-400 outline-none" onKeyDown={e => { if(e.key === 'Enter' && inputVal.trim()) handleAdd(inputVal.trim()); }} />
                        <button onClick={() => inputVal.trim() && handleAdd(inputVal.trim())} className="bg-sky-500 text-white p-3 rounded-xl hover:bg-sky-600 transition-colors"><Plus size={18}/></button>
                        {inputVal && (
                            <div className="absolute top-full mt-2 w-full bg-white border border-slate-100 rounded-xl shadow-xl z-20 max-h-32 overflow-y-auto">
                                {allTags.filter(t => t.includes(inputVal) && !selectedTags.includes(t)).map(t => (
                                    <button key={t} onClick={() => handleAdd(t)} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-50 font-medium text-slate-600">{t}</button>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        {allTags.filter(t => !selectedTags.includes(t)).slice(0, 5).map(t => (
                            <button key={t} onClick={() => handleAdd(t)} className="text-xs font-bold bg-slate-100 text-slate-500 px-3 py-1.5 rounded-full whitespace-nowrap hover:bg-slate-200 transition-colors">+ {t}</button>
                        ))}
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, tgToken, setTgToken, tgChatId, setTgChatId, notifyDays, setNotifyDays, onSave }) => {
            if(!isOpen) return null;
            const [localToken, setLocalToken] = useState(tgToken);
            const [localChatId, setLocalChatId] = useState(tgChatId);
            const [localDays, setLocalDays] = useState(notifyDays);
            const [testStatus, setTestStatus] = useState(null);

            const handleSave = () => {
                onSave({ tgToken: localToken, tgChatId: localChatId, notifyDays: localDays });
                onClose();
            };

            const handleTest = async () => {
                setTestStatus('sending');
                const result = await sendTelegramMessage(localToken, localChatId, "ğŸ”” é€™æ˜¯ä¸€å‰‡ä¾†è‡ªã€Œé›¢ç·šç¥¨åˆ¸ç®¡å®¶ã€çš„æ¸¬è©¦è¨Šæ¯ã€‚");
                if (result.success) {
                    setTestStatus('success');
                    setTimeout(() => setTestStatus(null), 3000);
                } else {
                    setTestStatus('error');
                    alert(`ç™¼é€å¤±æ•—: ${result.error}\n\nå¯èƒ½åŸå› ï¼šToken/ChatIDéŒ¯èª¤ï¼Œæˆ–ç€è¦½å™¨CORSé˜»æ“‹ã€‚\nè«‹ç¢ºèªBotå·²åŠ å…¥é »é“ä¸¦æœ‰ç™¼è¨€æ¬Šé™ã€‚`);
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl scale-100" onClick={e => e.stopPropagation()}>
                        <h2 className="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800"><CloudCog size={24} className="text-sky-500"/> ç³»çµ±è¨­å®š</h2>
                        <div className="space-y-5">
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">é€šçŸ¥å¤©æ•¸ (ç´…æ¡†é¡¯ç¤º)</label>
                                <input type="number" value={localDays} onChange={e => setLocalDays(e.target.value)} className="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-sky-400"/>
                            </div>
                            <div className="border-t border-slate-100 pt-4">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Telegram Bot Token</label>
                                <input type="text" value={localToken} onChange={e => setLocalToken(e.target.value)} placeholder="123456:ABC-DEF..." className="w-full p-3 bg-slate-50 rounded-xl text-sm font-mono text-slate-600 outline-none focus:ring-2 focus:ring-sky-400"/>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Telegram Chat ID</label>
                                <input type="text" value={localChatId} onChange={e => setLocalChatId(e.target.value)} placeholder="-123456789" className="w-full p-3 bg-slate-50 rounded-xl text-sm font-mono text-slate-600 outline-none focus:ring-2 focus:ring-sky-400"/>
                            </div>
                            
                            <button onClick={handleTest} disabled={!localToken || !localChatId || testStatus === 'sending'} 
                                className={`w-full py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-2 transition-all ${testStatus === 'success' ? 'bg-emerald-100 text-emerald-600' : testStatus === 'error' ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                {testStatus === 'sending' ? <Loader2 size={14} className="animate-spin"/> : testStatus === 'success' ? <Check size={14}/> : <SendHorizontal size={14}/>}
                                {testStatus === 'sending' ? 'å‚³é€ä¸­...' : testStatus === 'success' ? 'æ¸¬è©¦æˆåŠŸ' : testStatus === 'error' ? 'æ¸¬è©¦å¤±æ•—' : 'æ¸¬è©¦å‚³é€'}
                            </button>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">å–æ¶ˆ</button>
                            <button onClick={handleSave} className="px-6 py-2.5 bg-sky-500 hover:bg-sky-600 text-white rounded-xl font-bold shadow-lg shadow-sky-200 transition-all active:scale-95">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Header = ({ appTitle, onTitleChange, onOpenMenu, onOpenSettings, sortType, setSortType, setSearchQuery, searchQuery, isSelectionMode, setIsSelectionMode, selectedCount, onSelectAll }) => (
            <div className="bg-white/80 backdrop-blur-md px-5 pt-12 pb-3 shadow-sm sticky top-0 z-30 border-b border-slate-100 transition-all">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center gap-2 group cursor-pointer" onClick={() => {
                        const newTitle = prompt("ä¿®æ”¹æ¨™é¡Œåç¨±:", appTitle);
                        if(newTitle) onTitleChange(newTitle);
                    }}>
                        <h1 className="text-2xl font-black text-slate-800 tracking-tight">{appTitle}</h1>
                        <Pencil size={14} className="text-slate-300 group-hover:text-sky-500 transition-colors"/>
                    </div>
                    <div className="flex gap-2">
                        {isSelectionMode && (
                            <button 
                                onClick={onSelectAll} 
                                className="px-3 py-1.5 rounded-full text-xs font-bold transition-all bg-emerald-100 text-emerald-600 hover:bg-emerald-200 flex items-center gap-1"
                            >
                                <CheckCheck size={14} /> å…¨é¸
                            </button>
                        )}
                        <button 
                            onClick={() => setIsSelectionMode(!isSelectionMode)} 
                            className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${isSelectionMode ? 'bg-sky-500 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                        >
                            {isSelectionMode ? `å·²é¸ ${selectedCount}` : 'é¸å–'}
                        </button>
                        <button onClick={onOpenSettings} className="w-9 h-9 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-500 hover:text-sky-600 hover:bg-white transition-all">
                            <i className="fas fa-cog"></i>
                        </button>
                        <button onClick={onOpenMenu} className="w-9 h-9 rounded-full bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-500 hover:text-sky-600 hover:bg-white transition-all">
                            <i className="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                
                {/* Search & Sort Bar */}
                <div className="flex gap-3">
                    <div className="relative flex-1 group">
                        <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-sky-500 transition-colors" />
                        <input 
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value)}
                            placeholder="æœå°‹åç¨±ã€æ¨™ç±¤..." 
                            className="w-full pl-10 pr-3 py-2.5 text-sm bg-slate-50 border border-transparent focus:bg-white focus:border-sky-200 rounded-2xl outline-none font-medium text-slate-700 transition-all placeholder:text-slate-400" 
                        />
                    </div>
                    <button 
                        onClick={() => {
                            const types = ['expiring', 'newest', 'oldest'];
                            const nextIdx = (types.indexOf(sortType) + 1) % types.length;
                            setSortType(types[nextIdx]);
                        }}
                        className="px-4 py-2.5 bg-slate-50 hover:bg-white border border-transparent hover:border-slate-200 rounded-2xl flex items-center gap-1.5 text-xs font-bold text-slate-600 transition-all"
                    >
                        <ArrowUpDown size={14} className="text-sky-500"/>
                        {sortType === 'expiring' ? 'å¿«åˆ°æœŸ' : sortType === 'newest' ? 'æœ€æ–°' : 'æœ€èˆŠ'}
                    </button>
                </div>
            </div>
        );

        const TagTabs = ({ activeTag, setActiveTag, tags, onManageTags }) => {
            const displayTags = ['all', ...tags.slice(0, 10)];
            return (
                <div className="bg-white px-4 pt-3 pb-2 border-b border-slate-50 flex items-center gap-2 sticky top-[125px] z-20 overflow-hidden">
                    <div className="flex gap-3 overflow-x-auto no-scrollbar flex-1 pb-1">
                        {displayTags.map(tag => (
                            <button key={tag} onClick={() => setActiveTag(tag)} className={`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all ${activeTag === tag ? 'bg-sky-500 text-white shadow-md shadow-sky-200' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}>
                                {tag === 'all' ? 'å…¨éƒ¨' : tag}
                            </button>
                        ))}
                    </div>
                    <button onClick={onManageTags} className="p-2 text-slate-400 hover:text-sky-600 bg-white shadow-sm rounded-full border border-slate-50"><SlidersHorizontal size={16}/></button>
                </div>
            );
        };

        const TicketCard = ({ ticket, onClick, notifyDays, isSelectionMode, isSelected, onSelect, isDuplicate }) => {
            const isExpiring = !ticket.completed && ticket.expiry && checkIsExpiringSoon(ticket.expiry, notifyDays);
            
            // 3. Duplicate Style: Red border for duplicates
            const duplicateStyle = isDuplicate && !ticket.completed && !ticket.isDeleted 
                ? 'border-red-500 ring-2 ring-red-100 shadow-red-200' 
                : '';

            return (
                <div 
                    onClick={() => {
                        if(isSelectionMode) onSelect(ticket.id);
                        else onClick(ticket);
                    }}
                    className={`bg-white mx-4 mt-4 p-4 rounded-3xl shadow-sm border flex gap-4 active:scale-[0.98] transition-all cursor-pointer relative overflow-hidden group 
                    ${isSelected ? 'ring-2 ring-sky-500 border-sky-500 bg-sky-50' : isExpiring ? 'border-red-400 shadow-red-100 bg-red-50/10' : 'border-slate-100 hover:border-sky-200 hover:shadow-md'}
                    ${duplicateStyle}`}
                >
                    {isSelectionMode && (
                        <div className={`absolute top-3 right-3 z-20 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${isSelected ? 'bg-sky-500 border-sky-500' : 'border-slate-300 bg-white'}`}>
                            {isSelected && <Check size={14} className="text-white"/>}
                        </div>
                    )}
                    
                    {/* Duplicate Indicator Label */}
                    {isDuplicate && !ticket.completed && !ticket.isDeleted && (
                        <div className="absolute top-0 left-0 bg-red-500 text-white text-[9px] px-2 py-0.5 rounded-br-lg z-20 font-bold">
                            é‡è¤‡åºè™Ÿ
                        </div>
                    )}

                    <div className="w-20 h-20 flex-shrink-0 bg-slate-50 rounded-2xl flex items-center justify-center overflow-hidden border border-slate-100 relative group-hover:scale-105 transition-transform">
                        {ticket.image ? (
                            <img src={ticket.image} alt="logo" className={`w-full h-full object-cover ${ticket.completed ? 'grayscale opacity-50' : ''}`} />
                        ) : (
                            <i className="fas fa-ticket-alt text-slate-300 text-2xl"></i>
                        )}
                        {ticket.images && ticket.images.length > 1 && (
                            <div className="absolute bottom-0 right-0 bg-black/60 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-tl-lg">+{ticket.images.length-1}</div>
                        )}
                    </div>

                    <div className="flex-1 flex flex-col justify-between py-1 min-w-0">
                        <div>
                            <div className="flex justify-between items-start pr-6">
                                <h3 className={`font-bold text-slate-800 line-clamp-1 text-[15px] ${ticket.completed ? 'line-through text-slate-400' : ''}`}>
                                    {ticket.productName}
                                </h3>
                                {ticket.completed && <span className="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold">å·²ä½¿ç”¨</span>}
                            </div>
                            {isExpiring && !ticket.completed && !ticket.isDeleted && <div className="text-[10px] font-bold text-red-500 mt-1 flex items-center gap-1 animate-pulse"><AlertCircle size={10}/> å¿«åˆ°æœŸ</div>}
                            
                            <div className="flex gap-1.5 mt-2 overflow-x-auto no-scrollbar">
                                {ticket.tags && ticket.tags.map(t => (
                                    <span key={t} className="text-[10px] bg-sky-50 text-sky-600 px-2 py-0.5 rounded-md font-bold whitespace-nowrap">{t}</span>
                                ))}
                                {!ticket.tags?.length && <span className="text-[10px] text-slate-300 font-bold">#</span>}
                            </div>
                        </div>
                        
                        <div className="flex justify-between items-end mt-2">
                            {ticket.completed && ticket.completedAt ? (
                                <div className="text-[10px] font-bold text-emerald-600 flex items-center gap-1 bg-emerald-50 px-2 py-0.5 rounded-lg">
                                    <CheckCircle2 size={10}/> <span>æ ¸éŠ·æ–¼ {formatTime(ticket.completedAt)}</span>
                                </div>
                            ) : (
                                <div className={`text-xs font-bold flex items-center gap-1.5 ${isExpiring ? 'text-red-500' : 'text-slate-400'}`}>
                                    <Clock size={12}/> <span>{ticket.expiry || 'ç„¡æœŸé™'}</span>
                                </div>
                            )}

                            {!isSelectionMode && (
                                <button className={`text-xs font-bold px-3 py-1.5 rounded-full transition-colors ${ticket.completed ? 'bg-slate-100 text-slate-500' : 'bg-orange-50 text-orange-600 group-hover:bg-orange-500 group-hover:text-white'}`}>
                                    {ticket.completed ? 'æŸ¥çœ‹' : 'å…Œæ›'}
                                </button>
                            )}
                        </div>
                    </div>
                    
                    <div className="ticket-rip-l"></div>
                    <div className="ticket-rip-r"></div>
                </div>
            );
        };

        const RedeemModal = ({ ticket, onClose, onToggleComplete, onDelete, onRestore, onUpdate, allTags }) => {
            if (!ticket) return null;
            const [isEditing, setIsEditing] = useState(false);
            const [editName, setEditName] = useState(ticket.productName);
            const [editExpiry, setEditExpiry] = useState(ticket.expiry);
            const [editTags, setEditTags] = useState(ticket.tags || []);
            const [editImage, setEditImage] = useState(ticket.image || '');
            const [showOriginalImage, setShowOriginalImage] = useState(false);

            const handleSave = () => {
                onUpdate({
                    ...ticket,
                    productName: editName,
                    expiry: editExpiry.replace(/-/g, '/'),
                    tags: editTags, 
                    image: editImage,
                    images: editImage ? (ticket.images && ticket.images.includes(editImage) ? ticket.images : [editImage, ...(ticket.images || [])]) : ticket.images
                });
                setIsEditing(false);
            };

            const handleImageChange = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    const base64 = await compressImage(file);
                    setEditImage(base64);
                }
            };

            const hasImage = !!ticket.image;
            const hasSerial = !!ticket.serial;
            const forceShowImage = hasImage && !hasSerial;
            const displayImage = showOriginalImage || forceShowImage;

            return (
                <div className="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center sm:p-4 animate-fade-in backdrop-blur-md" onClick={onClose}>
                    {/* Changed: Full screen on mobile, card on desktop */}
                    <div className="bg-white w-full h-full sm:h-auto sm:max-h-[90vh] sm:max-w-md sm:rounded-[32px] shadow-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                        
                        {/* Header: Title and Close Button */}
                        <div className="px-6 pt-6 pb-2 flex justify-between items-start shrink-0">
                             {isEditing ? (
                                <input className="text-xl font-black w-full border-b border-sky-200 pb-2 mr-4 text-slate-800 focus:outline-none focus:border-sky-500" value={editName} onChange={e=>setEditName(e.target.value)} />
                             ) : (
                                <h3 className="text-2xl font-black text-slate-800 break-words leading-tight mr-4">{ticket.productName}</h3>
                             )}
                             <button onClick={onClose} className="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 transition-colors shrink-0">
                                <X size={20}/>
                             </button>
                        </div>

                        {/* Scrollable Content Area */}
                        <div className="flex-1 overflow-y-auto px-6 py-2 no-scrollbar">
                            
                            {isEditing ? (
                                <div className="mt-2 space-y-4 bg-slate-50 p-4 rounded-2xl">
                                    {/* Image Editor */}
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase">æ›´æ›å°é¢</label>
                                        <div className="flex items-center gap-3 mt-2">
                                            {editImage ? <img src={editImage} className="w-16 h-16 object-cover rounded-xl border border-slate-200"/> : <div className="w-16 h-16 bg-white border border-dashed border-slate-300 rounded-xl flex items-center justify-center"><ImageIcon size={20} className="text-slate-300"/></div>}
                                            <div className="flex flex-col gap-2">
                                                <label className="px-3 py-1.5 bg-sky-100 text-sky-600 text-xs font-bold rounded-lg cursor-pointer hover:bg-sky-200 text-center">
                                                    ä¸Šå‚³ <input type="file" accept="image/*" onChange={handleImageChange} className="hidden"/>
                                                </label>
                                                {editImage && <button onClick={()=>setEditImage('')} className="text-red-500 text-xs font-bold hover:underline">ç§»é™¤åœ–ç‰‡</button>}
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">æ¨™ç±¤</label>
                                        <TagSelectInput allTags={allTags} selectedTags={editTags} onTagsChange={setEditTags} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">æœŸé™</label>
                                        <input type="date" value={editExpiry ? editExpiry.replace(/\//g, '-') : ''} onChange={e=>setEditExpiry(e.target.value)} className="w-full border border-slate-200 rounded-xl p-2.5 text-sm bg-white" />
                                    </div>
                                </div>
                            ) : (
                                <div className="my-4 flex flex-col items-center gap-4">
                                    {hasSerial && hasImage && (
                                        <div className="flex bg-slate-100 p-1 rounded-xl w-full">
                                            <button onClick={()=>setShowOriginalImage(false)} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${!showOriginalImage ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400 hover:text-slate-600'}`}>é¡¯ç¤ºæ¢ç¢¼</button>
                                            <button onClick={()=>setShowOriginalImage(true)} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${showOriginalImage ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400 hover:text-slate-600'}`}>åŸå§‹åœ–ç‰‡</button>
                                        </div>
                                    )}

                                    {displayImage && hasImage ? (
                                         <div className="relative group w-full flex justify-center">
                                             {/* Changed: Full width, auto height to preserve aspect ratio */}
                                             <img src={ticket.image} className="w-full h-auto rounded-xl shadow-sm border border-slate-100" />
                                             <a href={ticket.image} download={`ticket_${ticket.productName}`} className="absolute bottom-3 right-3 bg-slate-900/60 text-white p-2 rounded-lg hover:bg-slate-900/80 backdrop-blur-sm shadow-md"><Download size={16}/></a>
                                         </div>
                                    ) : (
                                        <div className="w-full bg-slate-50 p-6 rounded-[24px] border border-slate-100 flex flex-col items-center shadow-inner">
                                            {ticket.serial && <div className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm mb-4 w-full flex justify-center"><BarcodeCanvas text={ticket.serial} /></div>}
                                            <div className="p-4 bg-white rounded-2xl shadow-sm border border-slate-100">
                                                {ticket.serial ? <QRCodeCanvas text={ticket.serial} /> : <div className="w-40 h-40 flex items-center justify-center text-slate-300 font-bold border-2 border-dashed border-slate-100 rounded-xl">ç„¡æ¢ç¢¼</div>}
                                            </div>
                                        </div>
                                    )}

                                    <div className="text-center w-full mt-2">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">å…Œæ›åºè™Ÿ</p>
                                        <div className="text-2xl font-mono font-black text-slate-800 tracking-wider select-all cursor-pointer bg-slate-50 px-4 py-4 rounded-2xl border border-slate-200/60 shadow-sm flex items-center justify-center gap-3 group hover:border-sky-300 transition-colors"
                                           onClick={() => {if(ticket.serial) {navigator.clipboard.writeText(ticket.serial); alert('å·²è¤‡è£½');}}}>
                                            {ticket.serial || 'ç„¡åºè™Ÿ'} 
                                            {ticket.serial && <Copy size={20} className="text-slate-300 group-hover:text-sky-500"/>}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Footer Buttons Fixed at Bottom */}
                        <div className="p-6 border-t border-slate-100 bg-white shrink-0 flex flex-col gap-3">
                            {isEditing ? (
                                <div className="flex gap-3">
                                    <button onClick={()=>setIsEditing(false)} className="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200">å–æ¶ˆ</button>
                                    <button onClick={handleSave} className="flex-1 py-4 bg-sky-500 text-white rounded-2xl font-bold shadow-lg shadow-sky-200 hover:bg-sky-600">å„²å­˜è®Šæ›´</button>
                                </div>
                            ) : (
                                <>
                                    {!ticket.isDeleted && (
                                        <button 
                                            onClick={() => { onToggleComplete(ticket); onClose(); }} 
                                            className={`w-full py-4 text-xl font-black rounded-2xl shadow-lg flex items-center justify-center gap-2 text-white transition-all active:scale-95 ${ticket.completed ? 'bg-emerald-500 shadow-emerald-200 hover:bg-emerald-600' : 'bg-emerald-500 shadow-emerald-200 hover:bg-emerald-600'}`}
                                        >
                                            {ticket.completed ? <><RotateCcw size={24}/> æ¨™è¨˜ç‚ºæœªç”¨</> : <><CheckCircle2 size={24}/> ç«‹å³æ ¸éŠ·</>}
                                        </button>
                                    )}
                                    <div className="flex gap-3">
                                        {ticket.isDeleted ? (
                                            <button onClick={() => { onRestore(ticket); onClose(); }} className="flex-1 py-3 bg-emerald-50 text-emerald-600 font-bold rounded-2xl flex items-center justify-center gap-2 hover:bg-emerald-100">
                                                <RefreshCcw size={18}/> é‚„åŸ
                                            </button>
                                        ) : (
                                            <button onClick={() => setIsEditing(true)} className="flex-1 py-3 bg-slate-50 text-slate-600 font-bold rounded-2xl flex items-center justify-center gap-2 hover:bg-slate-100 border border-slate-100">
                                                <Pencil size={18}/> ç·¨è¼¯
                                            </button>
                                        )}
                                        <button onClick={() => { onDelete(ticket.id); onClose(); }} className="flex-1 py-3 bg-red-50 text-red-500 font-bold rounded-2xl flex items-center justify-center gap-2 hover:bg-red-100 border border-red-50">
                                            <Trash2 size={18}/> {ticket.isDeleted ? 'æ°¸ä¹…åˆªé™¤' : 'åˆªé™¤'}
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const AddTicketModal = ({ isOpen, onClose, onAddBatch, allTags }) => {
            if (!isOpen) return null;
            const [activeTab, setActiveTab] = useState('smart');
            const [pasteVal, setPasteVal] = useState('');
            const [loading, setLoading] = useState(false);
            const [manualData, setManualData] = useState({ name: '', serial: '', expiry: '', note: '' });
            const [manualTags, setManualTags] = useState([]);
            const [images, setImages] = useState([]);

            const handleSmartSubmit = async () => {
                if (!pasteVal.trim()) return;
                setLoading(true);
                try {
                    const results = parseBatchTicketInfo(pasteVal);
                    if (results.length === 0) {
                        alert("æœªèƒ½è§£æå‡ºç¥¨åˆ¸ï¼Œè«‹ç¢ºèªæ ¼å¼æˆ–è½‰ç‚ºæ‰‹å‹•è¼¸å…¥ã€‚");
                    } else {
                        onAddBatch(results);
                        onClose();
                    }
                } catch (e) { alert("è™•ç†å¤±æ•—"); } finally { setLoading(false); }
            };

            const handleManualSubmit = () => {
                if (!manualData.name) { alert("è«‹è¼¸å…¥åç¨±"); return; }
                const newTicket = {
                    id: Date.now(), productName: manualData.name, serial: manualData.serial,
                    expiry: manualData.expiry.replace(/-/g, '/'), note: manualData.note,
                    images: images, image: images[0] || '', tags: manualTags, completed: false, isDeleted: false, createdAt: Date.now()
                };
                onAddBatch([newTicket]);
                onClose();
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    const base64 = await compressImage(file);
                    setImages([base64]);
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-end sm:items-center justify-center animate-fade-in backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full sm:w-[450px] sm:rounded-3xl rounded-t-[32px] p-6 shadow-2xl transform transition-transform duration-300 max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-black text-slate-800">æ–°å¢ç¥¨åˆ¸</h2>
                            <button onClick={onClose} className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200"><X size={18}/></button>
                        </div>

                        <div className="flex bg-slate-100 p-1.5 rounded-2xl mb-6">
                            <button onClick={()=>setActiveTab('smart')} className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all ${activeTab==='smart' ? 'bg-white shadow text-sky-600' : 'text-slate-400 hover:text-slate-600'}`}><Wand2 size={14} className="inline mr-1"/> æ™ºæ…§è²¼ä¸Š</button>
                            <button onClick={()=>setActiveTab('manual')} className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all ${activeTab==='manual' ? 'bg-white shadow text-sky-600' : 'text-slate-400 hover:text-slate-600'}`}><Pencil size={14} className="inline mr-1"/> æ‰‹å‹•è¼¸å…¥</button>
                        </div>

                        {activeTab === 'smart' ? (
                            <div className="space-y-4">
                                <textarea className="w-full h-40 p-4 bg-slate-50 rounded-2xl border border-transparent focus:bg-white focus:border-sky-300 outline-none resize-none text-sm font-medium text-slate-700 placeholder:text-slate-400" placeholder="è²¼ä¸Šç°¡è¨Š/Email..." value={pasteVal} onChange={e=>setPasteVal(e.target.value)}></textarea>
                                <div className="text-xs font-bold text-slate-400 bg-slate-50 p-3 rounded-xl">ğŸ’¡ æç¤ºï¼šæ”¯æ´åŒ…å«ã€Œåˆ¸è™Ÿã€ã€ã€Œåºè™Ÿã€ã€ã€ŒæœŸé™ã€ç­‰é—œéµå­—çš„æ–‡å­—ã€‚</div>
                                <button onClick={handleSmartSubmit} disabled={loading} className="w-full bg-sky-500 hover:bg-sky-600 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-sky-200 flex items-center justify-center gap-2 transition-transform active:scale-95">
                                    {loading ? <Loader2 className="animate-spin"/> : <Wand2 size={18}/>} ç«‹å³è§£æ
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                <div className="flex items-center gap-3">
                                    <div className="w-20 h-20 bg-slate-50 border border-dashed border-slate-300 rounded-2xl flex items-center justify-center relative overflow-hidden group">
                                        {images.length > 0 ? <img src={images[0]} className="w-full h-full object-cover"/> : <ImageIcon className="text-slate-300 group-hover:text-sky-400 transition-colors"/>}
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={handleImageUpload}/>
                                    </div>
                                    <div className="flex-1 text-xs font-bold text-slate-400">é»æ“Šåœ–ç¤ºä¸Šå‚³ç¥¨åˆ¸ç…§ç‰‡ (é¸å¡«)</div>
                                </div>
                                <input className="w-full p-3.5 bg-slate-50 rounded-xl border-transparent focus:bg-white focus:ring-2 focus:ring-sky-200 font-bold text-slate-700 outline-none" placeholder="ç¥¨åˆ¸åç¨± (å¿…å¡«)" value={manualData.name} onChange={e=>setManualData({...manualData, name: e.target.value})}/>
                                <TagSelectInput allTags={allTags} selectedTags={manualTags} onTagsChange={setManualTags} />
                                <input className="w-full p-3.5 bg-slate-50 rounded-xl border-transparent focus:bg-white focus:ring-2 focus:ring-sky-200 font-mono text-sm text-slate-700 outline-none" placeholder="åºè™Ÿ/ä»£ç¢¼ (é¸å¡«)" value={manualData.serial} onChange={e=>setManualData({...manualData, serial: e.target.value})}/>
                                <input type="date" className="w-full p-3.5 bg-slate-50 rounded-xl border-transparent focus:bg-white focus:ring-2 focus:ring-sky-200 text-slate-500 font-bold outline-none" value={manualData.expiry} onChange={e=>setManualData({...manualData, expiry: e.target.value})}/>
                                <textarea className="w-full p-3.5 bg-slate-50 rounded-xl border-transparent focus:bg-white focus:ring-2 focus:ring-sky-200 h-24 resize-none text-sm font-medium outline-none" placeholder="å‚™è¨»..." value={manualData.note} onChange={e=>setManualData({...manualData, note: e.target.value})}></textarea>
                                <button onClick={handleManualSubmit} className="w-full bg-sky-500 hover:bg-sky-600 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-sky-200 transition-transform active:scale-95">ç¢ºèªæ–°å¢</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const TagManagerModal = ({ isOpen, onClose, tags, onDeleteTag }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 max-h-[60vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                        <h2 className="text-xl font-black mb-4 text-slate-800">ç®¡ç†æ¨™ç±¤</h2>
                        {tags.length === 0 ? <p className="text-slate-400 text-center py-8 font-bold">ç›®å‰æ²’æœ‰æ¨™ç±¤</p> : (
                            <div className="space-y-2">
                                {tags.map(tag => (
                                    <div key={tag} className="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                                        <span className="font-bold text-slate-600 text-sm">#{tag}</span>
                                        <button onClick={() => onDeleteTag(tag)} className="text-red-400 hover:text-red-600 p-2 bg-white rounded-lg shadow-sm"><Trash2 size={16}/></button>
                                    </div>
                                ))}
                            </div>
                        )}
                        <button onClick={onClose} className="w-full mt-6 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-slate-200 transition-colors">é—œé–‰</button>
                    </div>
                </div>
            );
        };
        
        const BatchEditModal = ({ isOpen, onClose, selectedCount, onAddTag, allTags }) => {
             const [tagsToAdd, setTagsToAdd] = useState([]);
             if(!isOpen) return null;
             
             const handleConfirm = () => {
                 onAddTag(tagsToAdd);
                 onClose();
             };
             
             return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-end sm:items-center justify-center animate-fade-in" onClick={onClose}>
                     <div className="bg-white w-full sm:w-[400px] sm:rounded-3xl rounded-t-[32px] p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                        <h2 className="text-xl font-black mb-1 text-slate-800">æ‰¹é‡ç·¨è¼¯</h2>
                        <p className="text-xs font-bold text-slate-400 mb-4">å·²é¸å– {selectedCount} å¼µç¥¨åˆ¸</p>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">æ–°å¢æ¨™ç±¤ (å°‡å¥—ç”¨åˆ°æ‰€æœ‰é¸å–é …ç›®)</label>
                                <TagSelectInput allTags={allTags} selectedTags={tagsToAdd} onTagsChange={setTagsToAdd} />
                            </div>
                        </div>
                        
                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 py-3 bg-slate-100 font-bold rounded-2xl text-slate-500">å–æ¶ˆ</button>
                            <button onClick={handleConfirm} className="flex-1 py-3 bg-sky-500 font-bold rounded-2xl text-white shadow-lg shadow-sky-200 hover:bg-sky-600 transition-colors">ç¢ºèªå„²å­˜</button>
                        </div>
                     </div>
                </div>
             );
        };

        // --- Main App ---
        const App = () => {
            const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('wallet_tasks_v3')) || []);
            const [view, setView] = useState('active');
            const [activeTag, setActiveTag] = useState('all');
            const [sortType, setSortType] = useState('expiring');
            const [searchQuery, setSearchQuery] = useState('');
            const [showAddModal, setShowAddModal] = useState(false);
            const [selectedTicket, setSelectedTicket] = useState(null);
            
            // Selection Mode
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [showBatchModal, setShowBatchModal] = useState(false);

            // Settings
            const [settings, setSettings] = useState(() => JSON.parse(localStorage.getItem('wallet_settings_v3')) || { 
                tgToken: '', tgChatId: '', notifyDays: 7, appTitle: 'æˆ‘çš„ç¥¨å¤¾' 
            });
            const [showSettings, setShowSettings] = useState(false);
            const [showTagManager, setShowTagManager] = useState(false);
            
            // Persist
            useEffect(() => localStorage.setItem('wallet_tasks_v3', JSON.stringify(tasks)), [tasks]);
            useEffect(() => localStorage.setItem('wallet_settings_v3', JSON.stringify(settings)), [settings]);

            // Notification Check
            useEffect(() => {
                const checkNotifications = async () => {
                    if (settings.tgToken && settings.tgChatId && tasks.length > 0) {
                        const todayStr = new Date().toISOString().split('T')[0];
                        const lastCheckKey = 'last_notify_date_v3';
                        if (localStorage.getItem(lastCheckKey) !== todayStr) {
                            const expiring = tasks.filter(t => !t.completed && !t.isDeleted && checkIsExpiringSoon(t.expiry, settings.notifyDays));
                            if (expiring.length > 0) {
                                let msg = `âš ï¸ *[${settings.appTitle}] åˆ°æœŸæé†’ (${expiring.length}ç­†)*\nè¨­å®š: ${settings.notifyDays} å¤©å…§\n\n`;
                                expiring.slice(0, 10).forEach(t => {
                                    const tagStr = t.tags && t.tags.length > 0 ? ` [${t.tags.join(', ')}]` : '';
                                    const serialInfo = t.serial ? ` (åºè™Ÿ: ${t.serial})` : '';
                                    msg += `ğŸ”¸ ${t.productName} (${t.expiry})${serialInfo}${tagStr}\n`;
                                });
                                if(expiring.length > 10) msg += `...ç­‰å…± ${expiring.length} ç­†`;
                                const result = await sendTelegramMessage(settings.tgToken, settings.tgChatId, msg);
                                if(result.success) {
                                    localStorage.setItem(lastCheckKey, todayStr);
                                }
                            }
                        }
                    }
                };
                checkNotifications();
            }, [tasks, settings]);

            const allTags = useMemo(() => [...new Set(tasks.flatMap(t => t.tags || []))], [tasks]);

            // 3. Duplicate Logic: Identify duplicates
            const duplicateSerials = useMemo(() => {
                const counts = {};
                tasks.forEach(t => {
                    if (!t.isDeleted && t.serial) {
                        counts[t.serial] = (counts[t.serial] || 0) + 1;
                    }
                });
                return new Set(Object.keys(counts).filter(s => counts[s] > 1));
            }, [tasks]);

            const filteredTasks = useMemo(() => {
                let result = tasks.filter(t => {
                    if (view === 'active' && (t.completed || t.isDeleted)) return false;
                    if (view === 'completed' && (!t.completed || t.isDeleted)) return false;
                    if (view === 'deleted' && !t.isDeleted) return false;
                    if (activeTag !== 'all' && (!t.tags || !t.tags.includes(activeTag))) return false;
                    if (searchQuery) {
                        const q = searchQuery.toLowerCase();
                        return t.productName.toLowerCase().includes(q) || (t.note && t.note.toLowerCase().includes(q)) || (t.tags && t.tags.some(tag => tag.toLowerCase().includes(q)));
                    }
                    return true;
                });
                
                result.sort((a, b) => {
                    // 3. Sort Logic: Duplicates first (only in active/completed view usually, but doing global)
                    const isDupA = duplicateSerials.has(a.serial) && !a.completed && !a.isDeleted;
                    const isDupB = duplicateSerials.has(b.serial) && !b.completed && !b.isDeleted;
                    if (isDupA !== isDupB) return isDupA ? -1 : 1;

                    if (sortType === 'expiring') {
                        const dateA = a.expiry ? new Date(a.expiry.replace(/\//g, '-')) : new Date(9999, 11, 31);
                        const dateB = b.expiry ? new Date(b.expiry.replace(/\//g, '-')) : new Date(9999, 11, 31);
                        return dateA - dateB;
                    } else if (sortType === 'newest') return b.createdAt - a.createdAt;
                    else return a.createdAt - b.createdAt;
                });
                return result;
            }, [tasks, view, activeTag, searchQuery, sortType, duplicateSerials]);

            const handleAddBatch = (newItems) => setTasks(prev => [...newItems, ...prev]);
            const handleUpdate = (updatedTicket) => setTasks(prev => prev.map(t => t.id === updatedTicket.id ? updatedTicket : t));
            
            const handleToggleComplete = async (ticket) => {
                const newStatus = !ticket.completed;
                const completedAt = newStatus ? Date.now() : null; 

                setTasks(prev => prev.map(t => t.id === ticket.id ? { ...t, completed: newStatus, completedAt: completedAt } : t));
                
                if (newStatus && settings.tgToken && settings.tgChatId) {
                   const tagStr = ticket.tags && ticket.tags.length > 0 ? ` [${ticket.tags.join(', ')}]` : '';
                   const serialStr = ticket.serial ? `\nğŸ”¢ åºè™Ÿ: \`${ticket.serial}\`` : '';
                   const timeStr = `\nâ° æ™‚é–“: ${formatTime(completedAt)}`;
                   const msg = `âœ… *[å·²æ ¸éŠ·]* ${ticket.productName}\nğŸ“… æœŸé™: ${ticket.expiry || 'ç„¡'}${serialStr}${timeStr}${tagStr}`;
                   sendTelegramMessage(settings.tgToken, settings.tgChatId, msg).catch(e => console.error(e));
                }
            };
            
            const handleDelete = (id) => {
                if(view === 'deleted') { if(confirm("ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ")) setTasks(prev => prev.filter(t => t.id !== id)); }
                else setTasks(prev => prev.map(t => t.id === id ? { ...t, isDeleted: true } : t));
            };
            const handleRestore = (ticket) => setTasks(prev => prev.map(t => t.id === ticket.id ? { ...t, isDeleted: false } : t));
            const handleDeleteTag = (tag) => {
                if(confirm(`åˆªé™¤æ¨™ç±¤ "${tag}"ï¼Ÿ`)) setTasks(prev => prev.map(t => ({ ...t, tags: (t.tags||[]).filter(tt => tt !== tag) })));
            };
            
            const handleBackup = () => {
                const backupData = {
                    version: 3,
                    timestamp: Date.now(),
                    settings: { 
                        tgToken: settings.tgToken, 
                        tgChatId: settings.tgChatId, 
                        notifyDays: settings.notifyDays,
                        appTitle: settings.appTitle
                    },
                    tasks: tasks
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: "application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ticket_backup_full_${new Date().toISOString().split('T')[0]}.json`; a.click();
            };
            
            const handleImport = () => {
                const input = document.createElement('input'); input.type = 'file';
                input.onchange = e => {
                    const r = new FileReader(); 
                    r.onload = ev => { 
                        try { 
                            const data = JSON.parse(ev.target.result);
                            const importedTasks = Array.isArray(data) ? data : (data.tasks || []);
                            
                            let confirmSettings = false;
                            if (!Array.isArray(data) && data.settings) {
                                if (confirm("å‚™ä»½æª”åŒ…å«è¨­å®šè³‡æ–™ (APPæ¨™é¡Œã€Telegram Token ç­‰)ï¼Œæ˜¯å¦ä¸€ä½µé‚„åŸï¼Ÿ")) {
                                    setSettings(prev => ({...prev, ...data.settings}));
                                    confirmSettings = true;
                                }
                            }
                            
                            const mode = prompt("è«‹é¸æ“‡åŒ¯å…¥æ¨¡å¼ï¼š\n1. æ·»åŠ  (ä¿ç•™ç¾æœ‰è³‡æ–™ä¸¦æ–°å¢)\n2. è¦†è“‹ (æ¸…ç©ºç¾æœ‰è³‡æ–™å¾ŒåŒ¯å…¥)", "1");
                            
                            if (mode === '1') {
                                setTasks(prev => [...prev, ...importedTasks]);
                                alert(`åŒ¯å…¥æˆåŠŸ (æ·»åŠ æ¨¡å¼)ï¼æ–°å¢ ${importedTasks.length} ç­†ç¥¨åˆ¸${confirmSettings ? ' (å«è¨­å®š)' : ''}`);
                            } else if (mode === '2') {
                                if(confirm("ç¢ºå®šè¦è¦†è“‹å—ï¼Ÿç¾æœ‰è³‡æ–™å°‡æœƒéºå¤±ï¼")) {
                                    setTasks(importedTasks);
                                    alert(`åŒ¯å…¥æˆåŠŸ (è¦†è“‹æ¨¡å¼)ï¼å…± ${importedTasks.length} ç­†ç¥¨åˆ¸${confirmSettings ? ' (å«è¨­å®š)' : ''}`);
                                }
                            } else {
                                if(mode !== null) alert("å–æ¶ˆåŒ¯å…¥");
                            }

                        } catch(e){alert("æ ¼å¼éŒ¯èª¤");} 
                    };
                    r.readAsText(e.target.files[0]);
                }; input.click();
            };
            
            const handleSelect = (id) => {
                const newSet = new Set(selectedIds);
                if(newSet.has(id)) newSet.delete(id); else newSet.add(id);
                setSelectedIds(newSet);
            };

            const handleSelectAll = () => {
                if(selectedIds.size === filteredTasks.length) {
                    setSelectedIds(new Set());
                } else {
                    setSelectedIds(new Set(filteredTasks.map(t => t.id)));
                }
            }
            
            const handleBatchAddTag = (tagsToAdd) => {
                setTasks(prev => prev.map(t => {
                    if (selectedIds.has(t.id)) {
                        const newTags = new Set([...(t.tags || []), ...tagsToAdd]);
                        return { ...t, tags: Array.from(newTags) };
                    }
                    return t;
                }));
                setSelectedIds(new Set());
                setIsSelectionMode(false);
            };

            return (
                <div className="max-w-md mx-auto bg-white min-h-screen relative pb-28 shadow-2xl sm:border-x border-slate-200">
                    <Header 
                        appTitle={settings.appTitle}
                        onTitleChange={(t) => setSettings(s => ({...s, appTitle: t}))}
                        onOpenSettings={() => setShowSettings(true)}
                        onOpenMenu={() => {
                            const action = prompt("1.å®Œæ•´å‚™ä»½(å«è¨­å®š) 2.åŒ¯å…¥é‚„åŸ 3.æ¸…ç©ºè³‡æ–™");
                            if(action==='1') handleBackup(); if(action==='2') handleImport(); if(action==='3' && confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) setTasks([]);
                        }}
                        sortType={sortType} setSortType={setSortType}
                        searchQuery={searchQuery} setSearchQuery={setSearchQuery}
                        isSelectionMode={isSelectionMode} setIsSelectionMode={setIsSelectionMode}
                        selectedCount={selectedIds.size}
                        onSelectAll={handleSelectAll}
                    />
                    
                    <TagTabs activeTag={activeTag} setActiveTag={setActiveTag} tags={allTags} onManageTags={() => setShowTagManager(true)}/>
                    
                    <div className="pb-8 min-h-[50vh] bg-slate-50 pt-2">
                        {filteredTasks.length > 0 ? (
                            filteredTasks.map(ticket => (
                                <TicketCard 
                                    key={ticket.id} ticket={ticket} 
                                    onClick={setSelectedTicket} notifyDays={settings.notifyDays}
                                    isSelectionMode={isSelectionMode} isSelected={selectedIds.has(ticket.id)} onSelect={handleSelect}
                                    isDuplicate={duplicateSerials.has(ticket.serial)}
                                />
                            ))
                        ) : (
                            <div className="text-center py-24 text-slate-300">
                                <i className="fas fa-ticket-alt text-5xl mb-4 opacity-30"></i>
                                <p className="font-bold">æš«ç„¡ç¥¨åˆ¸</p>
                            </div>
                        )}
                    </div>

                    {/* FAB / Selection Actions */}
                    {isSelectionMode ? (
                        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 flex gap-3 z-40 animate-slide-up">
                            {selectedIds.size > 0 && (
                                <>
                                    <button onClick={() => setShowBatchModal(true)} className="bg-sky-500 hover:bg-sky-600 text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-sky-200 flex items-center gap-2 transition-transform active:scale-95">
                                        <Tag size={18}/> æ‰¹é‡æ¨™ç±¤
                                    </button>
                                    <button onClick={() => {
                                        if(confirm(`ç¢ºå®šåˆªé™¤ ${selectedIds.size} é …ç›®ï¼Ÿ`)) {
                                            if(view === 'deleted') setTasks(prev => prev.filter(t => !selectedIds.has(t.id)));
                                            else setTasks(prev => prev.map(t => selectedIds.has(t.id) ? { ...t, isDeleted: true } : t));
                                            setSelectedIds(new Set()); setIsSelectionMode(false);
                                        }
                                    }} className="bg-white text-red-500 border border-red-100 px-4 py-3 rounded-2xl font-bold shadow-lg flex items-center gap-2 hover:bg-red-50">
                                        <Trash2 size={18}/>
                                    </button>
                                </>
                            )}
                            <button onClick={() => {setIsSelectionMode(false); setSelectedIds(new Set());}} className="bg-slate-800 text-white px-4 py-3 rounded-2xl font-bold shadow-lg">å–æ¶ˆ</button>
                        </div>
                    ) : (
                        <button onClick={() => setShowAddModal(true)} className="fixed bottom-24 right-5 w-16 h-16 bg-sky-500 text-white rounded-[24px] shadow-2xl shadow-sky-300 flex items-center justify-center text-3xl active:scale-90 transition-transform z-40 hover:bg-sky-600 hover:rotate-90 duration-300">
                            <Plus size={32}/>
                        </button>
                    )}

                    <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-100 pb-safe pt-2 px-6 flex justify-around items-end z-40 h-[80px] sm:max-w-md sm:mx-auto">
                        <button onClick={() => setView('active')} className={`flex flex-col items-center gap-1.5 w-16 mb-3 transition-all ${view === 'active' ? 'text-sky-500 scale-110' : 'text-slate-300 hover:text-slate-400'}`}><ListTodo size={26} strokeWidth={view==='active'?3:2}/><span className="text-[10px] font-bold">å¾…ä½¿ç”¨</span></button>
                        <button onClick={() => setView('completed')} className={`flex flex-col items-center gap-1.5 w-16 mb-3 transition-all ${view === 'completed' ? 'text-emerald-500 scale-110' : 'text-slate-300 hover:text-slate-400'}`}><CheckCircle2 size={26} strokeWidth={view==='completed'?3:2}/><span className="text-[10px] font-bold">å·²ä½¿ç”¨</span></button>
                        <button onClick={() => setView('deleted')} className={`flex flex-col items-center gap-1.5 w-16 mb-3 transition-all ${view === 'deleted' ? 'text-red-500 scale-110' : 'text-slate-300 hover:text-slate-400'}`}><Trash size={26} strokeWidth={view==='deleted'?3:2}/><span className="text-[10px] font-bold">å›æ”¶æ¡¶</span></button>
                    </div>

                    <AddTicketModal isOpen={showAddModal} onClose={() => setShowAddModal(false)} onAddBatch={handleAddBatch} allTags={allTags} />
                    <RedeemModal ticket={selectedTicket} onClose={() => setSelectedTicket(null)} onToggleComplete={handleToggleComplete} onDelete={handleDelete} onRestore={handleRestore} onUpdate={handleUpdate} allTags={allTags} />
                    <SettingsModal 
                        isOpen={showSettings} onClose={() => setShowSettings(false)} 
                        {...settings} setTgToken={t => setSettings(s=>({...s, tgToken:t}))} setTgChatId={t => setSettings(s=>({...s, tgChatId:t}))} setNotifyDays={t => setSettings(s=>({...s, notifyDays:t}))} onSave={setSettings}
                    />
                    <TagManagerModal isOpen={showTagManager} onClose={() => setShowTagManager(false)} tags={allTags} onDeleteTag={handleDeleteTag} />
                    <BatchEditModal isOpen={showBatchModal} onClose={() => setShowBatchModal(false)} selectedCount={selectedIds.size} onAddTag={handleBatchAddTag} allTags={allTags} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


