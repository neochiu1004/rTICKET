<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Á•®Âà∏ÁÆ°ÂÆ∂ Pro (Wallet UI)</title>

    <!-- 1. ÂºïÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. ÂºïÂÖ• Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. ÂºïÂÖ•Êú¨Âú∞Áπ™Ë£ΩÊ¢ùÁ¢ºËàáQR CodeÁöÑÂáΩÂºèÂ∫´ -->
    <script src="https://cdn.jsdelivr.net/npm/bwip-js@3.0.4/dist/bwip-js-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <!-- 4. Ë®≠ÂÆö Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>

    <!-- Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'Noto Sans TC', 'sans-serif'],
                        kai: ['Ê®ôÊ•∑È´î', 'Kaiti TC', 'serif']
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 
                        },
                        accent: {
                            50: '#fdf4ff', 500: '#d946ef', 
                        },
                        momo: {
                            DEFAULT: '#ed1a7d', 
                            price: '#d62672',
                            light: '#fdf2f7',
                            dark: '#c41467'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'bounce-sm': 'bounceSmall 0.2s infinite alternate',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        bounceSmall: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(-2px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .ticket-rip-l {
            position: absolute; left: -6px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 12px; border-radius: 50%;
            background-color: transparent; 
            box-shadow: inset -1px 0 2px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .ticket-rip-r {
            position: absolute; right: -6px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 12px; border-radius: 50%;
            background-color: transparent;
            box-shadow: 1px 0 2px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .fullscreen-overlay {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="text-slate-700">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            Trash2, Calendar, Check, Plus, Minus, LogIn, ExternalLink, Tag, RotateCcw,
            CheckCircle2, ListTodo, Clock, StickyNote, Save, X, ScanBarcode,
            Pencil, ClipboardPaste, ArrowRightLeft, Copy, CheckSquare, Trash,
            RefreshCcw, Search, FolderPlus, AlertCircle, MoreVertical, Copy as CopyIcon, Link as LinkIcon,
            ImageIcon, Upload, Clipboard, ClipboardList, AlertTriangle, Download, FileJson, Database, FolderInput,
            LayoutDashboard, Moon, Sun, ChevronUp, ChevronDown, Filter, AlertOctagon, CheckSquareIcon,
            Bell, BellRing, Send, UserCheck, CloudCog, Maximize2, Wand2, WifiOff, FileUp, Replace, FilePlus2, RefreshCw,
            ImagePlus, Heart, HeartHandshake, Eye, EyeOff, Globe, BookOpen, Star, History, MousePointerClick, Layers,
            CalendarX2, CopyPlus, Lightbulb, Loader2, QrCode, SlidersHorizontal, ArrowUpDown, Image, CheckCheck, SendHorizontal, XCircle, Droplets,
            MoveVertical, BoxSelect, Monitor, Palette, Rows, LayoutGrid, ChevronRight, ChevronDown as ChevronDownIcon,
            PanelTop, PaintBucket, Maximize, Move, Eye as PreviewIcon, Info, MapPin, DatabaseBackup, ArchiveRestore, Eraser, Settings2
        } from 'lucide-react';

        // --- 1. Core Logic (Helpers & DB) ---

        const dbHelper = {
            dbName: 'WalletFreshDB',
            storeName: 'kv_store',
            db: null,
            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            },
            async setItem(key, value) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(this.storeName, 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    const request = store.put(value, key);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            async getItem(key) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(this.storeName, 'readonly');
                    const store = tx.objectStore(this.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            async removeItem(key) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(this.storeName, 'readwrite');
                    const store = tx.objectStore(this.storeName);
                    const request = store.delete(key);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        };

        const parseBatchTicketInfo = (text, overrideName) => {
            const results = [];
            const lines = text.split(/\r?\n/);
            lines.forEach((rawLine, index) => {
                const line = rawLine.trim();
                if (!line) return;
                let dateStr = "";
                const dateMatch = line.match(/\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/);
                if (dateMatch) dateStr = dateMatch[0].replace(/[\.\-]/g, '/');
                const lineWithoutDate = line.replace(/\d{4}[\/\-\.]\d{2}[\/\-\.]\d{2}/, '');
                
                let serialStr = "";
                const serialMatch = lineWithoutDate.match(/(?:Âà∏Ëôü|Âà∏ËôüÔºö|Â∫èËôü|CODE|Code|ÂØÜÁ¢º|PIN)[:Ôºö\s]*([A-Za-z0-9\-\s]{8,})/i);
                if (serialMatch && serialMatch[1]) {
                    serialStr = serialMatch[1].trim().replace(/\s/g, '');
                } else {
                    const potentialCodes = lineWithoutDate.match(/[A-Za-z0-9]{9,30}/g);
                    if (potentialCodes) {
                         const validCodes = potentialCodes.filter(code => !/^20\d{6}$/.test(code) && !/^\d{9,15}$/.test(code));
                         if (validCodes.length > 0) serialStr = validCodes[0];
                    }
                }

                if (serialStr) {
                    let finalName = overrideName || "RegexËß£ÊûêÁ•®Âà∏";
                    if (!overrideName) {
                         if (index > 0 && lines[index-1].trim().length > 2) finalName = lines[index-1].trim();
                         else finalName = "Êú™ÂëΩÂêçÁ•®Âà∏";
                    }
                    results.push({
                        id: 'task_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2,5),
                        text: rawLine, originalRaw: rawLine,
                        isTicket: true, serial: serialStr, productName: finalName, expiry: dateStr,
                        tags: [], images: [], image: '', completed: false, isDeleted: false, createdAt: Date.now(), note: '',
                    });
                }
            });
            return results;
        };

        const compressImage = (fileOrUrl) => {
            return new Promise((resolve, reject) => {
                const img = new window.Image();
                img.crossOrigin = "Anonymous";
                
                let objectUrl = null;

                img.onload = () => {
                    if (img.width * img.height > 16000000) {
                        if (objectUrl) URL.revokeObjectURL(objectUrl);
                        reject(new Error("Image resolution too high"));
                        return;
                    }

                    const canvas = document.createElement('canvas');
                    let width = img.width; 
                    let height = img.height;
                    
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    if (objectUrl) URL.revokeObjectURL(objectUrl);
                    
                    resolve(canvas.toDataURL('image/webp', 0.8));
                };
                
                img.onerror = (err) => {
                    if (objectUrl) URL.revokeObjectURL(objectUrl);
                    reject(err);
                };

                if (typeof fileOrUrl === 'string') {
                    img.src = fileOrUrl;
                } else { 
                    objectUrl = URL.createObjectURL(fileOrUrl);
                    img.src = objectUrl;
                }
            });
        };

        const checkIsExpiringSoon = (expiryStr, thresholdDays = 7) => {
            if (!expiryStr) return false;
            const normalizedDate = expiryStr.replace(/[\.\-]/g, '/');
            const expiryDate = new Date(normalizedDate);
            if (isNaN(expiryDate.getTime())) return false;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const diffTime = expiryDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= thresholdDays && diffDays >= -1; 
        };

        const formatTime = (timestamp) => {
            if(!timestamp) return '';
            const d = new Date(timestamp);
            if(isNaN(d.getTime())) return '';
            return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
        };

        const formatDateTime = (timestamp) => {
            if(!timestamp) return '';
            const d = new Date(timestamp);
            if(isNaN(d.getTime())) return '';
            const datePart = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
            const timePart = `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            return `${datePart} ${timePart}`;
        };

        const hexToRgb = (hex) => {
            var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 255, g: 255, b: 255 };
        };

        const sendTelegramMessage = async (token, chatId, text) => {
            if (!token || !chatId) return { success: false, error: 'Missing token or chat_id' };
            try {
                const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(text)}&parse_mode=Markdown`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.ok) {
                    return { success: true };
                } else {
                    return { success: false, error: data.description };
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        };

        // --- 2. UI Components ---

        const QRCodeCanvas = ({ text, size = 180 }) => {
            const canvasRef = useRef(null);
            useEffect(() => { if (canvasRef.current && window.QRious) new window.QRious({ element: canvasRef.current, value: text, size: size, level: 'H' }); }, [text, size]);
            return <canvas ref={canvasRef} className="rounded-2xl shadow-sm border border-slate-100" />;
        };

        const BarcodeCanvas = ({ text }) => {
            const canvasRef = useRef(null);
            useEffect(() => { if (canvasRef.current && window.bwipjs) try { window.bwipjs.toCanvas(canvasRef.current, { bcid: 'code128', text: text, scale: 3, height: 10, includetext: true, textxalign: 'center' }); } catch (e) {} }, [text]);
            return <canvas ref={canvasRef} className="max-w-full h-auto rounded-lg shadow-sm border border-slate-100 bg-white p-1" />;
        };

        const TagSelectInput = ({ allTags, selectedTags, onTagsChange, extraSuggestions = [] }) => {
            const [inputVal, setInputVal] = useState('');
            
            const availableSuggestions = useMemo(() => {
                return [...new Set([...allTags, ...(extraSuggestions || [])])];
            }, [allTags, extraSuggestions]);

            const handleAdd = (tag) => {
                if(!selectedTags.includes(tag)) onTagsChange([...selectedTags, tag]);
                setInputVal('');
            };
            const handleRemove = (tag, e) => {
                e.preventDefault(); 
                e.stopPropagation();
                onTagsChange(selectedTags.filter(t => t !== tag));
            };
            return (
                <div className="space-y-2">
                    <div className="flex flex-wrap gap-2">
                        {selectedTags.map(tag => (
                            <span key={tag} className="bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                {tag} <button type="button" onClick={(e) => handleRemove(tag, e)} className="hover:text-sky-900 p-0.5 rounded-full hover:bg-sky-200"><X size={12}/></button>
                            </span>
                        ))}
                    </div>
                    <div className="flex gap-2 relative">
                        <input value={inputVal} onChange={e => setInputVal(e.target.value)} placeholder="Êñ∞Â¢ûÊ®ôÁ±§..." className="flex-1 p-3 bg-slate-50 rounded-xl text-sm border-none focus:ring-2 focus:ring-sky-400 outline-none" onKeyDown={e => { if(e.key === 'Enter' && inputVal.trim()) handleAdd(inputVal.trim()); }} />
                        <button onClick={() => inputVal.trim() && handleAdd(inputVal.trim())} className="bg-sky-500 text-white p-3 rounded-xl hover:bg-sky-600 transition-colors"><Plus size={18}/></button>
                        {inputVal && (
                            <div className="absolute top-full mt-2 w-full bg-white border border-slate-100 rounded-xl shadow-xl z-20 max-h-32 overflow-y-auto">
                                {availableSuggestions.filter(t => t.includes(inputVal) && !selectedTags.includes(t)).map(t => (
                                    <button key={t} onClick={() => handleAdd(t)} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-50 font-medium text-slate-600">{t}</button>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        {availableSuggestions.filter(t => !selectedTags.includes(t)).slice(0, 8).map(t => (
                            <button key={t} onClick={() => handleAdd(t)} className="text-xs font-bold bg-slate-100 text-slate-500 px-3 py-1.5 rounded-full whitespace-nowrap hover:bg-slate-200 transition-colors">+ {t}</button>
                        ))}
                    </div>
                </div>
            );
        };

        const defaultViewConfig = {
            backgroundImage: '', 
            headerBackgroundImage: '', 
            cardOpacity: 0.95, 
            bgOpacity: 1, 
            bgPosY: 50, 
            bgSize: 100,
            cardBgColor: '#ffffff',
            cardBorderColor: '#e2e8f0',
            compactHeight: 70,
            compactShowImage: false
        };

        const SettingsModal = ({ isOpen, onClose, settings, bgHistory, onSave, onRemoveHistory, onAddToHistory }) => {
            const [localSettings, setLocalSettings] = useState(settings ? JSON.parse(JSON.stringify(settings)) : {});
            const [currentTab, setCurrentTab] = useState('active');
            const [testStatus, setTestStatus] = useState(null);
            const [newKw, setNewKw] = useState('');
            const headerFileInputRef = useRef(null);
            const galleryInputRef = useRef(null);

            if(!isOpen) return null;

            const currentViewConfig = localSettings.viewConfigs?.[currentTab] || { ...defaultViewConfig };

            const handleGlobalChange = (key, value) => {
                setLocalSettings(prev => ({ ...prev, [key]: value }));
            };

            const handleAddKw = () => {
                if (!newKw.trim()) return;
                const kws = localSettings.specificViewKeywords || [];
                if (!kws.includes(newKw.trim())) {
                    handleGlobalChange('specificViewKeywords', [...kws, newKw.trim()]);
                }
                setNewKw('');
            };

            const handleRemoveKw = (kw) => {
                const kws = localSettings.specificViewKeywords || [];
                handleGlobalChange('specificViewKeywords', kws.filter(k => k !== kw));
            };

            const handleViewConfigChange = (key, value) => {
                setLocalSettings(prev => {
                    let next = { ...prev };
                    let currentView = { ...next.viewConfigs[currentTab] };
                    
                    currentView[key] = value;
                    
                    const imageUrl = currentView.backgroundImage;
                    if (!next.bgConfigMap) next.bgConfigMap = {};
                    
                    if (key === 'backgroundImage' && value) {
                        const sharedConfig = next.bgConfigMap[value];
                        if (sharedConfig) {
                            currentView.bgSize = sharedConfig.bgSize;
                            currentView.bgPosY = sharedConfig.bgPosY;
                        }
                    } else if (imageUrl && (key === 'bgSize' || key === 'bgPosY')) {
                        next.bgConfigMap[imageUrl] = {
                            ...next.bgConfigMap[imageUrl],
                            [key]: value
                        };
                    }
                    
                    next.viewConfigs = { ...next.viewConfigs, [currentTab]: currentView };
                    return next;
                });
            };

            const handleStep = (key, delta, min, max, isViewConfig = true, stepVal = 1) => {
                let currentVal = isViewConfig ? currentViewConfig[key] : localSettings[key];
                let nextVal = parseFloat(currentVal || 0) + (delta * stepVal);
                nextVal = Math.min(max, Math.max(min, nextVal));
                nextVal = Math.round(nextVal * 100) / 100;

                if (isViewConfig) {
                    handleViewConfigChange(key, nextVal);
                } else {
                    handleGlobalChange(key, nextVal);
                }
            };

            const handleSave = () => {
                onSave(localSettings);
                onClose();
            };

            const handleHeaderBgUpload = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    try {
                        const base64 = await compressImage(file);
                        handleViewConfigChange('headerBackgroundImage', base64);
                    } catch(err) { alert("ËôïÁêÜÂúñÁâáÊôÇÁôºÁîüÈåØË™§Ôºö" + err.message); }
                }
            }

            const handleGalleryUpload = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    try {
                        const base64 = await compressImage(file);
                        if(onAddToHistory) onAddToHistory(base64); 
                    } catch(err) { alert("ËôïÁêÜÂúñÁâáÊôÇÁôºÁîüÈåØË™§Ôºö" + err.message); }
                }
            };

            const handleTest = async () => {
                setTestStatus('sending');
                const result = await sendTelegramMessage(localSettings.tgToken, localSettings.tgChatId, "üîî ÈÄôÊòØ‰∏ÄÂâá‰æÜËá™„ÄåÈõ¢Á∑öÁ•®Âà∏ÁÆ°ÂÆ∂„ÄçÁöÑÊ∏¨Ë©¶Ë®äÊÅØ„ÄÇ");
                if (result.success) {
                    setTestStatus('success');
                    setTimeout(() => setTestStatus(null), 3000);
                } else {
                    setTestStatus('error');
                    alert(`ÁôºÈÄÅÂ§±Êïó: ${result.error}`);
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl scale-100 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <h2 className="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800"><CloudCog size={24} className="text-sky-500"/> Á≥ªÁµ±Ë®≠ÂÆö</h2>
                        
                        <div className="space-y-5">
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">ÈÄöÁü•Â§©Êï∏ (Á¥ÖÊ°ÜÈ°ØÁ§∫)</label>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => handleStep('notifyDays', -1, 1, 99, false)} className="w-9 h-9 flex items-center justify-center bg-slate-100 rounded-xl text-slate-500 hover:bg-slate-200 transition-colors"><Minus size={16}/></button>
                                    <input type="number" value={localSettings.notifyDays} onChange={e => handleGlobalChange('notifyDays', e.target.value)} className="flex-1 p-2.5 bg-slate-50 rounded-xl text-sm font-bold text-center text-slate-700 outline-none focus:ring-2 focus:ring-sky-400"/>
                                    <button onClick={() => handleStep('notifyDays', 1, 1, 99, false)} className="w-9 h-9 flex items-center justify-center bg-slate-100 rounded-xl text-slate-500 hover:bg-slate-200 transition-colors"><Plus size={16}/></button>
                                </div>
                            </div>

                            <div className="border-t border-slate-100 pt-4">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block">ÁâπÂÆöÁï´Èù¢Ëß∏ÁôºÈóúÈçµÂ≠ó (MOMOÊ®°Âºè)</label>
                                <div className="flex gap-2 mb-3 pr-1">
                                    <input value={newKw} onChange={e => setNewKw(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAddKw()} placeholder="Ëº∏ÂÖ•ÈóúÈçµÂ≠ó (Â¶Ç: MOMO, 85Â∫¶C)..." className="flex-1 p-2 bg-slate-50 rounded-lg text-sm outline-none border-none focus:ring-1 focus:ring-sky-400 min-w-0"/>
                                    <button onClick={handleAddKw} className="px-4 bg-sky-500 text-white rounded-lg font-bold shrink-0"><Plus size={18}/></button>
                                </div>
                                <div className="flex flex-wrap gap-2 max-h-24 overflow-y-auto no-scrollbar">
                                    {(localSettings.specificViewKeywords || []).map(kw => (
                                        <span key={kw} className="bg-slate-100 text-slate-600 px-2 py-1 rounded-md text-xs font-bold flex items-center gap-1">
                                            {kw} <X size={10} className="cursor-pointer hover:text-red-500" onClick={() => handleRemoveKw(kw)}/>
                                        </span>
                                    ))}
                                    {(!localSettings.specificViewKeywords || localSettings.specificViewKeywords.length === 0) && <span className="text-[10px] text-slate-300">È†êË®≠ÔºöMOMO, 85Â∫¶C</span>}
                                </div>
                            </div>
                            
                            <div className="border-t border-slate-100 pt-4">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block">Â§ñËßÄË®≠ÂÆö</label>
                                
                                <div className="flex bg-slate-100 p-1 rounded-xl mb-4">
                                    {[
                                        {id: 'active', label: 'ÂæÖ‰ΩøÁî®', icon: ListTodo},
                                        {id: 'completed', label: 'Â∑≤‰ΩøÁî®', icon: CheckCircle2},
                                        {id: 'deleted', label: 'ÂõûÊî∂Ê°∂', icon: Trash}
                                    ].map(tab => (
                                        <button 
                                            key={tab.id}
                                            onClick={() => setCurrentTab(tab.id)}
                                            className={`flex-1 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1 transition-all ${currentTab === tab.id ? 'bg-white shadow text-sky-600' : 'text-slate-400 hover:text-slate-600'}`}
                                        >
                                            <tab.icon size={12} /> {tab.label}
                                        </button>
                                    ))}
                                </div>

                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-slate-50 p-3 rounded-xl space-y-2">
                                        <div className="flex justify-between items-center">
                                            <label className="text-xs font-bold text-slate-500 flex items-center gap-1"><PanelTop size={12}/> È†ÇÈÉ®ÂäüËÉΩÂçÄËÉåÊôØ</label>
                                            {currentViewConfig.headerBackgroundImage && (
                                                <button onClick={() => handleViewConfigChange('headerBackgroundImage', '')} className="text-[10px] text-red-500 font-bold hover:underline">ÁßªÈô§</button>
                                            )}
                                        </div>
                                        <div className="flex gap-2 items-center">
                                            <div className="w-10 h-10 rounded-lg bg-slate-200 bg-cover bg-center border border-slate-300 flex-shrink-0" style={{backgroundImage: currentViewConfig.headerBackgroundImage ? `url(${currentViewConfig.headerBackgroundImage})` : 'none'}}></div>
                                            <button onClick={() => headerFileInputRef.current?.click()} className="flex-1 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50">
                                                Êõ¥ÊèõÂúñÁâá
                                            </button>
                                            <input type="file" ref={headerFileInputRef} accept="image/*" onChange={handleHeaderBgUpload} className="hidden" />
                                        </div>
                                    </div>

                                    <div>
                                        <div className="text-xs font-bold text-slate-500 mb-2 flex justify-between">
                                            <span>ÊõæÁ∂ì‰ΩøÁî®ÁöÑËÉåÊôØ (‰∏ªÁï´Èù¢)</span>
                                            {bgHistory.length === 0 && <span className="text-slate-300 font-normal">Â∞öÁÑ°Á¥ÄÈåÑ</span>}
                                        </div>
                                        <div className="grid grid-cols-4 gap-2 mb-2">
                                            <div 
                                                onClick={() => galleryInputRef.current?.click()}
                                                className="w-full h-12 rounded-lg bg-sky-50 border border-dashed border-sky-200 text-sky-500 hover:bg-sky-100 hover:border-sky-300 flex items-center justify-center cursor-pointer transition-colors"
                                                title="‰∏äÂÇ≥ÂúñÁâáÂà∞Ê≠§ÂàóË°®"
                                            >
                                                <Plus size={16} strokeWidth={3} />
                                                <input type="file" ref={galleryInputRef} accept="image/*" onChange={handleGalleryUpload} className="hidden" />
                                            </div>

                                            {bgHistory.map((bgUrl, idx) => (
                                                <div key={idx} className="relative group">
                                                    <button 
                                                        onClick={() => handleViewConfigChange('backgroundImage', bgUrl)}
                                                        className="w-full h-12 rounded-lg bg-cover bg-center border border-slate-200 hover:scale-105 transition-transform shadow-sm"
                                                        style={{ backgroundImage: `url(${bgUrl})` }}
                                                    >
                                                        {currentViewConfig.backgroundImage === bgUrl && (
                                                            <div className="absolute inset-0 bg-black/40 flex items-center justify-center rounded-lg">
                                                                <Check size={16} className="text-white"/>
                                                            </div>
                                                        )}
                                                    </button>
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); onRemoveHistory(bgUrl); }}
                                                        className="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"
                                                        title="ÁßªÈô§Ê≠§Á¥ÄÈåÑ"
                                                    >
                                                        <X size={10}/>
                                                    </button>
                                                </div>
                                            ))}
                                            <button 
                                                onClick={() => handleViewConfigChange('backgroundImage', '')}
                                                className="w-full h-12 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-200 text-xs font-bold"
                                                title="‰ΩøÁî®Á¥îÁôΩËÉåÊôØ"
                                            >
                                                ÁÑ°
                                            </button>
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 p-3 rounded-xl space-y-3">
                                        {currentViewConfig.backgroundImage && (
                                            <div className="w-32 aspect-[3/5] mx-auto bg-slate-200 rounded-xl border border-slate-300 relative overflow-hidden flex items-center justify-center shadow-inner">
                                                <div 
                                                    className="absolute inset-0 w-full h-full pointer-events-none transition-all duration-75"
                                                    style={{
                                                        backgroundImage: `url(${currentViewConfig.backgroundImage})`,
                                                        backgroundSize: `${currentViewConfig.bgSize || 100}% auto`,
                                                        backgroundPosition: `center ${currentViewConfig.bgPosY || 50}%`,
                                                        backgroundRepeat: 'no-repeat',
                                                        opacity: currentViewConfig.bgOpacity || 1
                                                    }}
                                                />
                                                <div className="absolute top-1 right-1 bg-black/40 backdrop-blur-sm text-white text-[9px] px-1.5 py-0.5 rounded-lg font-bold flex items-center gap-1 shadow-sm">
                                                    <PreviewIcon size={8}/> È†êË¶Ω
                                                </div>
                                            </div>
                                        )}

                                        <div>
                                            <div className="flex justify-between items-center mb-1">
                                                <label className="text-xs font-bold text-slate-500 flex items-center gap-1"><Maximize size={12}/> ËÉåÊôØÁ∏ÆÊîæ (ÂØ¨Â∫¶ %)</label>
                                                <span className="text-xs font-bold text-sky-600">{currentViewConfig.bgSize || 100}%</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => handleStep('bgSize', -1, 50, 300, true, 5)} className="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-sky-500 hover:border-sky-200 transition-all"><Minus size={14}/></button>
                                                <input 
                                                    type="range" min="50" max="300" step="5"
                                                    value={currentViewConfig.bgSize || 100}
                                                    onChange={(e) => handleViewConfigChange('bgSize', parseInt(e.target.value))}
                                                    className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"
                                                />
                                                <button onClick={() => handleStep('bgSize', 1, 50, 300, true, 5)} className="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-sky-500 hover:border-sky-200 transition-all"><Plus size={14}/></button>
                                            </div>
                                        </div>

                                        <div>
                                            <div className="flex justify-between items-center mb-1">
                                                <label className="text-xs font-bold text-slate-500 flex items-center gap-1"><Move size={12}/> ËÉåÊôØÂûÇÁõ¥‰ΩçÁΩÆ</label>
                                                <span className="text-xs font-bold text-sky-600">{currentViewConfig.bgPosY || 50}%</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => handleStep('bgPosY', -1, 0, 100, true, 1)} className="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-sky-500 hover:border-sky-200 transition-all"><Minus size={14}/></button>
                                                <input 
                                                    type="range" min="0" max="100" step="1"
                                                    value={currentViewConfig.bgPosY || 50}
                                                    onChange={(e) => handleViewConfigChange('bgPosY', parseInt(e.target.value))}
                                                    className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"
                                                />
                                                <button onClick={() => handleStep('bgPosY', 1, 0, 100, true, 1)} className="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-sky-500 hover:border-sky-200 transition-all"><Plus size={14}/></button>
                                            </div>
                                        </div>

                                        <div>
                                            <div className="flex justify-between items-center mb-2">
                                                <label className="text-xs font-bold text-slate-500 flex items-center gap-1"><Droplets size={12}/> ËÉåÊôØÈÄèÊòéÂ∫¶</label>
                                                <span className="text-xs font-bold text-sky-600">{Math.round((currentViewConfig.bgOpacity || 1) * 100)}%</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => handleStep('bgOpacity', -1, 0, 1, true, 0.05)} className="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-sky-500 hover:border-sky-200 transition-all"><Minus size={14}/></button>
                                                <input 
                                                    type="range" min="0" max="100" step="5" 
                                                    value={Math.round((currentViewConfig.bgOpacity || 1) * 100)} 
                                                    onChange={(e) => handleViewConfigChange('bgOpacity', (parseInt(e.target.value) / 100))}
                                                    className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"
                                                />
                                                <button onClick={() => handleStep('bgOpacity', 1, 0, 1, true, 0.05)} className="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-sky-500 hover:border-sky-200 transition-all"><Plus size={14}/></button>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 p-3 rounded-xl space-y-3">
                                        <div className="flex justify-between items-center">
                                            <label className="text-xs font-bold text-slate-500 flex items-center gap-1"><Palette size={12}/> Âç°ÁâáÂ∫ïËâ≤</label>
                                            <div className="flex items-center gap-2">
                                                <span className="text-[10px] font-mono text-slate-400">{currentViewConfig.cardBgColor}</span>
                                                <input 
                                                    type="color" 
                                                    value={currentViewConfig.cardBgColor}
                                                    onChange={e => handleViewConfigChange('cardBgColor', e.target.value)}
                                                    className="w-6 h-6 rounded overflow-hidden border-none outline-none cursor-pointer"
                                                />
                                            </div>
                                        </div>

                                        <div className="flex justify-between items-center">
                                            <label className="text-xs font-bold text-slate-500 flex items-center gap-1"><PaintBucket size={12}/> Âç°ÁâáÈÇäÊ°Ü</label>
                                            <div className="flex items-center gap-2">
                                                <span className="text-[10px] font-mono text-slate-400">{currentViewConfig.cardBorderColor || '#e2e8f0'}</span>
                                                <input 
                                                    type="color" 
                                                    value={currentViewConfig.cardBorderColor || '#e2e8f0'}
                                                    onChange={e => handleViewConfigChange('cardBorderColor', e.target.value)}
                                                    className="w-6 h-6 rounded overflow-hidden border-none outline-none cursor-pointer"
                                                />
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <div className="flex justify-between items-center mb-2">
                                                <label className="text-xs font-bold text-slate-500 flex items-center gap-1"><Droplets size={12}/> Âç°ÁâáÈÄèÊòéÂ∫¶</label>
                                                <span className="text-xs font-bold text-sky-600">{Math.round((1 - currentViewConfig.cardOpacity) * 100)}%</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => handleStep('cardOpacity', 1, 0, 1, true, 0.05)} className="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-sky-500 hover:border-sky-200 transition-all"><Minus size={14}/></button>
                                                <input 
                                                    type="range" 
                                                    min="0" 
                                                    max="100" 
                                                    step="5" 
                                                    value={Math.round((1 - currentViewConfig.cardOpacity) * 100)} 
                                                    onChange={(e) => handleViewConfigChange('cardOpacity', 1 - (parseInt(e.target.value) / 100))}
                                                    className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"
                                                />
                                                <button onClick={() => handleStep('cardOpacity', -1, 0, 1, true, 0.05)} className="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-sky-500 hover:border-sky-200 transition-all"><Plus size={14}/></button>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 p-3 rounded-xl space-y-3">
                                        <div className="flex justify-between items-center">
                                            <label className="text-xs font-bold text-slate-500 flex items-center gap-1"><Rows size={12}/> ÂàóË°®Ê®°ÂºèÈ´òÂ∫¶</label>
                                            <span className="text-xs font-bold text-sky-600">{currentViewConfig.compactHeight || 70}px</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => handleStep('compactHeight', -1, 40, 150, true, 5)} className="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-sky-500 hover:border-sky-200 transition-all"><Minus size={14}/></button>
                                            <input 
                                                type="range" min="40" max="150" step="5"
                                                value={currentViewConfig.compactHeight || 70}
                                                onChange={(e) => handleViewConfigChange('compactHeight', parseInt(e.target.value))}
                                                className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sky-500"
                                            />
                                            <button onClick={() => handleStep('compactHeight', 1, 40, 150, true, 5)} className="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-sky-500 hover:border-sky-200 transition-all"><Plus size={14}/></button>
                                        </div>

                                        <div className="flex justify-between items-center mt-2">
                                            <label className="text-xs font-bold text-slate-500 flex items-center gap-1"><ImageIcon size={12}/> ÂàóË°®È°ØÁ§∫ÂúñÁâá</label>
                                            <button 
                                                onClick={() => handleViewConfigChange('compactShowImage', !currentViewConfig.compactShowImage)}
                                                className={`w-10 h-5 rounded-full relative transition-colors ${currentViewConfig.compactShowImage ? 'bg-sky-500' : 'bg-slate-300'}`}
                                            >
                                                <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${currentViewConfig.compactShowImage ? 'left-6' : 'left-1'}`}></div>
                                            </button>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div className="border-t border-slate-100 pt-4">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Telegram Bot Token</label>
                                <input type="text" value={localSettings.tgToken} onChange={e => handleGlobalChange('tgToken', e.target.value)} placeholder="123456:ABC-DEF..." className="w-full p-3 bg-slate-50 rounded-xl text-sm font-mono text-slate-600 outline-none focus:ring-2 focus:ring-sky-400"/>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Telegram Chat ID</label>
                                <input type="text" value={localSettings.tgChatId} onChange={e => handleGlobalChange('tgChatId', e.target.value)} placeholder="-123456789" className="w-full p-3 bg-slate-50 rounded-xl text-sm font-mono text-slate-600 outline-none focus:ring-2 focus:ring-sky-400"/>
                            </div>
                            
                            <button onClick={handleTest} disabled={!localSettings.tgToken || !localSettings.tgChatId || testStatus === 'sending'} 
                                className={`w-full py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-2 transition-all ${testStatus === 'success' ? 'bg-emerald-100 text-emerald-600' : testStatus === 'error' ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                {testStatus === 'sending' ? <Loader2 size={14} className="animate-spin"/> : testStatus === 'success' ? <Check size={14}/> : <SendHorizontal size={14}/>}
                                {testStatus === 'sending' ? 'ÂÇ≥ÈÄÅ‰∏≠...' : testStatus === 'success' ? 'Ê∏¨Ë©¶ÊàêÂäü' : testStatus === 'error' ? 'Ê∏¨Ë©¶Â§±Êïó' : 'Ê∏¨Ë©¶ÂÇ≥ÈÄÅ'}
                            </button>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-5 py-2.5 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">ÂèñÊ∂à</button>
                            <button onClick={handleSave} className="px-6 py-2.5 bg-sky-500 hover:bg-sky-600 text-white rounded-xl font-bold shadow-lg shadow-sky-200 transition-all active:scale-95">ÂÑ≤Â≠òË®≠ÂÆö</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DataActionsModal = ({ isOpen, onClose, onBackup, onImportClick, onReset }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl space-y-4" onClick={e => e.stopPropagation()}>
                        <h2 className="text-lg font-black text-slate-800 text-center mb-2">Ë≥áÊñôÁÆ°ÁêÜ</h2>
                        <button onClick={onBackup} className="w-full py-4 bg-sky-50 text-sky-600 rounded-2xl font-bold flex flex-col items-center gap-1 hover:bg-sky-100 transition-colors">
                            <DatabaseBackup size={24} /> ÂåØÂá∫ÂÇô‰ªΩ (JSON)
                        </button>
                        <button onClick={onImportClick} className="w-full py-4 bg-emerald-50 text-emerald-600 rounded-2xl font-bold flex flex-col items-center gap-1 hover:bg-emerald-100 transition-colors">
                            <ArchiveRestore size={24} /> ÂåØÂÖ•ÈÇÑÂéü
                        </button>
                        <button onClick={onReset} className="w-full py-4 bg-slate-50 text-slate-500 rounded-2xl font-bold flex flex-col items-center gap-1 hover:bg-red-50 hover:text-red-500 transition-colors">
                            <Eraser size={24} /> Ê∏ÖÁ©∫/ÈáçÁΩÆ
                        </button>
                        <button onClick={onClose} className="w-full py-3 text-slate-400 font-bold text-sm mt-2">ÂèñÊ∂à</button>
                    </div>
                </div>
            );
        };

        const ImportConfirmModal = ({ isOpen, data, onConfirm, onCancel }) => {
            if (!isOpen || !data) return null;
            const [mode, setMode] = useState('append');
            const [restoreSettings, setRestoreSettings] = useState(false);
            const count = Array.isArray(data) ? data.length : (data.tasks || []).length;
            const hasSettings = !!data.settings;

            return (
                <div className="fixed inset-0 bg-slate-900/60 z-[60] flex items-center justify-center p-6 backdrop-blur-md animate-fade-in" onClick={onCancel}>
                    <div className="bg-white w-full max-sm rounded-[32px] p-6 shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-sky-50 text-sky-500 rounded-full flex items-center justify-center mx-auto mb-3">
                                <FileJson size={32}/>
                            </div>
                            <h2 className="text-xl font-black text-slate-800">Ê∫ñÂÇôÂåØÂÖ•Ë≥áÊñô</h2>
                            <p className="text-sm text-slate-400 font-bold mt-1">ÂÅµÊ∏¨Âà∞ {count} Á≠ÜÁ•®Âà∏Ë≥áÊñô</p>
                        </div>
                        <div className="space-y-4">
                            <div className="flex bg-slate-100 p-1 rounded-2xl">
                                <button onClick={() => setMode('append')} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${mode === 'append' ? 'bg-white shadow text-sky-600' : 'text-slate-400 hover:text-slate-600'}`}>Ê∑ªÂä†</button>
                                <button onClick={() => setMode('overwrite')} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${mode === 'overwrite' ? 'bg-white shadow text-red-500' : 'text-slate-400 hover:text-slate-600'}`}>Ë¶ÜËìã</button>
                            </div>
                            {hasSettings && (
                                <label className="flex items-center gap-3 p-4 bg-slate-50 rounded-2xl cursor-pointer">
                                    <div className={`w-5 h-5 rounded-md border-2 flex items-center justify-center transition-all ${restoreSettings ? 'bg-sky-500 border-sky-500' : 'border-slate-300 bg-white'}`}>
                                        {restoreSettings && <Check size={14} className="text-white"/>}
                                    </div>
                                    <input type="checkbox" className="hidden" checked={restoreSettings} onChange={e => setRestoreSettings(e.target.checked)}/>
                                    <div className="text-sm font-bold text-slate-700">ÈÇÑÂéüË®≠ÂÆö (Ê®ôÈ°å„ÄÅËÉåÊôØÁ≠â)</div>
                                </label>
                            )}
                        </div>
                        <div className="flex gap-3 mt-8">
                            <button onClick={onCancel} className="flex-1 py-3.5 bg-slate-100 text-slate-500 rounded-2xl font-bold">ÂèñÊ∂à</button>
                            <button onClick={() => onConfirm(mode, restoreSettings)} className="flex-1 py-3.5 bg-sky-500 text-white rounded-2xl font-bold shadow-lg shadow-sky-200 active:scale-95">Á¢∫Ë™çÂåØÂÖ•</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Header = ({ 
            appTitle, onTitleChange, onOpenMenu, onOpenSettings, 
            sortType, setSortType, setSearchQuery, searchQuery, 
            isSelectionMode, setIsSelectionMode, selectedCount, onSelectAll, 
            isCompact, setIsCompact, view, setView, activeTag, setActiveTag, allTags,
            onQuickBgChange, headerBackgroundImage 
        }) => (
            <div 
                className="px-4 pt-8 pb-3 shadow-sm sticky top-0 z-40 transition-all rounded-b-[24px] bg-white text-slate-800"
                style={{
                    backgroundImage: headerBackgroundImage ? `url(${headerBackgroundImage})` : 'none',
                    backgroundColor: headerBackgroundImage ? 'transparent' : 'white',
                    backgroundSize: 'cover',
                    backgroundPosition: 'center',
                }}
            >
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center gap-2 group cursor-pointer" onClick={() => {
                        const newTitle = prompt("‰øÆÊîπÊ®ôÈ°åÂêçÁ®±:", appTitle);
                        if(newTitle) onTitleChange(newTitle);
                    }}>
                        <h1 className={`text-2xl font-black tracking-tight ${headerBackgroundImage ? 'drop-shadow-md text-white' : 'drop-shadow-sm'}`}>{appTitle}</h1>
                        <Pencil size={14} className={`${headerBackgroundImage ? 'text-white/70' : 'text-slate-400'} group-hover:text-sky-500 transition-colors`}/>
                    </div>
                    <div className="flex gap-2">
                         <button 
                            onClick={onQuickBgChange} 
                            className="w-9 h-9 rounded-full bg-slate-50/50 border border-slate-100/50 flex items-center justify-center text-slate-500 hover:text-sky-600 hover:bg-white transition-all shadow-sm"
                            title="ÂàáÊèõËÉåÊôØ"
                        >
                            <Palette size={16}/>
                        </button>
                        {isSelectionMode && (
                            <button 
                                onClick={onSelectAll} 
                                className="px-3 py-1.5 rounded-full text-xs font-bold transition-all bg-emerald-100 text-emerald-600 hover:bg-emerald-200 flex items-center gap-1"
                            >
                                <CheckCheck size={14} /> ÂÖ®ÈÅ∏
                            </button>
                        )}
                        <button 
                            onClick={() => setIsSelectionMode(!isSelectionMode)} 
                            className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${isSelectionMode ? 'bg-sky-500 text-white shadow-md' : 'bg-slate-100/80 text-slate-600 hover:bg-slate-200'}`}
                        >
                            {isSelectionMode ? `Â∑≤ÈÅ∏ ${selectedCount}` : 'ÈÅ∏Âèñ'}
                        </button>
                        <button onClick={onOpenSettings} className="w-9 h-9 rounded-full bg-slate-50/50 border border-slate-100/50 flex items-center justify-center text-slate-500 hover:text-sky-600 hover:bg-white transition-all shadow-sm">
                            <Settings2 size={16}/>
                        </button>
                        <button onClick={onOpenMenu} className="w-9 h-9 rounded-full bg-slate-50/50 border border-slate-100/50 flex items-center justify-center text-slate-500 hover:text-sky-600 hover:bg-white transition-all shadow-sm">
                            <MoreVertical size={16}/>
                        </button>
                    </div>
                </div>
                
                <div className="flex flex-col gap-2">
                    <div className="flex gap-2">
                        <div className="relative flex-1 group">
                            <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-sky-500 transition-colors" />
                            <input 
                                value={searchQuery}
                                onChange={e => setSearchQuery(e.target.value)}
                                placeholder="ÊêúÂ∞ã..." 
                                className="w-full pl-10 pr-3 py-2 text-sm bg-slate-50/80 backdrop-blur-sm border border-slate-100 focus:bg-white focus:border-sky-200 rounded-2xl outline-none font-medium text-slate-700 transition-all placeholder:text-slate-400" 
                            />
                        </div>
                        <div className="relative">
                            <select
                                value={activeTag}
                                onChange={(e) => setActiveTag(e.target.value)}
                                className="appearance-none bg-slate-50/80 backdrop-blur-sm border border-slate-100 text-xs font-bold text-slate-600 rounded-2xl h-full pl-3 pr-8 outline-none focus:ring-2 focus:ring-sky-200 hover:bg-slate-100 transition-colors"
                            >
                                <option value="all">ÂÖ®Ê®ôÁ±§</option>
                                <option value="special_expiring">[Ëá™Âãï] Âø´Âà∞Êúü</option>
                                <option value="special_duplicate">[Ëá™Âãï] ÈáçË§áÂ∫èËôü</option>
                                {allTags.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                            <ChevronDown size={14} className="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"/>
                        </div>
                    </div>

                    <div className="flex justify-between items-center gap-2">
                         <div className="flex bg-slate-100/80 backdrop-blur-sm p-1 rounded-2xl">
                            {[
                                {id: 'active', icon: ListTodo, label: 'ÂæÖÁî®'},
                                {id: 'completed', icon: CheckCircle2, label: 'Â∑≤Áî®'},
                                {id: 'deleted', icon: Trash, label: 'ÂõûÊî∂'}
                            ].map(tab => (
                                <button 
                                    key={tab.id}
                                    onClick={() => setView(tab.id)}
                                    className={`px-3 py-1.5 rounded-xl flex items-center gap-1 text-[10px] font-bold transition-all ${view === tab.id ? 'bg-white shadow text-sky-600' : 'text-slate-400 hover:text-slate-600'}`}
                                >
                                    <tab.icon size={12}/> {tab.label}
                                </button>
                            ))}
                        </div>

                        <div className="flex gap-2">
                             <button 
                                onClick={() => {
                                    const types = ['expiring', 'newest', 'oldest'];
                                    const nextIdx = (types.indexOf(sortType) + 1) % types.length;
                                    setSortType(types[nextIdx]);
                                }}
                                className="px-2 h-9 bg-slate-50/80 backdrop-blur-sm hover:bg-slate-100 border border-slate-100 rounded-2xl flex items-center justify-center text-slate-600 transition-all gap-1"
                                title="ÂàáÊèõÊéíÂ∫è"
                            >
                                <ArrowUpDown size={14} className="text-sky-500"/>
                                <span className="text-[10px] font-bold">
                                    {sortType === 'expiring' ? 'Âø´Âà∞Êúü' : sortType === 'newest' ? 'ÊúÄÊñ∞' : 'ÊúÄËàä'}
                                </span>
                            </button>
                            <button 
                                onClick={() => setIsCompact(!isCompact)}
                                className={`w-9 h-9 flex items-center justify-center rounded-full transition-all border ${isCompact ? 'bg-sky-500 text-white border-sky-500' : 'bg-slate-50/80 backdrop-blur-sm text-slate-500 hover:bg-slate-100 border-slate-100'}`}
                                title={isCompact ? "ÂàáÊèõËá≥Â±ïÈñãÊ®°Âºè" : "ÂàáÊèõËá≥ÂàóË°®Ê®°Âºè"}
                            >
                                {isCompact ? <Rows size={16}/> : <LayoutGrid size={16}/>}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );

        const TicketCard = ({ ticket, onClick, notifyDays, isSelectionMode, isSelected, onSelect, isDuplicate, opacity = 0.95, cardBgColor = '#ffffff', cardBorderColor = '#e2e8f0', isCompact, compactHeight = 70, compactShowImage = false }) => {
            const isExpiring = !ticket.completed && ticket.expiry && checkIsExpiringSoon(ticket.expiry, notifyDays);
            const isDuplicateWarning = isDuplicate && !ticket.completed && !ticket.isDeleted;
            const isExpiringWarning = isExpiring && !ticket.completed && !ticket.isDeleted;
            const { r, g, b } = hexToRgb(cardBgColor);
            let bgBase = `rgba(${r}, ${g}, ${b}, ${opacity})`;
            let overlayClass = '';
            let dynamicBorderStyle = {};

            if (isSelected) {
                overlayClass = 'bg-sky-500/10 ring-2 ring-sky-500 border-sky-500';
            } else if (isExpiringWarning) {
                overlayClass = 'bg-red-500/10 border-red-400 shadow-red-100';
            } else {
                overlayClass = 'hover:shadow-md border';
                dynamicBorderStyle = { borderColor: cardBorderColor };
            }
            const duplicateClass = isDuplicateWarning ? 'border-red-500 ring-2 ring-red-100 shadow-red-200' : '';

            if (isCompact) {
                return (
                    <div onClick={() => { if(isSelectionMode) onSelect(ticket.id); else onClick(ticket); }} style={{ backgroundColor: bgBase, height: `${compactHeight}px`, ...(!isSelected && !isExpiringWarning && !isDuplicateWarning ? dynamicBorderStyle : {}) }} className={`backdrop-blur-sm mx-2 mb-1 px-2 rounded-lg shadow-sm flex items-center gap-2 active:scale-[0.98] transition-all cursor-pointer relative overflow-hidden group ${overlayClass} ${duplicateClass}`}>
                        {isSelectionMode && (
                            <div className={`w-4 h-4 flex-shrink-0 rounded-full border-2 flex items-center justify-center transition-all ${isSelected ? 'bg-sky-500 border-sky-500' : 'border-slate-300 bg-white'}`}>
                                {isSelected && <Check size={10} className="text-white"/>}
                            </div>
                        )}
                        {compactShowImage && (
                            <div className="h-full aspect-square py-1 mr-1 flex-shrink-0">
                                {ticket.image ? <img src={ticket.image} className={`w-full h-full object-cover rounded-md ${ticket.completed ? 'grayscale opacity-50' : ''}`} /> : <div className="w-full h-full bg-slate-100 rounded-md flex items-center justify-center border border-slate-200"><i className="fas fa-ticket-alt text-slate-300 text-xs"></i></div>}
                            </div>
                        )}
                        <div className="flex-1 min-w-0 flex flex-col justify-center">
                            <div className="flex items-center gap-2">
                                {isDuplicateWarning && <span className="text-[9px] bg-red-500 text-white px-1.5 py-0.5 rounded font-bold">ÈáçË§á</span>}
                                <h3 className={`font-bold text-slate-800 line-clamp-1 text-sm ${ticket.completed ? 'line-through text-slate-400' : ''}`}>{ticket.productName}</h3>
                            </div>
                            <div className="flex items-center gap-2 mt-0.5">
                                {isExpiringWarning && <span className="text-[9px] font-bold text-red-500 flex items-center gap-0.5"><AlertCircle size={9}/> Âø´Âà∞Êúü</span>}
                                <span className={`text-[10px] font-bold ${ticket.completed ? 'text-emerald-600' : 'text-emerald-500'}`}>{ticket.completed ? `Â∑≤Áî® ${formatTime(ticket.completedAt)}` : (ticket.expiry || 'ÁÑ°ÊúüÈôê')}</span>
                            </div>
                        </div>
                        {!isSelectionMode && <button className={`flex-shrink-0 text-[10px] font-bold px-2 py-0.5 rounded-lg transition-all ${ticket.completed ? 'bg-slate-100 text-slate-500' : 'bg-emerald-100 text-emerald-600 hover:bg-emerald-500 hover:text-white'}`}>{ticket.completed ? 'Êü•Áúã' : 'ÂÖåÊèõ'}</button>}
                    </div>
                );
            }

            return (
                <div onClick={() => { if(isSelectionMode) onSelect(ticket.id); else onClick(ticket); }} style={{ backgroundColor: bgBase, ...(!isSelected && !isExpiringWarning && !isDuplicateWarning ? dynamicBorderStyle : {}) }} className={`backdrop-blur-sm mx-4 mt-4 p-4 rounded-3xl shadow-sm flex gap-4 active:scale-[0.98] transition-all cursor-pointer relative overflow-hidden group ${overlayClass} ${duplicateClass}`}>
                    {isSelectionMode && <div className={`absolute top-3 right-3 z-20 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${isSelected ? 'bg-sky-500 border-sky-500' : 'border-slate-300 bg-white'}`}>{isSelected && <Check size={14} className="text-white"/>}</div>}
                    {isDuplicateWarning && <div className="absolute top-0 left-0 bg-red-500 text-white text-[9px] px-2 py-0.5 rounded-br-lg z-20 font-bold">ÈáçË§áÂ∫èËôü</div>}
                    <div className="w-20 h-20 flex-shrink-0 rounded-2xl flex items-center justify-center overflow-hidden relative group-hover:scale-105 transition-transform">
                        {ticket.image ? <img src={ticket.image} className={`w-full h-full object-cover ${ticket.completed ? 'grayscale opacity-50' : ''}`} /> : <i className="fas fa-ticket-alt text-slate-300 text-2xl"></i>}
                        {ticket.images && ticket.images.length > 1 && <div className="absolute bottom-0 right-0 bg-black/60 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-tl-lg">+{ticket.images.length-1}</div>}
                    </div>
                    <div className="flex-1 flex flex-col justify-between py-1 min-w-0">
                        <div>
                            <div className="flex justify-between items-start pr-6">
                                <h3 className={`font-bold text-slate-800 line-clamp-1 text-[15px] ${ticket.completed ? 'line-through text-slate-400' : ''}`}>{ticket.productName}</h3>
                                {ticket.completed && <span className="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold">Â∑≤‰ΩøÁî®</span>}
                            </div>
                            {isExpiringWarning && <div className="text-[10px] font-bold text-red-500 mt-1 flex items-center gap-1 animate-pulse"><AlertCircle size={10}/> Âø´Âà∞Êúü</div>}
                            <div className="flex gap-1.5 mt-2 overflow-x-auto no-scrollbar">
                                {ticket.tags && ticket.tags.map(t => <span key={t} className="text-[10px] bg-sky-50 text-sky-600 px-2 py-0.5 rounded-md font-bold whitespace-nowrap">{t}</span>)}
                                {!ticket.tags?.length && <span className="text-[10px] text-slate-300 font-bold">#</span>}
                            </div>
                        </div>
                        <div className="flex justify-between items-end mt-2">
                            {ticket.completed && ticket.completedAt ? <div className="text-[10px] font-bold text-emerald-600 flex items-center gap-1 bg-emerald-50 px-2 py-0.5 rounded-lg"><CheckCircle2 size={10}/> <span>Ê†∏Èä∑Êñº {formatDateTime(ticket.completedAt)}</span></div> : <div className={`text-xs font-bold flex items-center gap-1.5 ${isExpiring ? 'text-red-500' : 'text-emerald-500'}`}><Clock size={12}/> <span>{ticket.expiry || 'ÁÑ°ÊúüÈôê'}</span></div>}
                            {!isSelectionMode && <button className={`text-sm font-bold px-5 py-2.5 rounded-2xl shadow-sm transition-all active:scale-95 ${ticket.completed ? 'bg-slate-100 text-slate-500' : 'bg-emerald-100 text-emerald-600 hover:bg-emerald-500 hover:text-white shadow-emerald-100'}`}>{ticket.completed ? 'Êü•Áúã' : 'ÂÖåÊèõ'}</button>}
                        </div>
                    </div>
                    <div className="ticket-rip-l" style={{backgroundColor: 'transparent', boxShadow: 'none', borderLeft: '6px solid transparent'}}></div> 
                </div>
            );
        };

        const MomoTemplate = ({ ticket }) => {
            return (
                <div className="w-full h-full flex flex-col bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-2xl animate-fade-in text-left">
                    <div className="bg-momo px-4 py-2.5 flex justify-between items-center text-white shrink-0">
                        <div className="flex items-center gap-2"><img alt="momo" src="https://www.momoshop.com.tw/writeOff/resources/images/momologo.png" className="h-4 w-auto brightness-0 invert"/><span className="text-[11px] font-black tracking-widest opacity-90">ÈõªÂ≠êÁ•®Âà∏ÊòéÁ¥∞</span></div>
                        <Info size={14} className="opacity-60" />
                    </div>
                    <div className="flex-1 overflow-y-auto no-scrollbar">
                        <div className="p-3 space-y-3">
                            <div className="flex gap-3">
                                <div className="w-20 h-20 shrink-0 border border-slate-100 rounded-lg overflow-hidden bg-slate-50 flex items-center justify-center">{ticket.image ? <img src={ticket.image} className="w-full h-full object-cover" /> : <ImageIcon className="text-slate-200" size={24} />}</div>
                                <div className="flex-1 min-w-0 flex flex-col justify-center"><h2 className="text-[15px] font-black text-slate-800 leading-tight line-clamp-2">{ticket.productName}</h2>
                                </div>
                            </div>
                            <div className="relative border-t border-dashed border-slate-200 my-1"><div className="absolute -left-5 -top-1.5 w-3 h-3 bg-white rounded-full border border-slate-100"></div><div className="absolute -right-5 -top-1.5 w-3 h-3 bg-white rounded-full border border-slate-100"></div></div>
                            <div className="bg-slate-50/50 rounded-xl p-3 flex flex-col items-center gap-3">
                                <div className="w-full px-2"><BarcodeCanvas text={ticket.serial} /></div>
                                <div className="p-1.5 bg-white border border-slate-100 rounded-lg shadow-sm"><QRCodeCanvas text={ticket.serial} size={110} /></div>
                                <div className="text-center"><p className="text-[10px] font-bold text-slate-400 mb-0.5">ÈõªÂ≠êÂà∏Ëôü</p><p className="text-[13px] font-mono font-black text-slate-700 tracking-wider break-all px-4">{ticket.serial}</p></div>
                            </div>
                            <div className="space-y-1.5 px-1">
                                <div className="flex justify-between items-center text-xs"><span className="font-bold text-slate-400 flex items-center gap-1"><Clock size={12}/> ÂÖåÊèõÊúüÈôê</span><span className="font-black text-momo tracking-tight">{ticket.expiry || 'ÁÑ°ÊïàÊúüÈôêÂà∂'}</span></div>
                                <div className="pt-2 text-[10px] text-slate-400 leading-tight border-t border-slate-100 italic">‚óè Êú¨Âà∏ÈôêÂÖåÊèõ‰∏ÄÊ¨°ÔºåÁµêÂ∏≥ÂâçË´ãÂá∫Á§∫Ê≠§Áï´Èù¢„ÄÇ‰∏çÊé•ÂèóÊâãÊäÑÊàñÂè£Ë™™Â∫èËôü„ÄÇ</div>
                            </div>
                        </div>
                    </div>
                    <div className="px-4 py-2 bg-slate-50 border-t border-slate-100 shrink-0 flex justify-between items-center"><span className="text-[9px] font-bold text-slate-400">Copyright ¬© momo.com Inc.</span><div className="flex items-center gap-1 opacity-40"><img src="https://www.momoshop.com.tw/writeOff/resources/images/footerMOMO.png" className="h-4 w-auto" /></div></div>
                </div>
            );
        };

        const RedeemModal = ({ ticket, onClose, onToggleComplete, onDelete, onRestore, onUpdate, allTags, specificViewKeywords }) => {
            if (!ticket) return null;
            const [isEditing, setIsEditing] = useState(false);
            const [editName, setEditName] = useState(ticket.productName);
            const [editExpiry, setEditExpiry] = useState(ticket.expiry);
            const [editTags, setEditTags] = useState(ticket.tags || []);
            const [editImage, setEditImage] = useState(ticket.image || '');
            
            const isSpecificView = useMemo(() => {
                const keywords = (specificViewKeywords && specificViewKeywords.length > 0) ? specificViewKeywords : ['MOMO', '85Â∫¶C'];
                const searchTarget = (ticket.productName + (ticket.tags || []).join('')).toUpperCase();
                return keywords.some(kw => searchTarget.includes(kw.toUpperCase()));
            }, [ticket, specificViewKeywords]);

            const [viewMode, setViewMode] = useState(isSpecificView ? 'momo' : (ticket.image && !ticket.serial ? 'image' : 'standard'));
            const [showFullScreen, setShowFullScreen] = useState(false);

            const handleSave = () => {
                onUpdate({
                    ...ticket, productName: editName, expiry: editExpiry.replace(/-/g, '/'),
                    tags: editTags, image: editImage,
                    images: editImage ? (ticket.images && ticket.images.includes(editImage) ? ticket.images : [editImage, ...(ticket.images || [])]) : ticket.images
                });
                setIsEditing(false);
            };

            const hasImage = !!ticket.image;
            const isMomoMode = viewMode === 'momo';

            return (
                <>
                <div className="fixed inset-0 bg-slate-900/70 z-50 flex items-center justify-center p-3 sm:p-4 animate-fade-in backdrop-blur-md" onClick={onClose}>
                    <div className={`bg-white w-full max-w-sm rounded-[28px] overflow-hidden relative shadow-2xl flex flex-col border border-white/20 transition-all ${isMomoMode ? 'h-[85vh] sm:h-auto' : 'max-h-[90vh]'}`} onClick={e => e.stopPropagation()}>
                        <div className="p-4 sm:p-5 flex flex-col h-full">
                            <div className="text-center shrink-0">
                                {isEditing ? (
                                    <input className="text-lg font-black text-center w-full border-b border-sky-200 pb-2 mb-2 text-slate-800 focus:outline-none" value={editName} onChange={e=>setEditName(e.target.value)} />
                                ) : (
                                    !isMomoMode && <h3 className="text-base font-black text-slate-800 break-words leading-tight px-4 mb-2">{ticket.productName}</h3>
                                )}
                                {isEditing && (
                                    <div className="mt-2 text-left space-y-3 bg-slate-50 p-4 rounded-2xl">
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase">Â∞ÅÈù¢</label><div className="flex items-center gap-3 mt-1">{editImage ? <img src={editImage} className="w-12 h-12 object-cover rounded-lg border border-slate-200"/> : <div className="w-12 h-12 bg-white border border-dashed border-slate-300 rounded-lg flex items-center justify-center"><ImageIcon size={16} className="text-slate-300"/></div>}<label className="px-3 py-1 bg-sky-100 text-sky-600 text-[10px] font-bold rounded-md cursor-pointer">‰∏äÂÇ≥ <input type="file" accept="image/*" onChange={async e => {
                                                const file = e.target.files[0];
                                                if(file) { const base64 = await compressImage(file); setEditImage(base64); }
                                            }} className="hidden"/></label></div></div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest pl-1">ÂÖåÊèõÊúüÈôê</label>
                                            <input 
                                                type="date" 
                                                className="w-full p-3 bg-white border border-slate-200 rounded-xl outline-none text-sm font-bold text-slate-600" 
                                                value={editExpiry ? editExpiry.replace(/\//g, '-') : ''} 
                                                onChange={e => setEditExpiry(e.target.value)}
                                            />
                                        </div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase">Ê®ôÁ±§</label><TagSelectInput allTags={allTags} selectedTags={editTags} onTagsChange={setEditTags} extraSuggestions={specificViewKeywords} /></div>
                                    </div>
                                )}
                            </div>
                            {!isEditing && (
                                <div className="flex-1 flex flex-col min-h-0">
                                    {!isMomoMode && (
                                        <div className="flex justify-center shrink-0">
                                            <div className="flex bg-slate-100 p-1 rounded-xl mb-3">
                                                <button onClick={()=>setViewMode('standard')} className={`px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all ${viewMode === 'standard' ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400'}`}>Ê¢ùÁ¢º</button>
                                                {hasImage && <button onClick={()=>setViewMode('image')} className={`px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all ${viewMode === 'image' ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400'}`}>ÂéüÂúñ</button>}
                                                {isSpecificView && <button onClick={()=>setViewMode('momo')} className={`px-4 py-1.5 rounded-lg text-[10px] font-bold transition-all ${viewMode === 'momo' ? 'bg-momo text-white shadow-sm' : 'text-momo'}`}>Â∞àÂ±¨</button>}
                                            </div>
                                        </div>
                                    )}
                                    <div className="flex-1 min-h-0 relative">
                                        {viewMode === 'image' ? (
                                            <div className="h-full flex flex-col items-center gap-3 group relative">
                                                <button onClick={onClose} className="absolute top-2 right-2 z-10 w-8 h-8 bg-black/50 backdrop-blur-md text-white rounded-full flex items-center justify-center shadow-lg transition-transform active:scale-90">
                                                    <X size={18}/>
                                                </button>
                                                <div className="relative w-full flex-1 min-h-0 flex items-center justify-center cursor-zoom-in" onClick={() => setShowFullScreen(true)}>
                                                    <img src={ticket.image} className="max-h-full w-auto rounded-xl shadow-md border border-slate-100" />
                                                </div>
                                                {/* [CR-002] ÂéüÂúñÊ®°ÂºèÂø´Êç∑ÊåâÈàïÊ¨Ñ */}
                                                {!ticket.isDeleted && (
                                                    <div className="absolute bottom-4 left-0 right-0 px-6 flex gap-2 animate-slide-up">
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); if(window.confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§Á•®Âà∏Ôºü")) { onDelete(ticket.id, true); onClose(); } }} 
                                                            className="flex-1 py-3 bg-red-500/90 backdrop-blur-md text-white rounded-xl text-xs font-black shadow-lg flex items-center justify-center gap-1.5"
                                                        >
                                                            <Trash size={14}/> Âà™Èô§
                                                        </button>
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); if(window.confirm("Á¢∫ÂÆöÊ†∏Èä∑Ôºü")) { onToggleComplete(ticket); onClose(); } }} 
                                                            className="flex-[2] py-3 bg-emerald-500/90 backdrop-blur-md text-white rounded-xl text-xs font-black shadow-lg flex items-center justify-center gap-1.5"
                                                        >
                                                            <CheckCircle2 size={14}/> {ticket.completed ? 'ÊÅ¢Âæ©Êú™Áî®' : 'Âø´ÈÄüÊ†∏Èä∑'}
                                                        </button>
                                                    </div>
                                                )}
                                                {ticket.serial && (<div className="w-full space-y-2 shrink-0 pb-12"><div className="bg-white p-2 rounded-xl border border-slate-100"><BarcodeCanvas text={ticket.serial} /></div><div className="flex justify-center p-2 bg-white rounded-xl border border-slate-100 shrink-0"><QRCodeCanvas text={ticket.serial} size={100} /></div></div>)}
                                            </div>
                                        ) : isMomoMode ? (
                                            <div className="h-full py-1"><MomoTemplate ticket={ticket} /></div>
                                        ) : (
                                            <div className="h-full flex flex-col items-center justify-center gap-5 py-4">
                                                {ticket.serial && <div className="w-full bg-white p-3 rounded-xl border border-slate-100 shadow-sm"><BarcodeCanvas text={ticket.serial} /></div>}
                                                <div className="p-4 bg-white rounded-[32px] shadow-sm border border-slate-100">{ticket.serial ? <QRCodeCanvas text={ticket.serial} size={180} /> : <div className="w-40 h-40 flex items-center justify-center text-slate-200 border-2 border-dashed rounded-2xl font-bold">ÁÑ°Â∫èËôü</div>}</div>
                                                <div className="text-center"><span className="text-[11px] font-bold text-slate-400 block mb-1">ÈõªÂ≠êÂà∏Ëôü</span><span className="font-mono text-lg font-black text-slate-600 bg-slate-50 px-4 py-1 rounded-full">{ticket.serial || 'N/A'}</span></div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            <div className="mt-4 shrink-0 flex flex-col gap-2">
                                {isEditing ? (
                                    <div className="flex gap-2"><button onClick={()=>setIsEditing(false)} className="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold text-sm">ÂèñÊ∂à</button><button onClick={handleSave} className="flex-1 py-3 bg-sky-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-sky-100">ÂÑ≤Â≠òËÆäÊõ¥</button></div>
                                ) : (
                                    <>
                                        <div className="flex gap-2 mb-1">
                                            <button 
                                                onClick={() => { if(window.confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§Á•®Âà∏‰∏¶Ë¶ñÂêåÊ†∏Èä∑ÈÄöÁü•ÂóéÔºü")) { onDelete(ticket.id, true); onClose(); } }} 
                                                className="flex-1 py-4 text-sm font-black rounded-2xl shadow-xl flex items-center justify-center gap-2 text-white bg-red-500 hover:bg-red-600 transition-all active:scale-95"
                                            >
                                                <Trash2 size={18}/> Âà™Èô§
                                            </button>
                                            
                                            {!ticket.isDeleted && (
                                                <button 
                                                    onClick={() => { if(ticket.completed || window.confirm("Á¢∫ÂÆöÊ†∏Èä∑Ôºü")) { onToggleComplete(ticket); onClose(); } }} 
                                                    className="flex-[2] py-4 text-sm font-black rounded-2xl shadow-xl flex items-center justify-center gap-2 text-white bg-emerald-500 hover:bg-emerald-600 transition-all active:scale-95"
                                                >
                                                    {ticket.completed ? <><RotateCcw size={18}/> Ê®ôË®òÊú™Áî®</> : <><CheckCircle2 size={18}/> Á´ãÂç≥Ê†∏Èä∑</>}
                                                </button>
                                            )}
                                        </div>
                                        
                                        <div className="flex gap-2 h-11">
                                            {ticket.isDeleted ? (
                                                <button onClick={() => { onRestore(ticket); onClose(); }} className="flex-1 bg-emerald-50 text-emerald-600 text-xs font-bold rounded-xl flex items-center justify-center gap-1.5"><RefreshCcw size={14}/> ÈÇÑÂéü</button> 
                                            ) : (
                                                <button onClick={() => setIsEditing(true)} className="flex-1 bg-slate-50 text-slate-500 text-xs font-bold rounded-xl flex items-center justify-center gap-1.5 border border-slate-100"><Pencil size={14}/> Á∑®ËºØ</button>
                                            )}
                                            <button onClick={onClose} className="flex-1 bg-slate-100 text-slate-500 font-bold rounded-xl flex items-center justify-center text-xs hover:bg-slate-200 transition-colors">ÈóúÈñâ</button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
                {showFullScreen && ticket.image && (
                    <div className="fixed inset-0 z-[60] bg-black flex items-center justify-center p-2 fullscreen-overlay" onClick={() => setShowFullScreen(false)}>
                        <img src={ticket.image} className="max-w-full max-h-full object-contain" />
                        <button className="absolute top-6 right-6 px-4 py-2 bg-black/60 backdrop-blur-md text-white rounded-full flex items-center gap-2 font-bold shadow-lg border border-white/20 active:scale-95 transition-transform" onClick={(e) => { e.stopPropagation(); setShowFullScreen(false); }}>
                            <X size={20}/> ÈóúÈñâ
                        </button>
                    </div>
                )}
                </>
            );
        };

        const AddTicketModal = ({ isOpen, onClose, onAddBatch, allTags, specificViewKeywords }) => {
            if (!isOpen) return null;
            const [activeTab, setActiveTab] = useState('smart');
            const [pasteVal, setPasteVal] = useState('');
            const [loading, setLoading] = useState(false);
            const [manualData, setManualData] = useState({ name: '', serial: '', expiry: '', note: '' });
            const [manualTags, setManualTags] = useState([]);
            const [images, setImages] = useState([]);

            const handleSmartSubmit = async () => {
                if (!pasteVal.trim()) return;
                setLoading(true);
                try {
                    const results = parseBatchTicketInfo(pasteVal);
                    if (results.length === 0) alert("Êú™ËÉΩËß£ÊûêÂá∫Á•®Âà∏„ÄÇ");
                    else { onAddBatch(results); onClose(); }
                } catch (e) { alert("ËôïÁêÜÂ§±Êïó"); } finally { setLoading(false); }
            };

            const handleManualSubmit = () => {
                if (!manualData.name) { alert("Ë´ãËº∏ÂÖ•ÂêçÁ®±"); return; }
                onAddBatch([{ id: Date.now(), productName: manualData.name, serial: manualData.serial, expiry: manualData.expiry.replace(/-/g, '/'), note: manualData.note, images: images, image: images[0] || '', tags: manualTags, completed: false, isDeleted: false, createdAt: Date.now() }]);
                onClose();
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    try { const base64 = await compressImage(file); setImages([base64]); } catch(err) { alert("ËôïÁêÜÂúñÁâáÊôÇÁôºÁîüÈåØË™§Ôºö" + err.message); }
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-end sm:items-center justify-center animate-fade-in backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full sm:w-[450px] sm:rounded-3xl rounded-t-[32px] p-6 shadow-2xl max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-black text-slate-800">Êñ∞Â¢ûÁ•®Âà∏</h2><button onClick={onClose} className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200"><X size={18}/></button></div>
                        <div className="flex bg-slate-100 p-1.5 rounded-2xl mb-6">
                            <button onClick={()=>setActiveTab('smart')} className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all ${activeTab==='smart' ? 'bg-white shadow text-sky-600' : 'text-slate-400'}`}>Êô∫ÊÖßË≤º‰∏ä</button>
                            <button onClick={()=>setActiveTab('manual')} className={`flex-1 py-2.5 rounded-xl text-sm font-bold transition-all ${activeTab==='manual' ? 'bg-white shadow text-sky-600' : 'text-slate-400'}`}>ÊâãÂãïËº∏ÂÖ•</button>
                        </div>
                        {activeTab === 'smart' ? (
                            <div className="space-y-4">
                                <textarea className="w-full h-40 p-4 bg-slate-50 rounded-2xl outline-none resize-none text-sm font-medium" placeholder="Ë≤º‰∏äÁ∞°Ë®ä/Email..." value={pasteVal} onChange={e=>setPasteVal(e.target.value)}></textarea>
                                <button onClick={handleSmartSubmit} disabled={loading} className="w-full bg-sky-500 text-white py-3.5 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2">{loading ? <Loader2 className="animate-spin"/> : <Wand2 size={18}/>} Á´ãÂç≥Ëß£Êûê</button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                <div className="flex items-center gap-3"><div className="w-20 h-20 bg-slate-50 border border-dashed border-slate-300 rounded-2xl flex items-center justify-center relative overflow-hidden">{images.length > 0 ? <img src={images[0]} className="w-full h-full object-cover"/> : <ImageIcon className="text-slate-300"/>}<input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onChange={handleImageUpload}/></div><div className="flex-1 text-xs font-bold text-slate-400">‰∏äÂÇ≥Á•®Âà∏ÁÖßÁâá (ÈÅ∏Â°´)</div></div>
                                <input className="w-full p-3.5 bg-slate-50 rounded-xl outline-none font-bold" placeholder="Á•®Âà∏ÂêçÁ®± (ÂøÖÂ°´)" value={manualData.name} onChange={e=>setManualData({...manualData, name: e.target.value})}/>
                                <TagSelectInput allTags={allTags} selectedTags={manualTags} onTagsChange={setManualTags} extraSuggestions={specificViewKeywords} />
                                <input className="w-full p-3.5 bg-slate-50 rounded-xl outline-none font-mono text-sm" placeholder="Â∫èËôü/‰ª£Á¢º" value={manualData.serial} onChange={e=>setManualData({...manualData, serial: e.target.value})}/>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest pl-1">ÂÖåÊèõÊúüÈôê</label>
                                    <input type="date" className="w-full p-3.5 bg-slate-50 rounded-xl outline-none text-sm font-bold text-slate-600" value={manualData.expiry} onChange={e=>setManualData({...manualData, expiry: e.target.value})}/>
                                </div>
                                <button onClick={handleManualSubmit} className="w-full bg-sky-500 text-white py-3.5 rounded-2xl font-bold shadow-lg">Á¢∫Ë™çÊñ∞Â¢û</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const TagManagerModal = ({ isOpen, onClose, tags, onDeleteTag }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl p-6 max-h-[60vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                        <h2 className="text-xl font-black mb-4 text-slate-800">ÁÆ°ÁêÜÊ®ôÁ±§</h2>
                        {tags.length === 0 ? <p className="text-slate-400 text-center py-8 font-bold">ÁõÆÂâçÊ≤íÊúâÊ®ôÁ±§</p> : (
                            <div className="space-y-2">
                                {tags.map(tag => (
                                    <div key={tag} className="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                                        <span className="font-bold text-slate-600 text-sm">#{tag}</span>
                                        <button onClick={() => onDeleteTag(tag)} className="text-red-400 hover:text-red-600 p-2 bg-white rounded-lg shadow-sm"><Trash2 size={16}/></button>
                                    </div>
                                ))}
                            </div>
                        )}
                        <button onClick={onClose} className="w-full mt-6 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-slate-200 transition-colors">ÈóúÈñâ</button>
                    </div>
                </div>
            );
        };
        
        const BatchEditModal = ({ isOpen, onClose, selectedCount, onAddTag, allTags }) => {
             const [tagsToAdd, setTagsToAdd] = useState([]);
             if(!isOpen) return null;
             const handleConfirm = () => { onAddTag(tagsToAdd); onClose(); };
             return (
                <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-end sm:items-center justify-center animate-fade-in" onClick={onClose}>
                     <div className="bg-white w-full sm:w-[400px] sm:rounded-3xl rounded-t-[32px] p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                        <h2 className="text-xl font-black mb-1 text-slate-800">ÊâπÈáèÁ∑®ËºØ</h2>
                        <p className="text-xs font-bold text-slate-400 mb-4">Â∑≤ÈÅ∏Âèñ {selectedCount} ÂºµÁ•®Âà∏</p>
                        <div className="space-y-4">
                            <div><label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Êñ∞Â¢ûÊ®ôÁ±§</label><TagSelectInput allTags={allTags} selectedTags={tagsToAdd} onTagsChange={setTagsToAdd} /></div>
                        </div>
                        <div className="flex gap-3 mt-6"><button onClick={onClose} className="flex-1 py-3 bg-slate-100 font-bold rounded-2xl text-slate-500">ÂèñÊ∂à</button><button onClick={handleConfirm} className="flex-1 py-3 bg-sky-500 font-bold rounded-2xl text-white shadow-lg shadow-sky-200 hover:bg-sky-600 transition-colors">Á¢∫Ë™çÂÑ≤Â≠ò</button></div>
                     </div>
                </div>
             );
        };

        // --- Main App ---
        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [view, setView] = useState('active');
            const [activeTag, setActiveTag] = useState('all');
            const [sortType, setSortType] = useState('expiring');
            const [searchQuery, setSearchQuery] = useState('');
            const [showAddModal, setShowAddModal] = useState(false);
            const [selectedTicket, setSelectedTicket] = useState(null);
            const [isCompact, setIsCompact] = useState(false);
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());
            const [showBatchModal, setShowBatchModal] = useState(false);
            
            const [showDataModal, setShowDataModal] = useState(false);
            const [importPendingData, setImportPendingData] = useState(null);

            const [settings, setSettings] = useState({ 
                tgToken: '', tgChatId: '', notifyDays: 7, appTitle: 'ÊàëÁöÑÁ•®Â§æ',
                specificViewKeywords: ['MOMO', '85Â∫¶C'], 
                bgConfigMap: {}, 
                viewConfigs: {
                    active: { ...defaultViewConfig },
                    completed: { ...defaultViewConfig },
                    deleted: { ...defaultViewConfig }
                }
            });
            const [bgHistory, setBgHistory] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [showTagManager, setShowTagManager] = useState(false);
            const [isDataLoaded, setIsDataLoaded] = useState(false);

            const migrateConfig = (config) => ({
                ...defaultViewConfig, ...config,
                bgSize: typeof config?.bgSize === 'number' ? config.bgSize : 100,
                bgPosY: typeof config?.bgPosY === 'number' ? config.bgPosY : 50,
                bgOpacity: typeof config?.bgOpacity === 'number' ? config.bgOpacity : 1 
            });

            useEffect(() => {
                const initData = async () => {
                    try {
                        await dbHelper.init();
                        const keys = ['wallet_tasks_v3', 'wallet_settings_v3', 'wallet_bg_history_v3'];
                        for (const key of keys) {
                            const localData = localStorage.getItem(key);
                            if (localData) {
                                const parsed = JSON.parse(localData);
                                await dbHelper.setItem(key, parsed);
                                localStorage.removeItem(key); 
                            }
                        }
                        const dbTasks = await dbHelper.getItem('wallet_tasks_v3');
                        const dbSettings = await dbHelper.getItem('wallet_settings_v3');
                        const dbBgHistory = await dbHelper.getItem('wallet_bg_history_v3');

                        if (dbTasks) setTasks(dbTasks);
                        if (dbSettings) {
                            const mergedSettings = {
                                ...settings, ...dbSettings,
                                bgConfigMap: dbSettings.bgConfigMap || {}, 
                                specificViewKeywords: dbSettings.specificViewKeywords || ['MOMO', '85Â∫¶C'], 
                                viewConfigs: {
                                    active: migrateConfig(dbSettings.viewConfigs?.active),
                                    completed: migrateConfig(dbSettings.viewConfigs?.completed),
                                    deleted: migrateConfig(dbSettings.viewConfigs?.deleted),
                                }
                            };
                            setSettings(mergedSettings);
                        }
                        if (dbBgHistory) setBgHistory(dbBgHistory);
                        setIsDataLoaded(true);
                    } catch (err) { console.error("Database initialization failed:", err); }
                };
                initData();
            }, []);

            useEffect(() => { if (isDataLoaded) dbHelper.setItem('wallet_tasks_v3', tasks); }, [tasks, isDataLoaded]);
            useEffect(() => { if (isDataLoaded) dbHelper.setItem('wallet_settings_v3', settings); }, [settings, isDataLoaded]);
            useEffect(() => { if (isDataLoaded) dbHelper.setItem('wallet_bg_history_v3', bgHistory); }, [bgHistory, isDataLoaded]);

            useEffect(() => {
                const checkNotifications = async () => {
                    if (isDataLoaded && settings.tgToken && settings.tgChatId && tasks.length > 0) {
                        const todayStr = new Date().toISOString().split('T')[0];
                        const lastCheckKey = 'last_notify_date_v3';
                        if (localStorage.getItem(lastCheckKey) !== todayStr) {
                            const expiring = tasks.filter(t => !t.completed && !t.isDeleted && checkIsExpiringSoon(t.expiry, settings.notifyDays));
                            if (expiring.length > 0) {
                                let msg = `‚ö†Ô∏è *[${settings.appTitle}] Âà∞ÊúüÊèêÈÜí (${expiring.length}Á≠Ü)*\n\n`;
                                expiring.slice(0, 10).forEach(t => msg += `üî∏ ${t.productName} (${t.expiry || 'ÁÑ°'})\n`);
                                const result = await sendTelegramMessage(settings.tgToken, settings.tgChatId, msg);
                                if(result.success) localStorage.setItem(lastCheckKey, todayStr);
                            }
                        }
                    }
                };
                checkNotifications();
            }, [tasks, settings, isDataLoaded]);

            const allTags = useMemo(() => [...new Set(tasks.flatMap(t => t.tags || []))], [tasks]);
            const duplicateSerials = useMemo(() => {
                const counts = {};
                tasks.forEach(t => { if (!t.isDeleted && t.serial) counts[t.serial] = (counts[t.serial] || 0) + 1; });
                return new Set(Object.keys(counts).filter(s => counts[s] > 1));
            }, [tasks]);

            const filteredTasks = useMemo(() => {
                let result = tasks.filter(t => {
                    if (view === 'active' && (t.completed || t.isDeleted)) return false;
                    if (view === 'completed' && (!t.completed || t.isDeleted)) return false;
                    if (view === 'deleted' && !t.isDeleted) return false;
                    if (activeTag === 'special_expiring') return checkIsExpiringSoon(t.expiry, settings.notifyDays) && !t.completed && !t.isDeleted;
                    if (activeTag === 'special_duplicate') return duplicateSerials.has(t.serial) && !t.completed && !t.isDeleted;
                    if (activeTag !== 'all' && (!t.tags || !t.tags.includes(activeTag))) return false;
                    if (searchQuery) {
                        const q = searchQuery.toLowerCase();
                        return t.productName.toLowerCase().includes(q) || (t.note && t.note.toLowerCase().includes(q)) || (t.tags && t.tags.some(tag => tag.toLowerCase().includes(q)));
                    }
                    return true;
                });
                result.sort((a, b) => {
                    const isExpiringA = !a.completed && !a.isDeleted && checkIsExpiringSoon(a.expiry, settings.notifyDays);
                    const isExpiringB = !b.completed && !b.isDeleted && checkIsExpiringSoon(b.expiry, settings.notifyDays);
                    if (isExpiringA !== isExpiringB) return isExpiringA ? -1 : 1;
                    const isDupA = duplicateSerials.has(a.serial) && !a.completed && !a.isDeleted;
                    const isDupB = duplicateSerials.has(b.serial) && !b.completed && !b.isDeleted;
                    if (isDupA !== isDupB) return isDupA ? -1 : 1;

                    // [CR-003] ÊéíÂ∫èÈÇèËºØË™øÊï¥ÔºöÂ∑≤Áî®ÂçÄËàáÂõûÊî∂ÂçÄÈ†êË®≠‰æùÈÄ≤ÂÖ•Ë©≤ÂçÄÁöÑÊôÇÈñìÊéíÂ∫è
                    if (sortType === 'newest') {
                        if (view === 'completed') return (b.completedAt || 0) - (a.completedAt || 0);
                        if (view === 'deleted') return (b.deletedAt || 0) - (a.deletedAt || 0);
                        return b.createdAt - a.createdAt;
                    }
                    if (sortType === 'oldest') {
                        if (view === 'completed') return (a.completedAt || 0) - (b.completedAt || 0);
                        if (view === 'deleted') return (a.deletedAt || 0) - (b.deletedAt || 0);
                        return a.createdAt - b.createdAt;
                    }

                    if (sortType === 'expiring') {
                        const dateA = a.expiry ? new Date(a.expiry.replace(/\//g, '-')) : new Date(9999, 11, 31);
                        const dateB = b.expiry ? new Date(b.expiry.replace(/\//g, '-')) : new Date(9999, 11, 31);
                        return dateA - dateB;
                    } 
                    return 0;
                });
                return result;
            }, [tasks, view, activeTag, searchQuery, sortType, duplicateSerials, settings.notifyDays]);

            const handleAddBatch = (newItems) => setTasks(prev => [...newItems, ...prev]);
            const handleUpdate = (updatedTicket) => setTasks(prev => prev.map(t => t.id === updatedTicket.id ? updatedTicket : t));
            
            const handleToggleComplete = async (ticket) => {
                const newStatus = !ticket.completed;
                const completedAt = newStatus ? Date.now() : null; 
                setTasks(prev => prev.map(t => t.id === ticket.id ? { ...t, completed: newStatus, completedAt: completedAt } : t));
                if (newStatus && settings.tgToken && settings.tgChatId) {
                   const msg = `‚úÖ *[Â∑≤Ê†∏Èä∑]* ${ticket.productName}\nüî¢ Â∫èËôü: ${ticket.serial || 'ÁÑ°'}\n‚è∞ ÊôÇÈñì: ${formatDateTime(completedAt)}`;
                   sendTelegramMessage(settings.tgToken, settings.tgChatId, msg).catch(e => console.error(e));
                }
            };

            const handleDelete = (id, forceNotify = false) => {
                const now = Date.now();
                if (forceNotify && settings.tgToken && settings.tgChatId) {
                    const target = tasks.find(t => t.id === id);
                    if (target) {
                        // [CR-001] Âà™Èô§ÈÄöÁü•ÂåÖÂê´ÊñπÊ°àËàáÂ∫èËôüË≥áË®ä
                        const msg = `üóëÔ∏è *[Â∑≤Âà™Èô§ (Ë¶ñÂêåÊ†∏Èä∑)]*\nÊñπÊ°à: ${target.productName}\nÂ∫èËôü: \`${target.serial || 'ÁÑ°'}\`\nÊôÇÈñì: ${formatDateTime(now)}`;
                        sendTelegramMessage(settings.tgToken, settings.tgChatId, msg).catch(e => console.error(e));
                    }
                }
                if(view === 'deleted') { if(confirm("Á¢∫ÂÆöÊ∞∏‰πÖÂà™Èô§Ôºü")) setTasks(prev => prev.filter(t => t.id !== id)); }
                else {
                    // [CR-003] Ê®ôË®òÂà™Èô§‰∏¶Â≠òÂÖ• deletedAt
                    setTasks(prev => prev.map(t => id === t.id ? { ...t, isDeleted: true, deletedAt: now } : t));
                }
            };

            const handleRestore = (ticket) => setTasks(prev => prev.map(t => t.id === ticket.id ? { ...t, isDeleted: false, deletedAt: null } : t));
            const handleDeleteTag = (tag) => setTasks(prev => prev.map(t => ({ ...t, tags: (t.tags||[]).filter(tt => tt !== tag) })));
            
            const handleBackup = () => {
                const backupData = { version: 3, timestamp: Date.now(), settings: settings, tasks: tasks };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: "application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ticket_backup_idb_${new Date().toISOString().split('T')[0]}.json`; a.click();
            };
            
            const handleImportClick = () => {
                const input = document.createElement('input'); input.type = 'file';
                input.onchange = e => {
                    const r = new FileReader(); 
                    r.onload = ev => { try { setImportPendingData(JSON.parse(ev.target.result)); setShowDataModal(false); } catch(e){alert("Ê†ºÂºèÈåØË™§");} };
                    r.readAsText(e.target.files[0]);
                }; input.click();
            };

            const executeImport = (mode, restoreSettings) => {
                if (!importPendingData) return;
                const importedTasks = Array.isArray(importPendingData) ? importPendingData : (importPendingData.tasks || []);
                
                if (restoreSettings && importPendingData.settings) {
                    const impSet = importPendingData.settings;
                    setSettings(prev => ({
                        ...prev, ...impSet,
                        specificViewKeywords: impSet.specificViewKeywords || ['MOMO', '85Â∫¶C'],
                        viewConfigs: {
                            active: migrateConfig(impSet.viewConfigs?.active),
                            completed: migrateConfig(impSet.viewConfigs?.completed),
                            deleted: migrateConfig(impSet.viewConfigs?.deleted),
                        }
                    }));
                }
                
                if (mode === 'append') setTasks(prev => [...prev, ...importedTasks]);
                else setTasks(importedTasks);
                setImportPendingData(null);
                alert(`ÂåØÂÖ•ÊàêÂäüÔºÅÂÖ± ${importedTasks.length} Á≠ÜÁ•®Âà∏„ÄÇ`);
            };

            const handleFullReset = async () => {
                if (window.confirm("‚ö†Ô∏è Ê≥®ÊÑèÔºöÈÄôÂ∞áÂà™Èô§ÊâÄÊúâÁ•®Âà∏„ÄÅË®≠ÂÆöËàáËÉåÊôØÁ¥ÄÈåÑÔºå‰∏îÁÑ°Ê≥ïÂæ©Âéü„ÄÇÁ¢∫ÂÆöË¶ÅÂæπÂ∫ïÈáçË®≠ÂóéÔºü")) {
                    if (window.confirm("üî¥ ÂÜçÊ¨°Á¢∫Ë™çÔºöÂà™Èô§ÂæåË≥áÊñôÂ∞áÁÑ°Ê≥ïÊâæÂõû„ÄÇÁúüÁöÑË¶ÅÂü∑Ë°åÂóéÔºü")) {
                        await dbHelper.removeItem('wallet_tasks_v3');
                        await dbHelper.removeItem('wallet_settings_v3');
                        await dbHelper.removeItem('wallet_bg_history_v3');
                        localStorage.removeItem('last_notify_date_v3');
                        window.location.reload();
                    }
                }
            };
            
            const handleSelect = (id) => { const s = new Set(selectedIds); if(s.has(id)) s.delete(id); else s.add(id); setSelectedIds(s); };
            const handleSelectAll = () => setSelectedIds(selectedIds.size === filteredTasks.length ? new Set() : new Set(filteredTasks.map(t => t.id)));
            const handleBatchAddTag = (tagsToAdd) => { setTasks(prev => prev.map(t => selectedIds.has(t.id) ? { ...t, tags: Array.from(new Set([...(t.tags || []), ...tagsToAdd])) } : t)); setSelectedIds(new Set()); setIsSelectionMode(false); };
            const handleSaveSettings = (newSettings) => {
                setSettings(newSettings);
                const imagesToAdd = [newSettings.viewConfigs.active.backgroundImage, newSettings.viewConfigs.completed.backgroundImage, newSettings.viewConfigs.deleted.backgroundImage].filter(Boolean);
                if (imagesToAdd.length > 0) setBgHistory(prev => [...new Set([...imagesToAdd, ...prev])].slice(0, 20));
            };
            const handleRemoveHistory = (url) => { if(confirm("Á¢∫ÂÆöË¶ÅÁßªÈô§Ê≠§ËÉåÊôØÁ¥ÄÈåÑÂóéÔºü")) setBgHistory(prev => prev.filter(item => item !== url)); };
            const handleAddToHistory = (newBg) => { if (newBg) setBgHistory(prev => [newBg, ...prev.filter(bg => bg !== newBg)].slice(0, 20)); };
            const handleQuickBgChange = () => {
                const history = [''].concat(bgHistory);
                const currentBg = settings.viewConfigs[view].backgroundImage || '';
                const nextBg = history[(history.indexOf(currentBg) + 1) % history.length] || '';
                setSettings(prev => {
                    let next = { ...prev };
                    let currentView = { ...next.viewConfigs[view], backgroundImage: nextBg };
                    const sharedConfig = next.bgConfigMap?.[nextBg];
                    if (sharedConfig) { currentView.bgSize = sharedConfig.bgSize; currentView.bgPosY = sharedConfig.bgPosY; }
                    next.viewConfigs = { ...next.viewConfigs, [view]: currentView };
                    return next;
                });
            };

            if (!isDataLoaded) return <div className="fixed inset-0 bg-slate-50 flex flex-col items-center justify-center gap-4"><Loader2 className="w-12 h-12 text-sky-500 animate-spin" /><p className="text-slate-400 font-bold animate-pulse">Ê≠£Âú®ËºâÂÖ•Ë≥áÊñôÂ∫´...</p></div>;
            const currentConfig = settings.viewConfigs[view] || defaultViewConfig;

            return (
                <>
                    {currentConfig.backgroundImage && <div className="fixed inset-0 z-0 mx-auto max-w-md transition-all duration-500" style={{ top: '150px', backgroundImage: `url(${currentConfig.backgroundImage})`, backgroundSize: `${currentConfig.bgSize || 100}% auto`, backgroundPosition: `center ${currentConfig.bgPosY || 50}%`, backgroundRepeat: 'no-repeat', opacity: currentConfig.bgOpacity || 1 }} />}
                    
                    <div className="max-w-md mx-auto min-h-screen relative shadow-2xl sm:border-x border-slate-200 transition-all duration-500 z-10" style={{ backgroundColor: currentConfig.backgroundImage ? 'transparent' : '#f8fafc' }}>
                        <Header 
                            appTitle={settings.appTitle} onTitleChange={(t) => setSettings(s => ({...s, appTitle: t}))}
                            onOpenSettings={() => setShowSettings(true)}
                            onOpenMenu={() => setShowDataModal(true)}
                            sortType={sortType} setSortType={setSortType} searchQuery={searchQuery} setSearchQuery={setSearchQuery} isSelectionMode={isSelectionMode} setIsSelectionMode={setIsSelectionMode} selectedCount={selectedIds.size} onSelectAll={handleSelectAll} isCompact={isCompact} setIsCompact={setIsCompact} view={view} setView={setView} activeTag={activeTag} setActiveTag={setActiveTag} allTags={allTags} onQuickBgChange={handleQuickBgChange} headerBackgroundImage={currentConfig.headerBackgroundImage}
                        />
                        <div className="pt-2 min-h-[50vh] transition-colors">{filteredTasks.length > 0 ? filteredTasks.map(t => <TicketCard key={t.id} ticket={t} onClick={setSelectedTicket} notifyDays={settings.notifyDays} isSelectionMode={isSelectionMode} isSelected={selectedIds.has(t.id)} onSelect={handleSelect} isDuplicate={duplicateSerials.has(t.serial)} opacity={currentConfig.cardOpacity} cardBgColor={currentConfig.cardBgColor} cardBorderColor={currentConfig.cardBorderColor} isCompact={isCompact} compactHeight={currentConfig.compactHeight} compactShowImage={currentConfig.compactShowImage} />) : <div className="text-center py-24 text-slate-300"><i className="fas fa-ticket-alt text-5xl mb-4 opacity-30"></i><p className="font-bold">Êö´ÁÑ°Á•®Âà∏</p></div>}</div>
                        
                        {isSelectionMode ? (
                            <div className="fixed bottom-10 left-1/2 -translate-x-1/2 flex gap-3 z-40 animate-slide-up">
                                {selectedIds.size > 0 && <><button onClick={() => setShowBatchModal(true)} className="bg-sky-500 hover:bg-sky-600 text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-sky-200 flex items-center gap-2"><Tag size={18}/> ÊâπÈáèÊ®ôÁ±§</button><button onClick={() => { if(confirm(`Á¢∫ÂÆöÂà™Èô§ ${selectedIds.size} È†ÖÁõÆÔºü`)) { if(view === 'deleted') setTasks(prev => prev.filter(t => !selectedIds.has(t.id))); else { const now = Date.now(); setTasks(prev => prev.map(t => selectedIds.has(t.id) ? { ...t, isDeleted: true, deletedAt: now } : t)); } setSelectedIds(new Set()); setIsSelectionMode(false); } }} className="bg-white text-red-500 border border-red-100 px-4 py-3 rounded-2xl font-bold shadow-lg flex items-center gap-2 hover:bg-red-50"><Trash2 size={18}/></button></>}
                                <button onClick={() => {setIsSelectionMode(false); setSelectedIds(new Set());}} className="bg-slate-800 text-white px-4 py-3 rounded-2xl font-bold shadow-lg">ÂèñÊ∂à</button>
                            </div>
                        ) : <button onClick={() => setShowAddModal(true)} className="fixed bottom-10 right-5 w-16 h-16 bg-sky-500 text-white rounded-[24px] shadow-2xl flex items-center justify-center text-3xl active:scale-90 transition-transform z-40"><Plus size={32}/></button>}

                        <AddTicketModal isOpen={showAddModal} onClose={() => setShowAddModal(false)} onAddBatch={handleAddBatch} allTags={allTags} specificViewKeywords={settings.specificViewKeywords} />
                        <RedeemModal ticket={selectedTicket} onClose={() => setSelectedTicket(null)} onToggleComplete={handleToggleComplete} onDelete={handleDelete} onRestore={handleRestore} onUpdate={handleUpdate} allTags={allTags} specificViewKeywords={settings.specificViewKeywords} />
                        <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} settings={settings} bgHistory={bgHistory} onSave={handleSaveSettings} onRemoveHistory={handleRemoveHistory} onAddToHistory={handleAddToHistory} />
                        <TagManagerModal isOpen={showTagManager} onClose={() => setShowTagManager(false)} tags={allTags} onDeleteTag={handleDeleteTag} />
                        <BatchEditModal isOpen={showBatchModal} onClose={() => setShowBatchModal(false)} selectedCount={selectedIds.size} onAddTag={handleBatchAddTag} allTags={allTags} />
                        
                        <DataActionsModal isOpen={showDataModal} onClose={() => setShowDataModal(false)} onBackup={handleBackup} onImportClick={handleImportClick} onReset={handleFullReset} />
                        <ImportConfirmModal isOpen={!!importPendingData} data={importPendingData} onCancel={() => setImportPendingData(null)} onConfirm={executeImport} />
                    </div>
                </>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

